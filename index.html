<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioGestão - Gerenciador de Pacientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; color: #D1D5DB; }
        .sidebar-link:hover { background-color: #374151; }
        .sidebar-link.active { background-color: #4B5563; color: #FFFFFF; font-weight: 600; }
        .sidebar-link svg { margin-right: 0.75rem; width: 1.25rem; height: 1.25rem; }
        .tab-button { transition: background-color 0.2s, color 0.2s; }
        .tab-button.active { background-color: #3B82F6; color: white; }
        .tab-button:not(.active) { background-color: #E5E7EB; color: #4B5563; }
        .tab-content { border-top: 1px solid #D1D5DB; }
        .detail-label { font-weight: 600; color: #4B5563; }
        .detail-value { min-height: 1.5rem; }
        .calendar-day { min-height: 120px; }
        .appointment-badge, .appointment-item { /* Added .appointment-item */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer; /* Make it look clickable */
        }
        /* Style for datalist */
        input::-webkit-calendar-picker-indicator {
            display: none !important; /* Hide ugly dropdown arrow for datalist inputs */
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto; /* Center the spinner */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
             position: fixed;
             inset: 0;
             background-color: rgba(255, 255, 255, 0.7);
             display: flex;
             align-items: center;
             justify-content: center;
             z-index: 9999; /* Ensure it's on top */
         }
         /* Classe para esconder páginas */
         .page-content {
            display: none; /* Escondido por padrão */
         }
         .page-content.active {
            display: block; /* Visível quando ativo */
         }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
     <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loader"></div>
    </div>


    <div id="app">
        <!-- ÁREA DE AUTENTICAÇÃO -->
        <div id="auth-view" class="h-screen flex items-center justify-center p-4">
            <!-- TELA DE LOGIN -->
            <div id="login-container" class="max-w-md w-full mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-blue-600">FisioGestão</h1>
                        <p class="text-gray-500">Acesse sua conta para continuar.</p>
                    </div>
                    <form id="login-form">
                        <div class="space-y-4">
                            <input id="login-email" type="email" placeholder="Seu e-mail" class="w-full p-3 border rounded-lg" required>
                            <input id="login-password" type="password" placeholder="Sua senha" class="w-full p-3 border rounded-lg" required>
                        </div>
                        <p id="login-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 mt-6">
                            Entrar
                        </button>
                    </form>
                </div>
                <p class="text-center mt-6 text-gray-600">Não tem uma conta? <a href="#" id="show-register-btn" class="font-semibold text-blue-600 hover:underline">Cadastre sua Clínica</a></p>
            </div>

            <!-- TELA DE CADASTRO DE CLÍNICA -->
            <div id="register-container" class="max-w-2xl w-full mx-auto hidden">
                 <div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="text-center mb-6">
                        <h1 class="text-3xl font-bold text-blue-600">Cadastre sua Clínica</h1>
                        <p class="text-gray-500">Crie a conta principal da sua clínica.</p>
                    </div>
                    <form id="register-form">
                        <div class="space-y-4">
                             <div class="flex justify-center gap-6 mb-4">
                                <label class="flex items-center"><input type="radio" name="accountType" value="pf" checked class="mr-2"> Pessoa Física</label>
                                <label class="flex items-center"><input type="radio" name="accountType" value="pj" class="mr-2"> Pessoa Jurídica</label>
                            </div>

                            <!-- Campos Pessoa Física -->
                            <div id="pf-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2"><input id="pf-name" type="text" placeholder="Nome Completo" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pf-birthDate" type="text" onfocus="(this.type='date')" onblur="(this.type='text')" placeholder="Data de Nascimento" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pf-rg" type="text" placeholder="RG" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pf-cpf" type="text" placeholder="CPF" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pf-crefito" type="text" placeholder="CREFITO" class="w-full p-2 border rounded-lg"></div>
                                
                                <!-- Endereço PF -->
                                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                                    <div class="md:col-span-2"><input id="pf-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="pf"></div>
                                    <div class="md:col-span-4"><input id="pf-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-2"><input id="pf-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-4"><input id="pf-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pf-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pf-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                                </div>
                                
                                <div class="md:col-span-2"><input id="pf-phone" type="tel" placeholder="Telefone" class="w-full p-2 border rounded-lg"></div>
                            </div>

                             <!-- Campos Pessoa Jurídica -->
                            <div id="pj-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2"><input id="pj-razaoSocial" type="text" placeholder="Razão Social" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pj-cnpj" type="text" placeholder="CNPJ" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pj-crefito" type="text" placeholder="CREFITO da Clínica" class="w-full p-2 border rounded-lg"></div>
                                
                                <!-- Endereço PJ -->
                                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                                    <div class="md:col-span-2"><input id="pj-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="pj"></div>
                                    <div class="md:col-span-4"><input id="pj-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-2"><input id="pj-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-4"><input id="pj-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pj-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pj-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                                </div>

                                <div class="md:col-span-2"><input id="pj-phone" type="tel" placeholder="Telefone Comercial" class="w-full p-2 border rounded-lg"></div>
                                <hr class="md:col-span-2 my-2"/>
                                <div class="md:col-span-2"><p class="text-sm font-semibold text-gray-600">Dados do Responsável Técnico</p></div>
                                <div class="md:col-span-2"><input id="pj-responsavel" type="text" placeholder="Nome do Responsável" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pj-responsavel-cpf" type="text" placeholder="CPF do Responsável" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pj-responsavel-crefito" type="text" placeholder="CREFITO do Responsável" class="w-full p-2 border rounded-lg"></div>
                            </div>

                            <hr class="my-2"/>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2"><p class="text-sm font-semibold text-gray-600">Dados de Acesso</p></div>
                                <div class="md:col-span-2"><input id="register-email" type="email" placeholder="Seu e-mail (será o login)" class="w-full p-2 border rounded-lg" required></div>
                                <div class="md:col-span-2"><input id="register-password" type="password" placeholder="Crie uma senha" class="w-full p-2 border rounded-lg" required></div>
                             </div>
                        </div>
                        <p id="register-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 mt-6">
                            Criar Conta e Clínica
                        </button>
                    </form>
                </div>
                <p class="text-center mt-6 text-gray-600">Já tem uma conta? <a href="#" id="show-login-btn" class="font-semibold text-blue-600 hover:underline">Entrar</a></p>
            </div>
        </div>


        <!-- PAINEL PRINCIPAL (DASHBOARD) -->
        <div id="dashboard-view" class="hidden">
            <div class="flex h-screen bg-gray-200">
                <!-- MENU LATERAL -->
                <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800 text-white flex-col transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex">
                    <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-gray-700 px-4 text-center">
                        <span id="clinic-name-sidebar" class="truncate">FisioGestão</span>
                    </div>
                    <nav class="flex-1 p-4 space-y-2">
                         <a href="#" id="nav-inicio" class="sidebar-link active">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
                            Início
                        </a>
                        <a href="#" id="nav-pacientes" class="sidebar-link">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625 .372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 12A3 3 0 1012 6a3 3 0 000 6z" /></svg>
                            Pacientes
                        </a>
                         <a href="#" id="nav-agenda" class="sidebar-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" /></svg>
                            Agenda
                        </a>
                        <a href="#" id="nav-financeiro" class="sidebar-link">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0h1.5m-1.5 0v.75m0 0v.75m0 0h1.5m0 0h.75m0 0v-.75m0 0p-.75m0 0h-.75m2.25-4.5v.75A.75.75 0 0013.5 6h-.75m0 0v-.75A.75.75 0 0013.5 4.5h.75m0 0h1.5m-1.5 0v.75m0 0v.75m0 0h1.5m0 0h.75m0 0v-.75m0 0p-.75m-2.25-4.5v.75a.75.75 0 00.75.75h.75m0 0v-.75a.75.75 0 00-.75-.75h-.75m2.25 4.5v.75a.75.75 0 01-.75.75h-.75m0 0v-.75a.75.75 0 01.75-.75h.75M9 12.75l.75-1.036m0 0l.75-1.036m-1.5 2.072L9 12.75M9 12.75l-.75 1.036m0 0l-.75 1.036m1.5-2.072L9 12.75m-7.5 6.75h.008v.008H1.5v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            Financeiro
                        </a>
                        <a href="#" id="nav-configuracoes" class="sidebar-link">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226.554-.22 1.19-.22 1.744 0 .55.219 1.02.684 1.11 1.226l.044.261a3.75 3.75 0 015.334 2.336l.33.024c.543.04 1.06.318 1.41.744.352.425.504.994.424 1.548l-.043.262a3.75 3.75 0 01-2.336 5.334l-.024.33a1.5 1.5 0 01-.744 1.41c-.425.352-.994.504-1.548.424l-.262-.043a3.75 3.75 0 01-5.334-2.336l-.33-.024a1.5 1.5 0 01-1.41-.744c-.352-.425-.504-.994-.424-1.548l.043-.262a3.75 3.75 0 012.336-5.334l.024-.33a1.5 1.5 0 01.744-1.41zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" /></svg>
                            Configurações
                        </a>
                    </nav>
                    <div class="p-4 border-t border-gray-700">
                        <p class="text-sm text-gray-400">Usuário:</p>
                        <strong id="user-email" class="font-mono text-sm break-words">...</strong>
                        <button id="logout-btn" class="w-full mt-2 text-center text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg">Sair</button>
                    </div>
                </aside>
                <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
                <div class="flex-1 flex flex-col overflow-hidden">
                    <header class="bg-white shadow-md md:hidden">
                        <div class="flex items-center justify-between p-4">
                             <button id="mobile-menu-btn" class="text-gray-500 focus:outline-none">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            </button>
                            <h1 class="text-xl font-bold text-blue-600">FisioGestão</h1>
                            <div class="w-6"></div>
                        </div>
                    </header>
                    <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                        <!-- Conteúdo das Páginas será inserido aqui -->
                        <div id="main-content">
                            
                            <!-- Página Início -->
                            <div id="page-inicio" class="page-content">
                                <div>
                                    <h2 class="text-3xl font-semibold mb-6">Início</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <!-- Card Agendamentos do Dia -->
                                        <div class="bg-white p-6 rounded-lg shadow-lg">
                                            <h3 class="font-bold text-lg mb-4">Agendamentos de Hoje</h3>
                                            <div id="today-appointments" class="space-y-3 max-h-60 overflow-y-auto">
                                                <p class="text-gray-500">Nenhum agendamento para hoje.</p>
                                            </div>
                                        </div>
                                        <!-- Card Pacientes Ativos -->
                                        <div class="bg-white p-6 rounded-lg shadow-lg">
                                            <h3 class="font-bold text-lg mb-2">Pacientes Ativos</h3>
                                            <p id="active-patients-count" class="text-5xl font-bold text-blue-600">0</p>
                                        </div>
                                         <!-- Card de Acesso Rápido -->
                                        <div class="bg-white p-6 rounded-lg shadow-lg">
                                            <h3 class="font-bold text-lg mb-4">Acesso Rápido</h3>
                                            <div class="flex flex-col space-y-3">
                                                 <button id="quick-add-patient-btn" class="w-full text-left bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition">
                                                    + Adicionar Paciente
                                                </button>
                                                 <button id="quick-add-appointment-btn" class="w-full text-left bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition">
                                                    + Novo Agendamento
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Página Pacientes -->
                            <div id="page-pacientes" class="page-content">
                                <!-- Lista de Pacientes -->
                                <div id="patient-list-view" class="active"> <!-- Make list active by default on this page -->
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                        <div>
                                            <h2 class="text-2xl font-semibold">Pacientes</h2>
                                            <p class="text-gray-500">Gerencie seus pacientes cadastrados.</p>
                                        </div>
                                        <div class="flex items-center gap-4 w-full sm:w-auto">
                                            <input type="search" id="search-patient" placeholder="Pesquisar paciente..." class="w-full sm:w-64 p-2 border rounded-lg">
                                            <button id="add-patient-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                                                + Adicionar
                                            </button>
                                        </div>
                                    </div>
                                    <div id="patients-container-wrapper">
                                        <p class="text-center py-16 text-gray-500" id="loading-patients-msg">Carregando dados dos pacientes...</p>
                                        <div id="patients-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                                        <div id="no-patients-message" class="hidden text-center py-12 bg-white rounded-lg shadow"><p class="text-gray-500">Nenhum paciente encontrado.</p></div>
                                    </div>
                                </div>
                                <!-- Detalhes do Paciente (inicialmente escondido) -->
                                <div id="patient-detail-view" class="page-content"> <!-- Use .page-content for detail view too -->
                                    <button id="back-to-list-btn" class="mb-6 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">&larr; Voltar para a Lista</button>
                                    <div id="patient-info-container" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg"></div>
                                    <hr class="my-8">
                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-2xl font-semibold">Histórico de Evolução</h3>
                                            <button id="add-assessment-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition duration-300">+ Novo Registro</button>
                                        </div>
                                        <div id="assessments-container" class="space-y-4"></div>
                                        <div id="no-assessments-message" class="hidden text-center py-8 text-gray-500"><p>Nenhuma evolução registrada.</p></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Página Agenda -->
                            <div id="page-agenda" class="page-content">
                                <div>
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                        <div>
                                            <h2 class="text-2xl font-semibold">Agenda</h2>
                                            <p class="text-gray-500">Visualize e gerencie seus agendamentos.</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <!-- Botão Adicionar Novo Agendamento -->
                                            <button id="add-appointment-agenda-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                                                + Novo Agendamento
                                            </button>
                                            <input type="search" id="search-appointment" placeholder="Buscar paciente..." class="p-2 border rounded-lg">
                                            <div class="flex items-center bg-gray-200 rounded-lg p-1">
                                                <button id="agenda-view-daily" class="px-3 py-1 text-sm font-semibold rounded-md">Diária</button>
                                                <button id="agenda-view-weekly" class="px-3 py-1 text-sm font-semibold rounded-md">Semanal</button>
                                                <button id="agenda-view-monthly" class="px-3 py-1 text-sm font-semibold rounded-md">Mensal</button>
                                            </div>
                                        </div>
                                    </div>
                            
                                    <div class="flex items-center justify-center gap-4 mb-4">
                                        <button id="prev-period-btn" class="p-2 rounded-full bg-white shadow hover:bg-gray-100">&larr;</button>
                                        <h3 id="period-header" class="text-xl font-bold w-auto text-center"></h3>
                                        <button id="next-period-btn" class="p-2 rounded-full bg-white shadow hover:bg-gray-100">&rarr;</button>
                                    </div>
                            
                                    <div id="agenda-content">
                                        <!-- O conteúdo da agenda (diário, semanal, mensal) será inserido aqui -->
                                    </div>
                                </div>
                            </div>

                            <!-- Página Financeiro -->
                            <div id="page-financeiro" class="page-content">
                                 <div>
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                        <div>
                                            <h2 class="text-2xl font-semibold">Financeiro</h2>
                                            <p class="text-gray-500">Gerencie os pagamentos dos pacientes.</p>
                                        </div>
                                         <button id="add-payment-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                                            + Lançar Pagamento
                                        </button>
                                    </div>
                                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm text-left text-gray-500">
                                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                    <tr>
                                                        <th scope="col" class="px-6 py-3">Data</th>
                                                        <th scope="col" class="px-6 py-3">Paciente</th>
                                                        <th scope="col" class="px-6 py-3">Valor</th>
                                                        <th scope="col" class="px-6 py-3">Status</th>
                                                        <th scope="col" class="px-6 py-3">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="payments-table-body">
                                                   <tr><td colspan="5" class="text-center p-8">Carregando lançamentos...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Página Configurações -->
                            <div id="page-configuracoes" class="page-content">
                                <div id="admin-view" class="space-y-8">
                                     <div>
                                        <h2 class="text-2xl font-semibold">Configurações</h2>
                                        <p class="text-gray-500">Gerencie os dados da clínica e sua equipe.</p>
                                    </div>

                                    <!-- Seção de Dados da Clínica -->
                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <div class="flex justify-between items-start mb-4">
                                            <h3 class="text-xl font-semibold">Dados da Clínica</h3>
                                            <button id="edit-clinic-data-btn" class="text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Editar Dados</button>
                                        </div>
                                        <div id="clinic-data-display" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                                            <!-- Dados da clínica serão exibidos aqui -->
                                        </div>
                                    </div>

                                     <!-- Seção de Preferências -->
                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <h3 class="text-xl font-semibold mb-4">Preferências</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label for="default-agenda-view" class="block text-sm font-medium text-gray-700">Visualização Padrão da Agenda</label>
                                                <select id="default-agenda-view" class="mt-1 w-full p-2 border rounded-lg">
                                                    <option value="monthly">Mensal</option>
                                                    <option value="weekly">Semanal</option>
                                                    <option value="daily">Diária</option>
                                                </select>
                                            </div>
                                            <!-- NOVO: Preferência de Tipo de Atendimento -->
                                            <div>
                                                <label for="default-service-type" class="block text-sm font-medium text-gray-700">Tipo de Atendimento Padrão</label>
                                                <select id="default-service-type" class="mt-1 w-full p-2 border rounded-lg">
                                                    <option value="local">Local (na Clínica)</option>
                                                    <option value="domiciliar">Domiciliar</option>
                                                </select>
                                            </div>
                                        </div>
                                         <div class="mt-6 flex justify-end">
                                            <button id="save-preferences-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-blue-700 transition">Salvar Preferências</button>
                                        </div>
                                    </div>

                                    <!-- Seção de Gerenciamento de Membros -->
                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <h3 class="text-xl font-semibold mb-6">Membros da Equipe</h3>
                                        <div id="members-list" class="space-y-4">
                                            <!-- Membros serão listados aqui -->
                                        </div>
                                    </div>

                                    <!-- Seção de Salas de Atendimento -->
                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold">Salas de Atendimento</h3>
                                            <button id="add-room-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                                                + Adicionar Sala
                                            </button>
                                        </div>
                                        <div id="rooms-list" class="space-y-4">
                                            <!-- Salas serão listadas aqui -->
                                        </div>
                                    </div>

                                     <!-- Seção de Criação de Membros -->
                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <h3 class="text-xl font-semibold mb-4">Criar Novo Membro</h3>
                                        <form id="create-user-form" class="flex flex-col sm:flex-row items-end gap-4">
                                            <div class="w-full">
                                                <label for="new-user-email" class="block text-sm font-medium text-gray-700">E-mail do Novo Membro</label>
                                                <input type="email" id="new-user-email" class="mt-1 w-full p-2 border rounded-lg" required>
                                            </div>
                                            <div class="w-full sm:w-auto">
                                                 <label for="new-user-role" class="block text-sm font-medium text-gray-700">Função</label>
                                                 <select id="new-user-role" class="mt-1 w-full p-2 border rounded-lg" required>
                                                    <option value="fisioterapeuta">Fisioterapeuta</option>
                                                    <option value="secretaria">Secretária</option>
                                                    <option value="admin">Admin</option>
                                                 </select>
                                            </div>
                                            <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-blue-700 transition">Criar</button>
                                        </form>
                                         <p id="create-user-feedback" class="text-sm mt-4 h-4"></p>
                                    </div>
                                </div>
                                <div id="non-admin-view" class="hidden text-center p-16 bg-white rounded-lg shadow-lg">
                                     <h2 class="text-3xl font-bold text-red-600">Acesso Negado</h2>
                                     <p class="text-gray-500 mt-2">Esta página só pode ser acessada por administradores.</p>
                                </div>
                            </div>

                        </div> <!-- Fim do main-content -->
                    </main>
                </div>
            </div>
        </div>

        <!-- MODAL PARA FORÇAR ALTERAÇÃO DE SENHA -->
        <div id="force-password-change-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-md w-full" onclick="event.stopPropagation()">
                <form id="force-password-change-form">
                    <div class="p-6 border-b">
                        <h2 class="text-2xl font-bold">Alterar Senha Temporária</h2>
                        <p class="text-gray-600 mt-1">Por segurança, você precisa criar uma nova senha.</p>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label for="current-password" class="block text-sm font-medium text-gray-700">Senha Temporária Atual</label>
                            <input type="password" id="current-password" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                            <input type="password" id="new-password" class="mt-1 w-full p-2 border rounded-lg" required>
                            <p class="text-xs text-gray-500 mt-1">Mínimo 8 caracteres, com pelo menos um número.</p>
                        </div>
                         <div>
                            <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirme a Nova Senha</label>
                            <input type="password" id="confirm-new-password" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                         <p id="force-password-change-error" class="text-red-500 text-sm text-center h-4"></p>
                    </div>
                    <div class="p-6 flex justify-end bg-gray-50 rounded-b-lg">
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition">Salvar Nova Senha</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Datalists needed for searchable inputs -->
    <datalist id="patient-list"></datalist>

    <!-- TEMPLATES (REMOVIDOS - CONTEÚDO MOVIDO PARA O main-content) -->
   
    <!-- MODAIS -->
    <!-- Modal de Salas -->
    <div id="room-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-lg w-full" onclick="event.stopPropagation()">
            <form id="room-form">
                <div class="p-6 border-b">
                    <h2 id="room-modal-title" class="text-2xl font-bold">Adicionar Sala</h2>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="room-id">
                    <div>
                        <label for="room-name" class="block text-sm font-medium text-gray-700">Nome da Sala</label>
                        <input type="text" id="room-name" class="mt-1 w-full p-2 border rounded-lg" required>
                    </div>
                </div>
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg">
                    <button type="button" id="cancel-room-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal de Edição da Clínica -->
    <div id="clinic-edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-lg w-full" onclick="event.stopPropagation()">
            <form id="clinic-edit-form">
                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold">Editar Dados da Clínica</h2>
                </div>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto" id="clinic-edit-form-fields">
                    <!-- Campos de edição serão injetados aqui -->
                </div>
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg">
                    <button type="button" id="cancel-clinic-edit-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Agendamento -->
    <div id="appointment-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-lg w-full" onclick="event.stopPropagation()">
            <form id="appointment-form">
                <div class="p-6 border-b">
                    <h2 id="appointment-modal-title" class="text-2xl font-bold">Novo Agendamento</h2>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="appointment-id"> <!-- Added for editing/deleting -->
                    <input type="hidden" id="appointment-date">
                    <div>
                        <label for="appointment-patient-input" class="block text-sm font-medium text-gray-700">Paciente</label>
                        <!-- NOTE: Standard datalist doesn't filter while typing, only suggests based on what's typed. -->
                        <input type="text" id="appointment-patient-input" list="patient-list" class="mt-1 w-full p-2 border rounded-lg" placeholder="Digite para buscar..." required autocomplete="off">
                        <input type="hidden" id="appointment-patient-id"> <!-- Hidden input to store selected ID -->
                    </div>
                    
                    <!-- NOVO: Tipo de Atendimento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Atendimento</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center"><input type="radio" name="serviceType" value="local" class="mr-2" checked> Local (Clínica)</label>
                            <label class="flex items-center"><input type="radio" name="serviceType" value="domiciliar" class="mr-2"> Domiciliar</label>
                        </div>
                    </div>
                    
                    <!-- Profissional (Sempre visível) -->
                    <div>
                        <label for="appointment-professional" class="block text-sm font-medium text-gray-700">Profissional</label>
                        <select id="appointment-professional" class="mt-1 w-full p-2 border rounded-lg" required></select>
                    </div>
                    
                    <!-- Sala container (Local only) -->
                    <div id="sala-container">
                        <div>
                            <label for="appointment-room" class="block text-sm font-medium text-gray-700">Sala</label>
                            <select id="appointment-room" class="mt-1 w-full p-2 border rounded-lg" required></select>
                        </div>
                    </div>

                    <!-- NOVO: Domiciliar container (hidden by default) -->
                    <div id="domiciliar-container" class="hidden space-y-2 border p-3 rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700">Endereço do Atendimento</label>
                        <!-- Campos de Endereço Separados -->
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div class="md:col-span-2"><input id="appointment-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="appointment"></div>
                            <div class="md:col-span-4"><input id="appointment-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-2"><input id="appointment-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-4"><input id="appointment-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="appointment-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="appointment-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="appointment-time" class="block text-sm font-medium text-gray-700">Horário</label>
                             <input type="time" id="appointment-time" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                         <div>
                             <label for="appointment-duration" class="block text-sm font-medium text-gray-700">Duração (min)</label>
                             <input type="number" id="appointment-duration" value="50" min="1" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                    </div>
                    <div>
                        <label for="appointment-notes" class="block text-sm font-medium text-gray-700">Observações</label>
                        <textarea id="appointment-notes" rows="3" class="mt-1 w-full p-2 border rounded-lg"></textarea>
                    </div>
                </div>
                <div class="p-6 flex justify-between space-x-4 bg-gray-50 rounded-b-lg"> <!-- Changed justify-end to justify-between -->
                    <button type="button" id="delete-appointment-btn" class="bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition hidden">Excluir</button> <!-- Added Delete Button -->
                    <div class="flex space-x-4"> <!-- Wrapper for cancel/save -->
                        <button type="button" id="cancel-appointment-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Lançamento Financeiro -->
     <div id="financial-record-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-lg w-full" onclick="event.stopPropagation()">
            <form id="financial-record-form">
                <div class="p-6 border-b">
                    <h2 id="financial-modal-title" class="text-2xl font-bold">Lançar Pagamento</h2>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="financial-record-id">
                    <div>
                        <label for="financial-patient-input" class="block text-sm font-medium text-gray-700">Paciente</label>
                        <!-- NOTE: Standard datalist doesn't filter while typing, only suggests. -->
                        <input type="text" id="financial-patient-input" list="patient-list" class="mt-1 w-full p-2 border rounded-lg" placeholder="Digite para buscar..." required autocomplete="off">
                        <input type="hidden" id="financial-patient-id"> <!-- Hidden input to store selected ID -->
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="financial-date" class="block text-sm font-medium text-gray-700">Data</label>
                             <input type="date" id="financial-date" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                         <div>
                            <label for="financial-value" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                            <input type="number" step="0.01" id="financial-value" placeholder="100.00" class="w-full p-2 border rounded-lg" required>
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="financial-status" class="block text-sm font-medium text-gray-700">Status</label>
                             <select id="financial-status" class="mt-1 w-full p-2 border rounded-lg" required>
                                <option value="pago">Pago</option>
                                <option value="pendente">Pendente</option>
                             </select>
                        </div>
                    </div>
                    <div>
                        <label for="financial-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                        <textarea id="financial-description" rows="3" class="mt-1 w-full p-2 border rounded-lg" placeholder="Ex: Pacote de 10 sessões"></textarea>
                    </div>
                </div>
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg">
                    <button type="button" id="cancel-financial-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Outros modais... -->
    <div id="change-role-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-sm w-full" onclick="event.stopPropagation()">
            <form id="change-role-form">
                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold">Alterar Função</h2>
                </div>
                 <div class="p-6 space-y-4">
                    <input type="hidden" id="change-role-user-id">
                    <p>Alterar função de <strong id="change-role-user-email"></strong> para:</p>
                    <select id="change-role-select" class="w-full p-2 border rounded-lg" required>
                        <option value="fisioterapeuta">Fisioterapeuta</option>
                        <option value="secretaria">Secretária</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg">
                    <button type="button" id="cancel-change-role-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="patient-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-2xl w-full p-6 sm:p-8" onclick="event.stopPropagation()">
            <form id="patient-form">
                <h2 id="patient-modal-title" class="text-2xl font-bold mb-6">Adicionar Novo Paciente</h2>
                <input type="hidden" id="patient-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2"><input id="patient-name" type="text" placeholder="Nome Completo" class="w-full p-2 border rounded" required></div>
                    <div><input id="patient-cpf" type="text" placeholder="CPF" class="w-full p-2 border rounded"></div>
                    <div><input id="patient-birthDate" type="date" placeholder="Data de Nascimento" class="w-full p-2 border rounded" required></div>
                    <div>
                        <select id="patient-gender" class="w-full p-2 border rounded" required>
                            <option value="" disabled selected>Sexo</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div><input id="patient-phone" type="tel" placeholder="Telefone" class="w-full p-2 border rounded"></div>
                    <div class="md:col-span-2"><input id="patient-caregiver" type="text" placeholder="Responsável/Cuidador (Opcional)" class="w-full p-2 border rounded"></div>
                    
                    <!-- NOVO: Campos de Endereço Separados -->
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                        <div class="md:col-span-2"><input id="patient-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="patient"></div>
                        <div class="md:col-span-4"><input id="patient-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-2"><input id="patient-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-4"><input id="patient-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-3"><input id="patient-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-3"><input id="patient-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                    </div>
                    
                    <div class="md:col-span-2"><textarea id="patient-observations" placeholder="Observações" class="w-full p-2 border rounded" rows="3"></textarea></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-patient-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="assessment-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-4xl w-full" onclick="event.stopPropagation()">
            <form id="assessment-form">
                <div class="p-6 border-b">
                    <h2 id="assessment-modal-title" class="text-2xl font-bold">Novo Registro de Evolução</h2>
                </div>
                <div class="p-4 flex flex-wrap gap-2 border-b">
                    <button type="button" data-tab="tab1" class="tab-button active font-semibold py-2 px-4 rounded-lg text-sm">1. Histórico Clínico</button>
                    <button type="button" data-tab="tab2" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">2. Cognitivo/Emocional</button>
                    <button type="button" data-tab="tab3" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">3. Avaliação Física</button>
                    <button type="button" data-tab="tab4" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">4. Funcionalidade</button>
                    <button type="button" data-tab="tab5" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">5. Ambiente</button>
                    <button type="button" data-tab="tab6" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">6. Objetivos</button>
                </div>
                <div class="p-6 h-[60vh] overflow-y-auto">
                    <div id="tab1" class="tab-content space-y-4">
                        <h3 class="font-bold text-lg">Histórico Clínico</h3>
                        <div class="grid grid-cols-1 gap-4">
                             <div><label class="block text-sm font-medium">Diagnóstico Médico Principal</label><input id="diag-medico" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Comorbidades</label><input id="comorbidades" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Medicações em uso</label><input id="medicacoes" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Internações/Cirurgias Prévias</label><input id="cirurgias" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Principais Queixas</label><textarea id="queixas" class="w-full p-2 border rounded" rows="3"></textarea></div>
                            <div>
                                <label class="block text-sm font-medium">Dor (EVA 0-10)</label>
                                <select id="dor-eva" class="w-full p-2 border rounded">
                                    <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                    <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                                </select>
                            </div>
                            <div id="dor-local-container" class="hidden"><label class="block text-sm font-medium">Local da Dor</label><input id="dor-local" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Hábitos (tabagismo, sono, alimentação...)</label><textarea id="habitos" class="w-full p-2 border rounded" rows="3"></textarea></div>
                        </div>
                    </div>
                    <div id="tab2" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Aspectos Cognitivos e Emocionais</h3>
                        <div class="grid grid-cols-1 gap-4">
                             <div><label class="block text-sm font-medium">Estado de Consciência</label><select id="consciencia" class="w-full p-2 border rounded"><option>Alerta</option><option>Confuso</option><option>Sonolento</option></select></div>
                             <div><label class="block text-sm font-medium">Orientação</label><select id="orientacao" class="w-full p-2 border rounded"><option>Tempo</option><option>Espaço</option><option>Pessoa</option></select></div>
                             <div><label class="block text-sm font-medium">Comunicação</label><input id="comunicacao" type="text" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>
                    <div id="tab3" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Avaliação Física</h3>
                        <div class="grid grid-cols-1 gap-4">
                              <div><label class="block text-sm font-medium">Postura</label><input id="postura" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Marcha</label><input id="marcha" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Equilíbrio</label><input id="equilibrio" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">ADM</label><input id="adm" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Força Muscular (0-5)</label><select id="forca" class="w-full p-2 border rounded"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
                              <div><label class="block text-sm font-medium">Tônus</label><input id="tonus" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Coordenação Motora</label><input id="coordenacao" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Sensibilidade</label><input id="sensibilidade" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Edema</label><select id="edema" class="w-full p-2 border rounded"><option>Não</option><option>Sim</option></select></div>
                              <div id="edema-local-container" class="hidden"><label class="block text-sm font-medium">Local/Descrição do Edema</label><input id="edema-local" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Testes Realizados</label><textarea id="testes-realizados" class="w-full p-2 border rounded" rows="3"></textarea></div>
                        </div>
                    </div>
                    <div id="tab4" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Funcionalidade (AVDs)</h3>
                        <div class="grid grid-cols-1 gap-6">
                            <div><label class="block font-medium">Banho</label><div class="flex gap-4 mt-2"><label><input type="radio" name="banho" value="Independente"> Independente</label><label><input type="radio" name="banho" value="Parcial"> Parcial</label><label><input type="radio" name="banho" value="Dependente"> Dependente</label></div></div>
                            <div><label class="block font-medium">Vestir-se</label><div class="flex gap-4 mt-2"><label><input type="radio" name="vestir" value="Independente"> Independente</label><label><input type="radio" name="vestir" value="Parcial"> Parcial</label><label><input type="radio" name="vestir" value="Dependente"> Dependente</label></div></div>
                            <div><label class="block font-medium">Alimentação</label><div class="flex gap-4 mt-2"><label><input type="radio" name="alimentacao" value="Independente"> Independente</label><label><input type="radio" name="alimentacao" value="Parcial"> Parcial</label><label><input type="radio" name="alimentacao" value="Dependente"> Dependente</label></div></div>
                            <div><label class="block font-medium">Continência</label><div class="flex gap-4 mt-2"><label><input type="radio" name="continencia" value="Sim"> Sim</label><label><input type="radio" name="continencia" value="Não"> Não</label></div></div>
                            <div><label class="block font-medium">Uso de Fraldas</label><div class="flex gap-4 mt-2"><label><input type="radio" name="fraldas" value="Sim"> Sim</label><label><input type="radio" name="fraldas" value="Não"> Não</label></div></div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 pt-4">
                             <div><label class="block text-sm font-medium">Transferências</label><input id="transferencias" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Deambulação</label><input id="deambulacao" type="text" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>
                    <div id="tab5" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Ambiente Domiciliar</h3>
                         <div class="grid grid-cols-1 gap-6">
                            <div><label class="block font-medium">Tipo de Residência</label><div class="flex gap-4 mt-2"><label><input type="radio" name="residencia" value="Casa"> Casa</label><label><input type="radio" name="residencia" value="Apartamento"> Apto</label><label><input type="radio" name="residencia" value="Outros"> Outros</label></div></div>
                            <div><label class="block font-medium">Iluminação</label><div class="flex gap-4 mt-2"><label><input type="radio" name="iluminacao" value="Adequada"> Adequada</label><label><input type="radio" name="iluminacao" value="Inadequada"> Inadequada</label></div></div>
                            <div><label class="block font-medium">Espaço para Exercícios</label><div class="flex gap-4 mt-2"><label><input type="radio" name="espaco" value="Sim"> Sim</label><label><input type="radio" name="espaco" value="Não"> Não</label></div></div>
                            <div><label class="block font-medium">Barreiras Arquitetônicas</label><div class="flex gap-4 mt-2 flex-wrap"><label><input type="checkbox" name="barreiras" value="Escadas"> Escadas</label><label><input type="checkbox" name="barreiras" value="Tapetes"> Tapetes</label><label><input type="checkbox" name="barreiras" value="Falta de barras"> Falta de barras</label></div></div>
                        </div>
                    </div>
                    <div id="tab6" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Objetivos da Fisioterapia</h3>
                        <div><label class="block text-sm font-medium">Defina os objetivos de curto, médio e longo prazo.</label><textarea id="objetivos" class="w-full p-2 border rounded" rows="8"></textarea></div>
                    </div>
                </div>

                <div class="mt-4 p-6 flex justify-end space-x-4 border-t">
                    <button type="button" id="cancel-assessment-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar Evolução</button>
                </div>
            </form>
        </div>
    </div>
    <div id="assessment-detail-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-4xl w-full" onclick="event.stopPropagation()">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">Detalhes da Evolução</h2>
                <button id="close-assessment-detail-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>

            <div class="p-4 flex flex-wrap gap-2 border-b">
                 <button type="button" data-tab="detail-tab1" class="tab-button active font-semibold py-2 px-4 rounded-lg text-sm">1. Histórico Clínico</button>
                 <button type="button" data-tab="detail-tab2" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">2. Cognitivo/Emocional</button>
                 <button type="button" data-tab="detail-tab3" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">3. Avaliação Física</button>
                 <button type="button" data-tab="detail-tab4" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">4. Funcionalidade</button>
                 <button type="button" data-tab="detail-tab5" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">5. Ambiente</button>
                 <button type="button" data-tab="detail-tab6" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">6. Objetivos</button>
            </div>

            <div class="p-6 h-[60vh] overflow-y-auto">
                 <div id="detail-tab1" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Diagnóstico Médico Principal</h4><p id="detail-diagMedico" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Comorbidades</h4><p id="detail-comorbidades" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Medicações em uso</h4><p id="detail-medicacoes" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Internações/Cirurgias Prévias</h4><p id="detail-cirurgias" class="detail-value"></p></div>
                    <div class="md:col-span-2"><h4 class="detail-label">Principais Queixas</h4><p id="detail-queixas" class="detail-value whitespace-pre-wrap"></p></div>
                    <div><h4 class="detail-label">Dor (EVA 0-10)</h4><p id="detail-dorEva" class="detail-value"></p></div>
                    <div><h4 classD="detail-label">Local da Dor</h4><p id="detail-dorLocal" class="detail-value"></p></div>
                    <div class="md:col-span-2"><h4 class="detail-label">Hábitos</h4><p id="detail-habitos" class="detail-value whitespace-pre-wrap"></p></div>
                </div>
                <div id="detail-tab2" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Estado de Consciência</h4><p id="detail-consciencia" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Orientação</h4><p id="detail-orientacao" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Comunicação</h4><p id="detail-comunicacao" class="detail-value"></p></div>
                </div>
                <div id="detail-tab3" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Postura</h4><p id="detail-postura" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Marcha</h4><p id="detail-marcha" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Equilíbrio</h4><p id="detail-equilibrio" class="detail-value"></p></div>
                    <div><h4 class="detail-label">ADM</h4><p id="detail-adm" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Força Muscular (0-5)</h4><p id="detail-forca" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Tônus</h4><p id="detail-tonus" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Coordenação Motora</h4><p id="detail-coordenacao" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Sensibilidade</h4><p id="detail-sensibilidade" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Edema</h4><p id="detail-edema" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Local/Descrição do Edema</h4><p id="detail-edemaLocal" class="detail-value"></p></div>
                    <div class="md:col-span-2"><h4 class="detail-label">Testes Realizados</h4><p id="detail-testesRealizados" class="detail-value whitespace-pre-wrap"></p></div>
                </div>
                <div id="detail-tab4" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                       <div><h4 class="detail-label">Banho</h4><p id="detail-banho" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Vestir-se</h4><p id="detail-vestir" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Alimentação</h4><p id="detail-alimentacao" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Continência</h4><p id="detail-continencia" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Uso de Fraldas</h4><p id="detail-fraldas" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Transferências</h4><p id="detail-transferencias" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Deambulação</h4><p id="detail-deambulacao" class="detail-value"></p></div>
                </div>
                <div id="detail-tab5" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Tipo de Residência</h4><p id="detail-residencia" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Iluminação</h4><p id="detail-iluminacao" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Espaço para Exercícios</h4><p id="detail-espaco" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Barreiras Arquitetônicas</h4><p id="detail-barreiras" class="detail-value"></p></div>
                </div>
                <div id="detail-tab6" class="tab-content hidden grid grid-cols-1">
                    <div><h4 class="detail-label">Objetivos da Fisioterapia</h4><p id="detail-objetivos" class="detail-value whitespace-pre-wrap"></p></div>
                </div>
            </div>
             <div class="mt-4 p-6 flex justify-end space-x-4 border-t">
                <button type="button" id="close-assessment-detail-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Fechar</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmar Exclusão</h3>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">Você tem certeza? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirm-modal-confirm" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Excluir</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, reauthenticateWithCredential, EmailAuthProvider, updatePassword, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Added missing imports
        import { getFirestore, doc, collection, addDoc, getDoc, setDoc, deleteDoc, onSnapshot, query, where, updateDoc, arrayRemove, arrayUnion, serverTimestamp, deleteField, orderBy, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Added setLogLevel, getDocs

        setLogLevel('debug'); // Enable Firestore debug logging

        // NOTE: Firebase config is public by design. Security is enforced by Firestore rules.
        const firebaseConfig = {
            apiKey: "AIzaSyB5DK7R3WGtKIUy_fMt8iNKBtz9wgdBxVs",
            authDomain: "fisioterapia-cee9d.firebaseapp.com",
            projectId: "fisioterapia-cee9d",
            storageBucket: "fisioterapia-cee9d.appspot.com",
            messagingSenderId: "551406348997",
            appId: "1:551406348997:web:7b21e0d90ebf4969955eac",
            measurementId: "G-RDGZ2MKLWK"
        };

        let app; // Declare app globally
        try {
            app = initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            alert("Erro ao inicializar a conexão com o banco de dados. Tente recarregar a página."); // Inform user
        }
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL VARIABLES ---
        let currentUserClinicId = null;
        let currentUserRole = null;
        let currentUserId = null;
        let selectedPatientId = null; // ID of patient being viewed/edited
        let patientsUnsubscribe = null;
        let assessmentsUnsubscribe = null;
        let allPatients = []; // Holds all patients for datalists
        let clinicUsers = []; // Holds all users for professional select
        let clinicRooms = []; // Holds all rooms for room select
        let clinicPreferences = { defaultAgendaView: 'monthly', defaultServiceType: 'local' }; // Added default service type
        let currentAgendaView = 'monthly';
        let currentDate = new Date(); // Represents the current day/start of week/month being viewed
        let currentAppointments = []; // Store currently displayed appointments for filtering/rendering
        let appointmentsUnsubscribe = null;
        let paymentsUnsubscribe = null;
        let membersUnsubscribe = null;
        let roomsUnsubscribe = null;
        let dashboardAppointmentsUnsubscribe = null; // Specific listener for dashboard
        let initialDataLoaded = false; // Flag to track initial data load

        // --- ELEMENT SELECTORS ---
        const authView = document.getElementById('auth-view');
        const loginContainer = document.getElementById('login-container');
        const registerContainer = document.getElementById('register-container');
        const dashboardView = document.getElementById('dashboard-view');
        const mainContentContainer = document.getElementById('main-content');
        const patientModal = document.getElementById('patient-modal');
        const assessmentModal = document.getElementById('assessment-modal');
        const assessmentDetailModal = document.getElementById('assessment-detail-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const appointmentModal = document.getElementById('appointment-modal');
        const financialRecordModal = document.getElementById('financial-record-modal');
        const changeRoleModal = document.getElementById('change-role-modal');
        const forcePasswordChangeModal = document.getElementById('force-password-change-modal');
        const clinicEditModal = document.getElementById('clinic-edit-modal');
        const roomModal = document.getElementById('room-modal');
        const patientDatalist = document.getElementById('patient-list');
        const loadingOverlay = document.getElementById('loading-overlay'); // Loading overlay selector

        // --- UTILITY FUNCTIONS ---
        function showLoading() { if(loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { if(loadingOverlay) loadingOverlay.classList.add('hidden'); }

        function openModal(modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeModal(modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }

        function showConfirmation(title, text, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            openModal(confirmModal);

            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');

            // Clone and replace buttons to remove previous listeners reliably
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);


            const confirmHandler = () => { onConfirm(); closeModal(confirmModal); };
            const cancelHandler = () => { closeModal(confirmModal); };

            newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            newCancelBtn.addEventListener('click', cancelHandler, { once: true });
        }


        // Helper to get YYYY-MM-DD string adjusted for local timezone
        function getDateString(date) {
            if (!date) return ''; // Handle null/undefined dates
            const d = new Date(date);
            // Adjust for timezone offset to get the correct local date string
            // Create a new date object adjusted for the timezone offset
            const adjustedDate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
            return adjustedDate.toISOString().split('T')[0];
        }


        // --- RENDER FUNCTIONS ---
        function renderPatientList(patients) {
            // Ensure elements exist before trying to manipulate them
             const loadingMsg = mainContentContainer.querySelector("#loading-patients-msg");
             const container = mainContentContainer.querySelector('#patients-container');
             const noPatientsMsg = mainContentContainer.querySelector('#no-patients-message');

             if (!container || !noPatientsMsg || !loadingMsg) {
                  // This is expected if the view is not active, so no warning needed here.
                  return; // Exit if elements aren't in the current view
             }


            loadingMsg.classList.add('hidden');
            container.innerHTML = '';

            if (patients.length === 0) {
                noPatientsMsg.classList.remove('hidden');
                container.classList.add('hidden');
            } else {
                noPatientsMsg.classList.add('hidden');
                container.classList.remove('hidden');
                patients.sort((a, b) => a.name.localeCompare(b.name));

                patients.forEach(patient => {
                    const age = patient.birthDate ? new Date().getFullYear() - new Date(patient.birthDate).getFullYear() : 'N/A';
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow duration-300 flex flex-col justify-between';
                    card.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold text-blue-700 truncate">${patient.name}</h3>
                            <p class="text-gray-600">${age} anos</p>
                            <p class="text-sm text-gray-500 mt-2 h-10 overflow-hidden">${patient.phone || 'Sem telefone'}</p>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-id="${patient.id}" class="view-details-btn bg-green-100 text-green-800 font-semibold p-2 rounded-lg hover:bg-green-200 transition" title="Avaliar / Ver Detalhes">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-id="${patient.id}" class="edit-patient-btn bg-yellow-100 text-yellow-800 font-semibold p-2 rounded-lg hover:bg-yellow-200 transition" title="Editar Cadastro">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-id="${patient.id}" class="delete-patient-btn bg-red-100 text-red-800 font-semibold p-2 rounded-lg hover:bg-red-200 transition" title="Excluir Paciente">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h--3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>`;
                    container.appendChild(card);
                });
            }
        }
        
        // NOVO: Helper para construir string de endereço
        function constructPatientAddress(patient) {
            if (!patient) return '';
            const addressParts = [
                patient.street || '',
                patient.number ? `nº ${patient.number}` : '', // Add "nº" for clarity
                patient.neighborhood || '',
                patient.city || '',
                patient.state || ''
            ];
            // Filter out empty parts and join
            return addressParts.filter(Boolean).join(', ');
        }


        function renderPatientDetails(patient) {
            const container = mainContentContainer.querySelector('#patient-info-container');
            if(!container) return;
            const age = patient.birthDate ? new Date().getFullYear() - new Date(patient.birthDate).getFullYear() : 'N/A';
            const fullAddress = constructPatientAddress(patient); // Use helper function

            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-2">${patient.name}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4 text-gray-700">
                    <p><strong>Idade:</strong> ${age} anos</p><p><strong>Sexo:</strong> ${patient.gender || 'Não informado'}</p><p><strong>CPF:</strong> ${patient.cpf || 'Não informado'}</p>
                    <p><strong>Telefone:</strong> ${patient.phone || 'Não informado'}</p>
                    <p class="md:col-span-2 lg:col-span-3"><strong>Endereço:</strong> ${fullAddress || 'Não informado'}</p>
                    <p class="md:col-span-2 lg:col-span-3"><strong>Responsável/Cuidador:</strong> ${patient.caregiver || 'Não informado'}</p>
                    <p class="md:col-span-2 lg:col-span-3"><strong>Observações:</strong> ${patient.observations || 'Não informado'}</p>
                </div>`;
        }

        function renderAssessmentList(assessments) {
            const container = mainContentContainer.querySelector('#assessments-container');
            const noAssessmentsMsg = mainContentContainer.querySelector('#no-assessments-message');
            if (!container || !noAssessmentsMsg) return;
            container.innerHTML = '';
            if (assessments.length === 0) { noAssessmentsMsg.classList.remove('hidden'); return; }
            noAssessmentsMsg.classList.add('hidden');

            // Sorting is already handled by Firestore query (orderBy createdAt desc)
            // assessments.sort((a, b) => { ... }); // No longer needed here

            assessments.forEach(assessment => {
                 const assessmentDate = assessment.createdAt && assessment.createdAt.toDate
                    ? assessment.createdAt.toDate().toLocaleString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                    : 'Data pendente...';
                 const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">Registro de Evolução</p>
                            <p class="text-sm text-gray-600">${assessmentDate}</p>
                        </div>
                        <button data-id="${assessment.id}" class="view-assessment-btn text-sm text-blue-600 hover:underline">Ver Detalhes</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- AGENDA FUNCTIONS ---
        function renderAgendaView(appointments, searchTerm = '') {
            const agendaContentEl = mainContentContainer.querySelector('#agenda-content');
             if (!agendaContentEl) return; // Exit if agenda view is not active

            const filteredAppointments = searchTerm
                ? appointments.filter(app => app.patientName && app.patientName.toLowerCase().includes(searchTerm.toLowerCase())) // Add safety check for patientName
                : appointments;

            if (currentAgendaView === 'monthly') {
                renderMonthlyView(currentDate.getFullYear(), currentDate.getMonth(), filteredAppointments);
            } else if (currentAgendaView === 'weekly') {
                renderWeeklyView(currentDate, filteredAppointments);
            } else {
                renderDailyView(currentDate, filteredAppointments);
            }
        }

        function renderMonthlyView(year, month, appointments = []) {
            const agendaContent = mainContentContainer.querySelector('#agenda-content');
            if (!agendaContent) return;

            let contentHTML = `
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div class="grid grid-cols-7 gap-px text-center font-semibold text-sm text-gray-600 mb-2">
                        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px"></div>
                </div>`;
            agendaContent.innerHTML = contentHTML;

            const calendarGrid = agendaContent.querySelector('#calendar-grid');
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon...
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // Get last day of month

            // Add empty cells for days before the 1st
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
            }

            const today = new Date();
            const todayStr = getDateString(today); // Get today's date string once

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDayDate = new Date(year, month, day);
                const dateStr = getDateString(currentDayDate);
                const dayAppointments = appointments.filter(a => a.date === dateStr).sort((a,b) => a.time.localeCompare(b.time));

                let appointmentsHTML = dayAppointments.map(app => {
                    const location = app.serviceType === 'domiciliar' ? 'Domiciliar' : (app.roomName || 'N/A');
                    const title = `${app.time} - ${app.patientName}\nProf: ${app.professionalName || 'N/A'}\nLocal: ${location}`;
                    return `<div class="appointment-item appointment-badge text-xs bg-blue-100 text-blue-800 p-1 rounded-md mb-1" data-appointment-id="${app.id}" title="${title}">
                        ${app.time} - ${app.patientName}
                    </div>`
                }).join('');

                const isToday = dateStr === todayStr;
                const dayClass = isToday ? 'bg-blue-100' : 'bg-gray-50 hover:bg-gray-100';

                calendarGrid.insertAdjacentHTML('beforeend', `
                    <div class="calendar-day border p-2 ${dayClass} flex flex-col cursor-pointer" data-date="${dateStr}">
                        <div class="font-bold text-gray-800">${day}</div>
                        <div class="mt-1 flex-1 overflow-y-auto text-left">${appointmentsHTML}</div>
                    </div>
                `);
            }
        }


        function renderWeeklyView(date, appointments = []) {
            const agendaContent = mainContentContainer.querySelector('#agenda-content');
             if (!agendaContent) return;
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            let tableHTML = `
                <div class="bg-white rounded-lg shadow-lg p-4 overflow-x-auto"> <!-- Added overflow-x-auto -->
                    <div class="grid grid-cols-7 text-center font-semibold text-sm text-gray-600 min-w-[700px]">`; // Added min-width

            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - startOfWeek.getDay()); // Adjust to start on Sunday

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                tableHTML += `<div>${weekDays[i]} <span class="font-normal text-gray-500">${day.getDate()}</span></div>`;
            }
            tableHTML += `</div><div class="grid grid-cols-7 border-t border-l mt-2 min-w-[700px]">`; // Added min-width

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateStr = getDateString(day);
                const dayAppointments = appointments.filter(a => a.date === dateStr).sort((a,b) => a.time.localeCompare(b.time));

                let appointmentsHTML = dayAppointments.map(app => {
                    const location = app.serviceType === 'domiciliar' ? 'Domiciliar' : (app.roomName || 'N/A');
                    const title = `${app.time} - ${app.patientName}\nProf: ${app.professionalName || 'N/A'}\nLocal: ${location}`;
                    return `<div class="appointment-item appointment-badge text-xs bg-blue-100 text-blue-800 p-1 rounded-md mb-1" data-appointment-id="${app.id}" title="${title}">
                        ${app.time} - ${app.patientName}
                    </div>`
                }).join('');

                tableHTML += `<div class="border-r border-b p-2 min-h-[200px] cursor-pointer" data-date="${dateStr}">${appointmentsHTML}</div>`;
            }

            tableHTML += `</div></div>`;
            agendaContent.innerHTML = tableHTML;
        }


        function renderDailyView(date, appointments = []) {
             const agendaContent = mainContentContainer.querySelector('#agenda-content');
              if (!agendaContent) return;
             let appointmentsHTML = '<p class="text-gray-500">Nenhum agendamento para este dia.</p>';
             const dateStr = getDateString(date);
             const dayAppointments = appointments.filter(a => a.date === dateStr).sort((a,b) => a.time.localeCompare(b.time));

             if (dayAppointments.length > 0) {
                 appointmentsHTML = dayAppointments.map(app => {
                    // NOVO: Usar o fullAddress construído se for domiciliar
                    const location = app.serviceType === 'domiciliar' 
                        ? `Domiciliar (${app.address || 'Endereço não informado'})` // 'address' agora é a string completa
                        : `Sala: ${app.roomName || 'N/A'}`;
                    return `<div class="appointment-item bg-blue-50 p-4 rounded-lg border border-blue-200 cursor-pointer" data-appointment-id="${app.id}">
                        <p class="font-bold">${app.time} - ${app.patientName}</p>
                        <p class="text-sm text-gray-600">Profissional: ${app.professionalName || 'N/A'}</p>
                        <p class="text-sm text-gray-600">${location}</p>
                        ${app.notes ? `<p class="text-sm text-gray-500 mt-2">Obs: ${app.notes}</p>` : ''}
                    </div>`
                 }).join('');
             }
             // Add data-date to the container for creating new appointments on this day
             agendaContent.innerHTML = `<div class="bg-white rounded-lg shadow-lg p-4 space-y-4" data-date="${dateStr}">${appointmentsHTML}</div>`;
        }


        // --- DATA FETCHING FUNCTIONS ---
        function populateAssessmentDetailModal(data) {
            const orDefault = (value) => value || 'Não informado';
            // Tab 1
            document.getElementById('detail-diagMedico').textContent = orDefault(data.diagMedico);
            document.getElementById('detail-comorbidades').textContent = orDefault(data.comorbidades);
            document.getElementById('detail-medicacoes').textContent = orDefault(data.medicacoes);
            document.getElementById('detail-cirurgias').textContent = orDefault(data.cirurgias);
            document.getElementById('detail-queixas').textContent = orDefault(data.queixas);
            document.getElementById('detail-dorEva').textContent = orDefault(data.dorEva);
            document.getElementById('detail-dorLocal').textContent = orDefault(data.dorLocal);
            document.getElementById('detail-habitos').textContent = orDefault(data.habitos);
            // Tab 2
            document.getElementById('detail-consciencia').textContent = orDefault(data.consciencia);
            document.getElementById('detail-orientacao').textContent = orDefault(data.orientacao);
            document.getElementById('detail-comunicacao').textContent = orDefault(data.comunicacao);
            // Tab 3
            document.getElementById('detail-postura').textContent = orDefault(data.postura);
            document.getElementById('detail-marcha').textContent = orDefault(data.marcha);
            document.getElementById('detail-equilibrio').textContent = orDefault(data.equilibrio);
            document.getElementById('detail-adm').textContent = orDefault(data.adm);
            document.getElementById('detail-forca').textContent = orDefault(data.forca);
            document.getElementById('detail-tonus').textContent = orDefault(data.tonus);
            document.getElementById('detail-coordenacao').textContent = orDefault(data.coordenacao);
            document.getElementById('detail-sensibilidade').textContent = orDefault(data.sensibilidade);
            document.getElementById('detail-edema').textContent = orDefault(data.edema);
            document.getElementById('detail-edemaLocal').textContent = orDefault(data.edemaLocal);
            document.getElementById('detail-testesRealizados').textContent = orDefault(data.testesRealizados);
            // Tab 4
            document.getElementById('detail-banho').textContent = orDefault(data.banho);
            document.getElementById('detail-vestir').textContent = orDefault(data.vestir);
            document.getElementById('detail-alimentacao').textContent = orDefault(data.alimentacao);
            document.getElementById('detail-continencia').textContent = orDefault(data.continencia);
            document.getElementById('detail-fraldas').textContent = orDefault(data.fraldas);
            document.getElementById('detail-transferencias').textContent = orDefault(data.transferencias);
            document.getElementById('detail-deambulacao').textContent = orDefault(data.deambulacao);
            // Tab 5
            document.getElementById('detail-residencia').textContent = orDefault(data.residencia);
            document.getElementById('detail-iluminacao').textContent = orDefault(data.iluminacao);
            document.getElementById('detail-espaco').textContent = orDefault(data.espaco);
            document.getElementById('detail-barreiras').textContent = data.barreiras && data.barreiras.length > 0 ? data.barreiras.join(', ') : 'Nenhuma';
             // Tab 6
            document.getElementById('detail-objetivos').textContent = orDefault(data.objetivos);
        }

        function fetchAndRenderPatients() {
            if (!currentUserClinicId) return Promise.reject("No clinic ID");
            if (patientsUnsubscribe) patientsUnsubscribe();
            console.log("Setting up patients listener...");

            const patientsCollection = collection(db, "clinics", currentUserClinicId, "patients");
            const q = query(patientsCollection);

            return new Promise((resolve, reject) => { // Return promise
                patientsUnsubscribe = onSnapshot(q, (snapshot) => {
                    console.log(`Patients snapshot received: ${snapshot.size} docs`);
                    allPatients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populatePatientDatalist(); // Update datalist whenever patients change
                    // Only render list if the current view is 'pacientes'
                    if(document.getElementById('patient-list-view')) {
                        renderPatientList(allPatients);
                    }
                    resolve(); // Resolve on successful fetch/update
                }, (error) => {
                    console.error("Erro ao buscar pacientes: ", error);
                    if(document.getElementById('patient-list-view')) {
                        renderPatientList([]);
                    }
                    reject(error); // Reject on error
                });
            });
        }


        // Function to populate the patient datalist
        function populatePatientDatalist() {
            if (!patientDatalist) return;
            console.log("Populating patient datalist...");
            patientDatalist.innerHTML = ''; // Clear existing options
            allPatients.sort((a, b) => a.name.localeCompare(b.name)).forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.name;
                option.dataset.id = patient.id; // Store ID in dataset
                patientDatalist.appendChild(option);
            });
        }

        function fetchAndRenderAssessments(patientId) {
            if (!currentUserClinicId || !patientId) return; // Added patientId check
            if (assessmentsUnsubscribe) assessmentsUnsubscribe();

            const assessmentsCollection = collection(db, "clinics", currentUserClinicId, "patients", patientId, "assessments");
            const q = query(assessmentsCollection, orderBy("createdAt", "desc")); // Order by creation time

            assessmentsUnsubscribe = onSnapshot(q, (snapshot) => {
                // Check if the patient detail view is still active for this patient
                if (selectedPatientId === patientId && document.getElementById('patient-detail-view')) {
                    const assessments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAssessmentList(assessments); // Render already sorts by date, but Firestore query is safer
                }
            }, (error) => console.error("Erro ao buscar avaliações: ", error));
        }


        function fetchAndRenderMembers() {
            if (!currentUserClinicId) return Promise.reject("No clinic ID");
            const q = query(collection(db, "users"), where("clinicId", "==", currentUserClinicId));
            console.log("Setting up members listener...");

            if (membersUnsubscribe) membersUnsubscribe();
            return new Promise((resolve, reject) => { // Return promise
                membersUnsubscribe = onSnapshot(q, (snapshot) => {
                     console.log(`Members snapshot received: ${snapshot.size} docs`);
                    clinicUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Only render if the config view is currently displayed
                    const currentMembersListDiv = document.getElementById('members-list');
                    if (!currentMembersListDiv) {
                         resolve(); // Resolve even if not rendering
                         return;
                    }

                    currentMembersListDiv.innerHTML = '<div class="space-y-2"></div>'; // Wrapper
                    const list = currentMembersListDiv.querySelector('.space-y-2');
                    if (clinicUsers.length === 0) {
                        list.innerHTML = '<p class="text-gray-500">Nenhum membro encontrado.</p>';
                    } else {
                        clinicUsers.sort((a,b) => a.email.localeCompare(b.email)).forEach(member => { // Sort by email
                            const memberId = member.id;
                            const isCurrentUser = memberId === currentUserId;

                            const memberDiv = document.createElement('div');
                            memberDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                            memberDiv.innerHTML = `
                                <div>
                                    <p class="font-semibold">${member.email} ${isCurrentUser ? '(Você)' : ''}</p>
                                    <p class="text-sm text-gray-600 capitalize">${member.role}</p>
                                </div>
                                <div class="flex gap-2">
                                   ${!isCurrentUser ? `
                                   <button data-id="${memberId}" data-email="${member.email}" data-role="${member.role}" class="change-role-btn text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Alterar Função</button>
                                   <button data-id="${memberId}" data-email="${member.email}" class="remove-member-btn text-sm bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Remover</button>
                                   ` : ''}
                                </div>
                            `;
                            list.appendChild(memberDiv);
                        });
                    }
                    resolve(); // Resolve after processing snapshot
                }, (error) => {
                    console.error("Erro ao buscar membros:", error);
                    const currentMembersListDiv = document.getElementById('members-list');
                    if(currentMembersListDiv) currentMembersListDiv.innerHTML = '<p class="text-red-500">Erro ao carregar membros. Verifique as permissões.</p>';
                    reject(error); // Reject on error
                });
            });
        }


        async function fetchAndRenderClinicData() {
             if (!currentUserClinicId) return Promise.reject("No clinic ID");
             const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
             console.log("Setting up clinic data listener...");

             // Return a promise that resolves when the first snapshot is received
             return new Promise((resolve, reject) => {
                 // Using onSnapshot to keep preferences up-to-date
                 const unsubscribe = onSnapshot(clinicDocRef, (docSnap) => { // Store unsubscribe locally
                     if (docSnap.exists()) {
                         const data = docSnap.data();
                         clinicPreferences = data.preferences || { defaultAgendaView: 'monthly', defaultServiceType: 'local' }; // Add default service type
                         currentAgendaView = clinicPreferences.defaultAgendaView; // Update current view setting if needed

                         // Only render if the config view elements are present
                         if(document.getElementById('clinic-data-display')) {
                             renderClinicDataForDisplay(data);
                         }
                         const defaultAgendaViewSelect = document.getElementById('default-agenda-view');
                         if(defaultAgendaViewSelect) {
                             defaultAgendaViewSelect.value = clinicPreferences.defaultAgendaView;
                         }
                         // NOVO: Aplicar preferência de tipo de atendimento
                         const defaultServiceTypeSelect = document.getElementById('default-service-type');
                         if(defaultServiceTypeSelect) {
                             defaultServiceTypeSelect.value = clinicPreferences.defaultServiceType || 'local';
                         }
                         resolve(); // Resolve after processing first snapshot
                     } else {
                         console.error("Documento da clínica não encontrado!");
                         reject("Clinic document not found"); // Reject if clinic doc missing
                     }
                 }, (error) => {
                      console.error("Erro ao buscar dados da clínica:", error);
                      reject(error); // Reject on error
                 });
                 // Note: This onSnapshot listener might stay active if not explicitly unsubscribed elsewhere.
                 // Consider if this is the desired behavior or if it should be unsubscribed when leaving the config view.
             });
         }



        function renderClinicDataForDisplay(data) {
            const container = document.getElementById('clinic-data-display');
            if (!container) return;

            const orDefault = (value) => value || 'Não informado';
            // NOVO: Construir endereço a partir dos campos separados
            const fullAddress = constructPatientAddress(data); 

            if (data.accountType === 'pf') {
                html = `
                    <p><strong class="detail-label">Nome:</strong> <span class="detail-value">${orDefault(data.name)}</span></p>
                    <p><strong class="detail-label">E-mail:</strong> <span class="detail-value">${orDefault(data.ownerEmail)}</span></p>
                    <p><strong class="detail-label">CPF:</strong> <span class="detail-value">${orDefault(data.cpf)}</span></p>
                    <p><strong class="detail-label">RG:</strong> <span class="detail-value">${orDefault(data.rg)}</span></p>
                    <p><strong class="detail-label">Data de Nascimento:</strong> <span class="detail-value">${orDefault(data.birthDate)}</span></p>
                    <p><strong class="detail-label">CREFITO:</strong> <span class="detail-value">${orDefault(data.crefito)}</span></p>
                    <p><strong class="detail-label">Telefone:</strong> <span class="detail-value">${orDefault(data.phone)}</span></p>
                    <p class="md:col-span-2"><strong class="detail-label">Endereço:</strong> <span class="detail-value">${orDefault(fullAddress)}</span></p>
                `;
            } else { // pj
                html = `
                    <p><strong class="detail-label">Razão Social:</strong> <span class="detail-value">${orDefault(data.name)}</span></p>
                    <p><strong class="detail-label">E-mail de Contato:</strong> <span class="detail-value">${orDefault(data.ownerEmail)}</span></p>
                    <p><strong class="detail-label">CNPJ:</strong> <span class="detail-value">${orDefault(data.cnpj)}</span></p>
                    <p><strong class="detail-label">CREFITO da Clínica:</strong> <span class="detail-value">${orDefault(data.crefito)}</span></p>
                    <p><strong class="detail-label">Telefone:</strong> <span class="detail-value">${orDefault(data.phone)}</span></p>
                    <p class="md:col-span-2"><strong class="detail-label">Endereço:</strong> <span class="detail-value">${orDefault(fullAddress)}</span></p>
                    <hr class="md:col-span-2 my-2"/>
                    <div class="md:col-span-2"><p class="font-semibold text-gray-600">Responsável Técnico</p></div>
                    <p><strong class="detail-label">Nome:</strong> <span class="detail-value">${orDefault(data.responsavelNome)}</span></p>
                    <p><strong class="detail-label">CPF:</strong> <span class="detail-value">${orDefault(data.responsavelCpf)}</span></p>
                    <p><strong class="detail-label">CREFITO:</strong> <span class="detail-value">${orDefault(data.responsavelCrefito)}</span></p>
                `;
            }
            container.innerHTML = html;
        }

        function populateClinicEditModal(data) {
            const container = document.getElementById('clinic-edit-form-fields');
            if (!container) return;

            let html = '';
            if (data.accountType === 'pf') {
                html = `
                    <input type="hidden" id="edit-accountType" value="pf">
                    <div class_name="md:col-span-2">
                        <label class="block text-sm font-medium">Nome Completo</label>
                        <input id="edit-pf-name" type="text" value="${data.name || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Data de Nascimento</label>
                        <input id="edit-pf-birthDate" type="date" value="${data.birthDate || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">RG</label>
                        <input id="edit-pf-rg" type="text" value="${data.rg || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">CPF</label>
                        <input id="edit-pf-cpf" type="text" value="${data.cpf || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">CREFITO</label>
                        <input id="edit-pf-crefito" type="text" value="${data.crefito || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <!-- Campos de Endereço Separados para Edição PF -->
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                        <div class="md:col-span-2"><input id="edit-pf-cep" type="text" placeholder="CEP" value="${data.cep || ''}" class="w-full p-2 border rounded-lg" data-form-prefix="edit-pf"></div>
                        <div class="md:col-span-4"><input id="edit-pf-street" type="text" placeholder="Rua / Endereço" value="${data.street || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-2"><input id="edit-pf-number" type="text" placeholder="Número" value="${data.number || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-4"><input id="edit-pf-neighborhood" type="text" placeholder="Bairro" value="${data.neighborhood || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-3"><input id="edit-pf-city" type="text" placeholder="Cidade" value="${data.city || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-3"><input id="edit-pf-state" type="text" placeholder="Estado (UF)" value="${data.state || ''}" class="w-full p-2 border rounded-lg"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Telefone</label>
                        <input id="edit-pf-phone" type="tel" value="${data.phone || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                `;
            } else { // pj
                html = `
                    <input type="hidden" id="edit-accountType" value="pj">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium">Razão Social</label>
                        <input id="edit-pj-razaoSocial" type="text" value="${data.name || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">CNPJ</label>
                        <input id="edit-pj-cnpj" type="text" value="${data.cnpj || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">CREFITO da Clínica</label>
                        <input id="edit-pj-crefito" type="text" value="${data.crefito || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                     <div class="md:col-span-2">
                         <label class="block text-sm font-medium">Telefone Comercial</label>
                        <input id="edit-pj-phone" type="tel" value="${data.phone || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <!-- Campos de Endereço Separados para Edição PJ -->
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                        <div class="md:col-span-2"><input id="edit-pj-cep" type="text" placeholder="CEP" value="${data.cep || ''}" class="w-full p-2 border rounded-lg" data-form-prefix="edit-pj"></div>
                        <div class="md:col-span-4"><input id="edit-pj-street" type="text" placeholder="Rua / Endereço" value="${data.street || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-2"><input id="edit-pj-number" type="text" placeholder="Número" value="${data.number || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-4"><input id="edit-pj-neighborhood" type="text" placeholder="Bairro" value="${data.neighborhood || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-3"><input id="edit-pj-city" type="text" placeholder="Cidade" value="${data.city || ''}" class="w-full p-2 border rounded-lg"></div>
                        <div class="md:col-span-3"><input id="edit-pj-state" type="text" placeholder="Estado (UF)" value="${data.state || ''}" class="w-full p-2 border rounded-lg"></div>
                    </div>
                    <hr class="md:col-span-2 my-2"/>
                    <div class="md:col-span-2"><p class="text-sm font-semibold text-gray-600">Dados do Responsável Técnico</p></div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium">Nome do Responsável</label>
                        <input id="edit-pj-responsavel" type="text" value="${data.responsavelNome || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">CPF do Responsável</label>
                        <input id="edit-pj-responsavel-cpf" type="text" value="${data.responsavelCpf || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                         <label class="block text-sm font-medium">CREFITO do Responsável</label>
                        <input id="edit-pj-responsavel-crefito" type="text" value="${data.responsavelCrefito || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderAllPayments(payments) {
            const tableBody = mainContentContainer.querySelector('#payments-table-body');
            if (!tableBody) return;

            if (payments.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Nenhum lançamento financeiro encontrado.</td></tr>`;
                 return;
            }

            tableBody.innerHTML = '';
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';

                const statusClass = payment.status === 'pago' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';

                row.innerHTML = `
                    <td class="px-6 py-4">${new Date(payment.date + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${payment.patientName}</td>
                    <td class="px-6 py-4">R$ ${Number(payment.value).toFixed(2).replace('.',',')}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${payment.status}</span>
                    </td>
                    <td class="px-6 py-4">
                         <button data-id="${payment.id}" class="edit-payment-btn text-blue-600 hover:underline">Editar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderRoomsList(rooms) {
            const roomsListDiv = document.getElementById('rooms-list');
            if (!roomsListDiv) return;

            if (rooms.length === 0) {
                roomsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma sala de atendimento cadastrada.</p>';
                return;
            }

            // Sort rooms by name client-side
            rooms.sort((a, b) => a.name.localeCompare(b.name));

            roomsListDiv.innerHTML = ''; // Clear previous list
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                roomDiv.innerHTML = `
                    <div>
                        <p class="font-semibold">${room.name}</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${room.id}" data-name="${room.name}" class="edit-room-btn text-sm bg-yellow-100 text-yellow-700 font-semibold py-1 px-3 rounded-lg hover:bg-yellow-200">Editar</button>
                        <button data-id="${room.id}" data-name="${room.name}" class="delete-room-btn text-sm bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Excluir</button>
                    </div>
                `;
                roomsListDiv.appendChild(roomDiv);
            });
        }
        
        // NOVO: Função para controlar campos do modal de agendamento
        function toggleAppointmentFields(type) {
            const salaContainer = document.getElementById('sala-container');
            const domiciliarContainer = document.getElementById('domiciliar-container');
            const salaSelect = document.getElementById('appointment-room');
            
            // Campos de endereço
            const cepInput = document.getElementById('appointment-cep');
            const streetInput = document.getElementById('appointment-street');
            const numberInput = document.getElementById('appointment-number');
            const neighborhoodInput = document.getElementById('appointment-neighborhood');
            const cityInput = document.getElementById('appointment-city');
            const stateInput = document.getElementById('appointment-state');

            if (!salaContainer || !domiciliarContainer || !salaSelect || !cepInput || !streetInput || !numberInput || !neighborhoodInput || !cityInput || !stateInput) {
                console.error("Campos do modal de agendamento não encontrados!");
                return; 
            }
            
            const fields = [cepInput, streetInput, numberInput, neighborhoodInput, cityInput, stateInput];

            if (type === 'local') {
                salaContainer.classList.remove('hidden');
                domiciliarContainer.classList.add('hidden');
                salaSelect.required = true;
                // Campos de endereço não são obrigatórios
                fields.forEach(field => field.required = false);
            } else { // 'domiciliar'
                salaContainer.classList.add('hidden');
                domiciliarContainer.classList.remove('hidden');
                salaSelect.required = false;
                // Campos de endereço são obrigatórios
                fields.forEach(field => field.required = true);
                
                // Pre-fill address
                const patientId = document.getElementById('appointment-patient-id').value;
                if (patientId) {
                    const patient = allPatients.find(p => p.id === patientId);
                    if (patient) {
                        cepInput.value = patient.cep || '';
                        streetInput.value = patient.street || '';
                        numberInput.value = patient.number || '';
                        neighborhoodInput.value = patient.neighborhood || '';
                        cityInput.value = patient.city || '';
                        stateInput.value = patient.state || '';
                    } else {
                        // Clear fields if patient not found (shouldn't happen)
                        fields.forEach(field => field.value = '');
                    }
                } else {
                     // Clear fields if no patient selected
                     fields.forEach(field => field.value = '');
                }
            }
        }


        // --- GLOBAL EVENT LISTENER ---
        document.body.addEventListener('click', async (e) => {
            // Early exit if not logged in (except for password change)
            if (!currentUserClinicId && !e.target.closest('#force-password-change-form')) return;

            // Delegate event handling
            const target = e.target;
            
             // --- NOVO: Listener para os radio buttons do tipo de atendimento ---
             // (Movido para listener 'change' separado para melhor confiabilidade)

            // --- AGENDA ACTIONS (Prioritize specific clicks) ---
            if (target.closest('.appointment-item[data-appointment-id]')) { // Click on existing appointment
                e.stopPropagation(); // Prevent click from bubbling up to the day cell
                const appointmentId = target.closest('.appointment-item').dataset.appointmentId;
                openAppointmentDetailModal(appointmentId);
            } else if (target.closest('.calendar-day[data-date]') || target.closest('[data-date]:not(.appointment-item)')) { // Click on empty day/cell
                 // Check if the click was *not* on an appointment item inside the day cell
                 // This check is implicitly handled by the 'else if' structure
                const dateElement = target.closest('[data-date]');
                if (dateElement && dateElement.dataset.date) {
                   const date = dateElement.dataset.date;
                   openAppointmentDetailModal(null, date); // Pass null ID for new appointment on this date
                }
            } else if (target.closest('#quick-add-appointment-btn')) {
                 openAppointmentDetailModal(null, getDateString(new Date())); // Open new for today
            } else if (target.closest('#add-appointment-agenda-btn')) {
               // Botão na agenda usa a data atual da view se for diária, senão usa hoje
               const defaultDate = (currentAgendaView === 'daily') ? getDateString(currentDate) : getDateString(new Date());
               openAppointmentDetailModal(null, defaultDate);
            } else if (target.closest('#delete-appointment-btn')) { // Handle delete button inside modal
                const appointmentId = document.getElementById('appointment-id').value;
                if (appointmentId) {
                   showConfirmation('Excluir Agendamento', 'Tem certeza que deseja excluir este agendamento?', async () => {
                        showLoading();
                       try {
                           await deleteDoc(doc(db, 'clinics', currentUserClinicId, 'appointments', appointmentId));
                           closeModal(appointmentModal); // Close modal after deletion
                       } catch (error) {
                           console.error("Erro ao excluir agendamento:", error);
                           alert("Erro ao excluir agendamento."); // Inform user
                       } finally {
                            hideLoading();
                       }
                   });
                }
            }
            // --- PATIENT LIST ACTIONS ---
            else if (target.closest('.view-details-btn')) {
                selectedPatientId = target.closest('.view-details-btn').dataset.id;
                const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId);
                try {
                    showLoading(); // Show loading while fetching details
                    const patientDocSnap = await getDoc(patientDocRef);
                    if (patientDocSnap.exists()) {
                        // Find the elements within the current mainContentContainer
                        const listView = mainContentContainer.querySelector('#patient-list-view');
                        const detailView = mainContentContainer.querySelector('#patient-detail-view');
                        if (listView) listView.classList.remove('active'); // Use active class
                        if (detailView) {
                            detailView.classList.add('active'); // Use active class
                             renderPatientDetails({id: selectedPatientId, ...patientDocSnap.data()});
                             await fetchAndRenderAssessments(selectedPatientId); // Fetch assessments for this patient
                        }
                    } else {
                        console.error("Paciente não encontrado:", selectedPatientId);
                    }
                } catch (error) {
                    console.error("Erro ao buscar detalhes do paciente:", error);
                } finally {
                    hideLoading(); // Hide loading after details are fetched
                }
            } else if (target.closest('.edit-patient-btn')) {
                const patientId = target.closest('.edit-patient-btn').dataset.id;
                const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                 try {
                    const docSnap = await getDoc(patientDocRef);
                    if (docSnap.exists()) {
                        const patient = docSnap.data();
                        document.getElementById('patient-modal-title').innerText = 'Editar Paciente';
                        document.getElementById('patient-id').value = patientId;
                        document.getElementById('patient-name').value = patient.name || '';
                        document.getElementById('patient-cpf').value = patient.cpf || '';
                        document.getElementById('patient-birthDate').value = patient.birthDate || '';
                        document.getElementById('patient-gender').value = patient.gender || '';
                        document.getElementById('patient-phone').value = patient.phone || '';
                        // NOVO: Preencher campos de endereço separados
                        document.getElementById('patient-cep').value = patient.cep || '';
                        document.getElementById('patient-street').value = patient.street || '';
                        document.getElementById('patient-number').value = patient.number || '';
                        document.getElementById('patient-neighborhood').value = patient.neighborhood || '';
                        document.getElementById('patient-city').value = patient.city || '';
                        document.getElementById('patient-state').value = patient.state || '';
                        // FIM NOVO
                        document.getElementById('patient-observations').value = patient.observations || '';
                        openModal(patientModal);
                    }
                 } catch (error) {
                      console.error("Erro ao buscar paciente para edição:", error);
                 }
            } else if (target.closest('.delete-patient-btn')) {
                const patientId = target.closest('.delete-patient-btn').dataset.id;
                showConfirmation('Excluir Paciente', 'Isso excluirá o paciente e todas as suas avaliações. Continuar?', () => {
                    const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                    deleteDoc(patientDocRef).catch(error => console.error("Erro ao excluir paciente:", error));
                });
            } else if (target.closest('#add-patient-btn') || target.closest('#quick-add-patient-btn')) {
                document.getElementById('patient-form').reset();
                document.getElementById('patient-id').value = '';
                document.getElementById('patient-modal-title').innerText = 'Adicionar Novo Paciente';
                openModal(patientModal);
            }
            // --- PATIENT DETAIL ACTIONS ---
            else if (target.closest('#back-to-list-btn')) {
                const detailView = mainContentContainer.querySelector('#patient-detail-view');
                const listView = mainContentContainer.querySelector('#patient-list-view');
                if(detailView) detailView.classList.remove('active'); // Use active class
                if(listView) listView.classList.add('active'); // Use active class
                if(assessmentsUnsubscribe) { assessmentsUnsubscribe(); assessmentsUnsubscribe = null; } // Unsubscribe when leaving detail view
                selectedPatientId = null;
            } else if (target.closest('#add-assessment-btn')) {
                 if(!selectedPatientId) return; // Should not happen if button is visible
                document.getElementById('assessment-form').reset();
                // Reset conditional fields
                document.querySelector('#dor-local-container')?.classList.add('hidden'); // Use optional chaining
                document.querySelector('#edema-local-container')?.classList.add('hidden'); // Use optional chaining
                // Reset tabs to first
                assessmentModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                assessmentModal.querySelector('[data-tab="tab1"]')?.classList.add('active'); // Use optional chaining
                assessmentModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                assessmentModal.querySelector('#tab1')?.classList.remove('hidden'); // Use optional chaining
                openModal(assessmentModal);
            } else if (target.closest('.view-assessment-btn')) {
                if(!selectedPatientId) return;
                const assessmentId = target.closest('.view-assessment-btn').dataset.id;
                const assessmentDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId, 'assessments', assessmentId);
                 try {
                    const docSnap = await getDoc(assessmentDocRef);
                    if (docSnap.exists()) {
                        populateAssessmentDetailModal(docSnap.data());
                         // Reset tabs to first
                        assessmentDetailModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        assessmentDetailModal.querySelector('[data-tab="detail-tab1"]')?.classList.add('active'); // Use optional chaining
                        assessmentDetailModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                        assessmentDetailModal.querySelector('#detail-tab1')?.classList.remove('hidden'); // Use optional chaining
                        openModal(assessmentDetailModal);
                    } else {
                         console.error("Avaliação não encontrada:", assessmentId);
                    }
                } catch(error) {
                     console.error("Erro ao buscar detalhes da avaliação:", error);
                }
            }
            // --- SETTINGS ACTIONS ---
            else if (target.closest('.change-role-btn')) {
                document.getElementById('change-role-user-id').value = target.closest('.change-role-btn').dataset.id;
                document.getElementById('change-role-user-email').textContent = target.closest('.change-role-btn').dataset.email;
                document.getElementById('change-role-select').value = target.closest('.change-role-btn').dataset.role;
                openModal(changeRoleModal);
            } else if (target.closest('.remove-member-btn')) {
                const userIdToRemove = target.closest('.remove-member-btn').dataset.id;
                const userEmail = target.closest('.remove-member-btn').dataset.email;
                showConfirmation('Remover Membro', `Tem certeza que deseja remover ${userEmail} da clínica?`, async () => {
                     showLoading();
                    try {
                        const userDocRef = doc(db, 'users', userIdToRemove);
                        const clinicDocRef = doc(db, 'clinics', currentUserClinicId);

                        await updateDoc(clinicDocRef, {
                            members: arrayRemove(userIdToRemove),
                            [`roles.${userIdToRemove}`]: deleteField()
                        });

                        await updateDoc(userDocRef, {
                            clinicId: null,
                            role: null
                        });
                    } catch (error) {
                        console.error("Erro ao remover membro:", error);
                        alert("Erro ao remover membro.");
                    } finally {
                         hideLoading();
                    }
                });
            } else if (target.closest('#edit-clinic-data-btn')) {
                const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
                 try {
                     showLoading();
                    const clinicDocSnap = await getDoc(clinicDocRef);
                    if (clinicDocSnap.exists()) {
                        populateClinicEditModal(clinicDocSnap.data());
                        openModal(clinicEditModal);
                    }
                 } catch (error) {
                     console.error("Erro ao buscar dados da clínica para edição:", error);
                 } finally {
                      hideLoading();
                 }
            } else if (target.closest('#add-payment-btn')) {
                 document.getElementById('financial-record-form').reset();
                 document.getElementById('financial-record-id').value = '';
                 document.getElementById('financial-modal-title').innerText = 'Lançar Pagamento';
                 populatePatientDatalist(); // Ensure datalist is ready
                 document.getElementById('financial-date').valueAsDate = new Date(); // Set default date to today
                 openModal(financialRecordModal);
            } else if (target.closest('#add-room-btn')) {
                document.getElementById('room-form').reset();
                document.getElementById('room-id').value = '';
                document.getElementById('room-modal-title').textContent = 'Adicionar Nova Sala';
                openModal(roomModal);
            } else if (target.closest('.edit-room-btn')) {
                const roomId = target.closest('.edit-room-btn').dataset.id;
                const roomName = target.closest('.edit-room-btn').dataset.name;
                document.getElementById('room-form').reset();
                document.getElementById('room-id').value = roomId;
                document.getElementById('room-name').value = roomName;
                document.getElementById('room-modal-title').textContent = 'Editar Sala';
                openModal(roomModal);
            } else if (target.closest('.delete-room-btn')) {
                const roomId = target.closest('.delete-room-btn').dataset.id;
                const roomName = target.closest('.delete-room-btn').dataset.name;
                showConfirmation('Excluir Sala', `Tem certeza que deseja excluir a sala "${roomName}"?`, async () => {
                     showLoading();
                    try {
                        await deleteDoc(doc(db, 'clinics', currentUserClinicId, 'rooms', roomId));
                    } catch (error) {
                        console.error("Erro ao excluir sala:", error);
                        alert("Erro ao excluir sala.");
                    } finally {
                         hideLoading();
                    }
                });
            } else if (target.closest('#save-preferences-btn')) {
                handleSavePreferences(); // Call dedicated handler
            }
        });

        // --- FORM SUBMISSIONS ---
        document.getElementById('patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const patientId = document.getElementById('patient-id').value;
            const patientData = {
                name: document.getElementById('patient-name').value, 
                cpf: document.getElementById('patient-cpf').value, 
                birthDate: document.getElementById('patient-birthDate').value,
                gender: document.getElementById('patient-gender').value, 
                phone: document.getElementById('patient-phone').value, 
                caregiver: document.getElementById('patient-caregiver').value, 
                observations: document.getElementById('patient-observations').value,
                // NOVO: Salvar campos de endereço separados
                cep: document.getElementById('patient-cep').value,
                street: document.getElementById('patient-street').value,
                number: document.getElementById('patient-number').value,
                neighborhood: document.getElementById('patient-neighborhood').value,
                city: document.getElementById('patient-city').value,
                state: document.getElementById('patient-state').value,
                address: constructPatientAddress({ // Salvar uma versão completa para referência rápida
                    street: document.getElementById('patient-street').value,
                    number: document.getElementById('patient-number').value,
                    neighborhood: document.getElementById('patient-neighborhood').value,
                    city: document.getElementById('patient-city').value,
                    state: document.getElementById('patient-state').value
                })
            };
            try {
                showLoading();
                if (patientId) {
                    const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                    await setDoc(patientDocRef, patientData, { merge: true });
                } else {
                    patientData.createdAt = serverTimestamp();
                    const patientsCollection = collection(db, 'clinics', currentUserClinicId, 'patients');
                    await addDoc(patientsCollection, patientData);
                }
                closeModal(patientModal);
            } catch (error) {
                 console.error("Erro ao salvar paciente:", error);
                 alert("Erro ao salvar paciente.");
            } finally {
                 hideLoading();
            }
        });

        document.getElementById('assessment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedPatientId) {
                alert("Nenhum paciente selecionado para adicionar evolução.");
                return;
            }
            showLoading();
            const barreiras = Array.from(document.querySelectorAll('input[name="barreiras"]:checked')).map(el => el.value);
            const assessmentData = {
                diagMedico: document.getElementById('diag-medico').value, comorbidades: document.getElementById('comorbidades').value, medicacoes: document.getElementById('medicacoes').value,
                cirurgias: document.getElementById('cirurgias').value, queixas: document.getElementById('queixas').value, dorEva: document.getElementById('dor-eva').value,
                dorLocal: document.getElementById('dor-local').value, habitos: document.getElementById('habitos').value,
                consciencia: document.getElementById('consciencia').value, orientacao: document.getElementById('orientacao').value, comunicacao: document.getElementById('comunicacao').value,
                postura: document.getElementById('postura').value, marcha: document.getElementById('marcha').value, equilibrio: document.getElementById('equilibrio').value, adm: document.getElementById('adm').value,
                forca: document.getElementById('forca').value, tonus: document.getElementById('tonus').value, coordenacao: document.getElementById('coordenacao').value, sensibilidade: document.getElementById('sensibilidade').value,
                edema: document.getElementById('edema').value, edemaLocal: document.getElementById('edema-local').value, testesRealizados: document.getElementById('testes-realizados').value,
                banho: document.querySelector('input[name="banho"]:checked')?.value || '', vestir: document.querySelector('input[name="vestir"]:checked')?.value || '',
                alimentacao: document.querySelector('input[name="alimentacao"]:checked')?.value || '', continencia: document.querySelector('input[name="continencia"]:checked')?.value || '',
                fraldas: document.querySelector('input[name="fraldas"]:checked')?.value || '', transferencias: document.getElementById('transferencias').value, deambulacao: document.getElementById('deambulacao').value,
                residencia: document.querySelector('input[name="residencia"]:checked')?.value || '', iluminacao: document.querySelector('input[name="iluminacao"]:checked')?.value || '',
                espaco: document.querySelector('input[name="espaco"]:checked')?.value || '', barreiras,
                objetivos: document.getElementById('objetivos').value,
                createdAt: serverTimestamp(),
            };

             try {
                const assessmentsCol = collection(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId, 'assessments');
                await addDoc(assessmentsCol, assessmentData);
                closeModal(assessmentModal);
             } catch (error) {
                  console.error("Erro ao salvar evolução:", error);
                 alert("Erro ao salvar evolução.");
             } finally {
                  hideLoading();
             }
        });

        document.getElementById('appointment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const appointmentId = document.getElementById('appointment-id').value; // Get ID for editing
            const patientInput = document.getElementById('appointment-patient-input');
            let patientId = document.getElementById('appointment-patient-id').value; // Get ID from hidden input first
            const patientName = patientInput.value; // Name from the input

             // Validate Patient Selection from Datalist more robustly
            if (!patientId || !allPatients.some(p => p.id === patientId && p.name === patientName)) {
                 // Try to find based on name again, just in case
                 const foundPatient = allPatients.find(p => p.name.toLowerCase() === patientName.toLowerCase());
                 if (!foundPatient) {
                     alert("Paciente inválido ou não encontrado na lista. Por favor, selecione um paciente válido.");
                     return;
                 }
                 patientId = foundPatient.id; // Correct the ID if found
            }


            const professionalId = document.getElementById('appointment-professional').value;
            const professionalName = document.getElementById('appointment-professional').options[document.getElementById('appointment-professional').selectedIndex]?.text || ''; // Safety check
            const serviceType = document.querySelector('input[name="serviceType"]:checked').value;

             if (!professionalId) {
                 alert("Por favor, selecione um profissional.");
                 return;
             }

            // Base data object
            const appointmentData = {
                patientId, patientName, professionalId, professionalName,
                date: document.getElementById('appointment-date').value,
                time: document.getElementById('appointment-time').value,
                duration: document.getElementById('appointment-duration').value,
                notes: document.getElementById('appointment-notes').value,
                status: 'agendado',
                serviceType: serviceType,
            };

            // Add service-specific data
            if (serviceType === 'local') {
                appointmentData.roomId = document.getElementById('appointment-room').value;
                appointmentData.roomName = document.getElementById('appointment-room').options[document.getElementById('appointment-room').selectedIndex]?.text || '';
                 if (!appointmentData.roomId) {
                     alert("Por favor, selecione uma sala para atendimento local.");
                     return;
                 }
                 appointmentData.addressDetails = null; // Ensure address is null
                 appointmentData.address = null; // Keep the simple address field null too
            } else { // domiciliar
                 const addressDetails = {
                    cep: document.getElementById('appointment-cep').value,
                    street: document.getElementById('appointment-street').value,
                    number: document.getElementById('appointment-number').value,
                    neighborhood: document.getElementById('appointment-neighborhood').value,
                    city: document.getElementById('appointment-city').value,
                    state: document.getElementById('appointment-state').value,
                };
                
                // Validate required domiciliar fields
                if (!addressDetails.street || !addressDetails.number || !addressDetails.city) {
                     alert("Por favor, preencha os campos de endereço (Rua, Número, Cidade) para atendimento domiciliar.");
                     return;
                }
                
                 appointmentData.addressDetails = addressDetails; // Save the detailed object
                 appointmentData.address = constructPatientAddress(addressDetails); // Save the constructed string for display
                 appointmentData.roomId = null; // Ensure room is null
                 appointmentData.roomName = 'Domiciliar'; // Or use the address? Let's use 'Domiciliar' for clarity.
            }


            const appointmentsCol = collection(db, 'clinics', currentUserClinicId, 'appointments');

            try {
                showLoading(); // Show loading indicator
                if (appointmentId) {
                    // Update existing appointment
                    const appointmentDocRef = doc(appointmentsCol, appointmentId);
                    await updateDoc(appointmentDocRef, appointmentData);
                } else {
                    // Create new appointment
                    appointmentData.createdAt = serverTimestamp();
                    await addDoc(appointmentsCol, appointmentData);
                }
                closeModal(appointmentModal);
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                alert("Erro ao salvar agendamento. Tente novamente."); // Inform user
            } finally {
                 hideLoading(); // Hide loading indicator regardless of success/error
            }
        });

        document.getElementById('financial-record-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             const patientInput = document.getElementById('financial-patient-input');
             let patientId = document.getElementById('financial-patient-id').value;
             const patientName = patientInput.value;
             const recordId = document.getElementById('financial-record-id').value;

             // Validate Patient Selection from Datalist more robustly
              if (!patientId || !allPatients.some(p => p.id === patientId && p.name === patientName)) {
                 const foundPatient = allPatients.find(p => p.name.toLowerCase() === patientName.toLowerCase());
                 if (!foundPatient) {
                     alert("Paciente inválido ou não encontrado na lista. Por favor, selecione um paciente válido.");
                     return;
                 }
                 patientId = foundPatient.id;
             }

             const paymentData = {
                 patientId, patientName,
                 date: document.getElementById('financial-date').value,
                 value: document.getElementById('financial-value').value,
                 status: document.getElementById('financial-status').value,
                 description: document.getElementById('financial-description').value,
             };

             const paymentsCol = collection(db, 'clinics', currentUserClinicId, 'payments');

             try {
                 showLoading();
                 if (recordId) {
                    // await updateDoc(doc(paymentsCol, recordId), paymentData); // Edição (Implement if needed)
                 } else {
                    paymentData.createdAt = serverTimestamp();
                    await addDoc(paymentsCol, paymentData);
                 }
                 closeModal(financialRecordModal);
             } catch (error) {
                  console.error("Erro ao salvar lançamento financeiro:", error);
                  alert("Erro ao salvar lançamento. Tente novamente.");
             } finally {
                 hideLoading();
             }
        });

        // Event listeners for datalist inputs to update hidden ID
        // Needs to be attached to the body because inputs are created/destroyed with views
        document.body.addEventListener('input', (e) => {
             if (e.target.id === 'appointment-patient-input' || e.target.id === 'financial-patient-input') {
                 handlePatientInput(e);
             }
        });

        // NOVO: Event listener para campos CEP (usando 'blur')
         document.body.addEventListener('blur', (e) => {
            const target = e.target;
            const prefix = target.dataset.formPrefix; // Get prefix from data attribute

            if (prefix) {
                // Determine the correct modal/form based on prefix
                let formId = '';
                if (prefix === 'patient') formId = '#patient-modal';
                else if (prefix === 'pf') formId = '#register-container';
                else if (prefix === 'pj') formId = '#register-container';
                else if (prefix === 'edit-pf') formId = '#clinic-edit-modal';
                else if (prefix === 'edit-pj') formId = '#clinic-edit-modal';
                else if (prefix === 'appointment') formId = '#appointment-modal';
                
                // Only run fetch if the CEP field is inside the currently visible modal/form
                const activeContainer = document.querySelector(formId);
                if (activeContainer && !activeContainer.classList.contains('hidden')) {
                     fetchAddressFromCEP(target.value, prefix);
                }
            }
        }, true); // Use capture phase to ensure it runs


        document.getElementById('room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomId = document.getElementById('room-id').value;
            const roomName = document.getElementById('room-name').value;

            if (!roomName) return;

            const roomData = { name: roomName };
            const roomsCol = collection(db, 'clinics', currentUserClinicId, 'rooms');

            try {
                showLoading();
                if (roomId) {
                    // Update existing room
                    const roomDocRef = doc(roomsCol, roomId);
                    await updateDoc(roomDocRef, roomData);
                } else {
                    // Create new room
                    roomData.createdAt = serverTimestamp();
                    await addDoc(roomsCol, roomData);
                }
                closeModal(roomModal);
            } catch (error) {
                console.error("Erro ao salvar sala:", error);
                alert("Erro ao salvar sala. Tente novamente.");
            } finally {
                hideLoading();
            }
        });

        document.getElementById('change-role-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userIdToChange = document.getElementById('change-role-user-id').value;
            const newRole = document.getElementById('change-role-select').value;

            const userDocRef = doc(db, 'users', userIdToChange);
            const clinicDocRef = doc(db, 'clinics', currentUserClinicId);

            try {
                showLoading();
                await updateDoc(userDocRef, { role: newRole });
                await updateDoc(clinicDocRef, { [`roles.${userIdToChange}`]: newRole });
                closeModal(changeRoleModal);
            } catch(error) {
                 console.error("Erro ao alterar função:", error);
                 alert("Erro ao alterar função. Tente novamente.");
            } finally {
                hideLoading();
            }
        });

        document.getElementById('clinic-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            let updatedData = {};
            const accountType = document.getElementById('edit-accountType').value;

            if (accountType === 'pf') {
                updatedData = {
                    name: document.getElementById('edit-pf-name').value,
                    birthDate: document.getElementById('edit-pf-birthDate').value,
                    rg: document.getElementById('edit-pf-rg').value,
                    cpf: document.getElementById('edit-pf-cpf').value,
                    crefito: document.getElementById('edit-pf-crefito').value,
                    phone: document.getElementById('edit-pf-phone').value,
                    // NOVO: Salvar campos de endereço separados
                    cep: document.getElementById('edit-pf-cep').value,
                    street: document.getElementById('edit-pf-street').value,
                    number: document.getElementById('edit-pf-number').value,
                    neighborhood: document.getElementById('edit-pf-neighborhood').value,
                    city: document.getElementById('edit-pf-city').value,
                    state: document.getElementById('edit-pf-state').value,
                };
                 // Construir a string de endereço completa
                 updatedData.address = constructPatientAddress(updatedData);
            } else { // pj
                updatedData = {
                    name: document.getElementById('edit-pj-razaoSocial').value,
                    cnpj: document.getElementById('edit-pj-cnpj').value,
                    crefito: document.getElementById('edit-pj-crefito').value,
                    phone: document.getElementById('edit-pj-phone').value,
                    responsavelNome: document.getElementById('edit-pj-responsavel').value,
                    responsavelCpf: document.getElementById('edit-pj-responsavel-cpf').value,
                    responsavelCrefito: document.getElementById('edit-pj-responsavel-crefito').value,
                     // NOVO: Salvar campos de endereço separados
                    cep: document.getElementById('edit-pj-cep').value,
                    street: document.getElementById('edit-pj-street').value,
                    number: document.getElementById('edit-pj-number').value,
                    neighborhood: document.getElementById('edit-pj-neighborhood').value,
                    city: document.getElementById('edit-pj-city').value,
                    state: document.getElementById('edit-pj-state').value,
                };
                 // Construir a string de endereço completa
                 updatedData.address = constructPatientAddress(updatedData);
            }

            try {
                showLoading();
                const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
                await updateDoc(clinicDocRef, updatedData);
                closeModal(clinicEditModal);
            } catch (error) {
                console.error("Erro ao atualizar dados da clínica:", error);
                alert("Erro ao atualizar dados da clínica. Tente novamente.");
            } finally {
                hideLoading();
            }
        });

        // --- NAVIGATION & VIEW CONTROL ---
        function switchView(viewName) {
            console.log(`Switching view to: ${viewName}`);
            showLoading(); // Show loading when switching views

            // Clean up previous listeners BEFORE changing content
            // Detach listeners from their respective collections
            if (patientsUnsubscribe) { console.log("Unsubscribing patients"); patientsUnsubscribe(); patientsUnsubscribe = null; }
            if (appointmentsUnsubscribe) { console.log("Unsubscribing agenda appointments"); appointmentsUnsubscribe(); appointmentsUnsubscribe = null; }
            if (paymentsUnsubscribe) { console.log("Unsubscribing payments"); paymentsUnsubscribe(); paymentsUnsubscribe = null; }
            if (membersUnsubscribe) { console.log("Unsubscribing members"); membersUnsubscribe(); membersUnsubscribe = null; }
            if (roomsUnsubscribe) { console.log("Unsubscribing rooms"); roomsUnsubscribe(); roomsUnsubscribe = null; }
             if (dashboardAppointmentsUnsubscribe) { console.log("Unsubscribing dashboard appointments"); dashboardAppointmentsUnsubscribe(); dashboardAppointmentsUnsubscribe = null; }
             if (assessmentsUnsubscribe) { console.log("Unsubscribing assessments"); assessmentsUnsubscribe(); assessmentsUnsubscribe = null;} // Cleanup assessment listener too


            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(`nav-${viewName}`);
            if (activeLink) activeLink.classList.add('active');

            // Hide all page content divs
            mainContentContainer.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active'); // Use 'active' class to control visibility
            });

            const targetPage = document.getElementById(`page-${viewName}`);
            if(targetPage) {
                targetPage.classList.add('active'); // Show the target page
                console.log(`Page ${viewName} activated.`);
            } else {
                 console.error(`Page #page-${viewName} not found!`);
                 hideLoading(); // Hide loading if template not found
                 return;
            }

            // Re-fetch necessary data and setup listeners for the new view
             // Using Promise.allSettled to fetch initial data concurrently but wait for all before hiding loading
             const fetchDataPromises = [];

             // Always ensure core data is available if not already loaded (might be redundant if onAuthStateChanged handles it well)
             if (!initialDataLoaded) {
                 console.warn("Initial data not marked as loaded, attempting fetch within switchView");
                 // This shouldn't ideally happen if onAuthStateChanged completes first
                 // fetchDataPromises.push(fetchAndRenderMembers(), fetchAndRenderRooms(), fetchAndRenderPatients());
             }


             if (viewName === 'inicio') {
                 fetchDataPromises.push(fetchAndRenderDashboardData());
             } else if (viewName === 'pacientes') {
                 // Patients should already be fetched or being fetched by the initial load or listener
                 if(allPatients.length > 0) renderPatientList(allPatients); // Render immediately if available
                 else fetchDataPromises.push(fetchAndRenderPatients()); // Fetch if not available
                 const searchInput = mainContentContainer.querySelector('#search-patient');
                 if (searchInput) {
                     // Use replaceWith to ensure listener cleanup
                     const newSearchInput = searchInput.cloneNode(true);
                     searchInput.parentNode.replaceChild(newSearchInput, searchInput);
                     newSearchInput.addEventListener('input', handlePatientSearch);
                 }
             } else if (viewName === 'agenda') {
                 currentAgendaView = clinicPreferences.defaultAgendaView; // Reset to preference
                 setupAgendaListeners(); // Add listeners for buttons
                 fetchDataPromises.push(updateAgenda()); // Initial render for the view, starts fetching appointments
             } else if(viewName === 'financeiro') {
                 populatePatientDatalist(); // Ensure datalist is ready immediately if possible
                 fetchDataPromises.push(fetchAndRenderAllPayments());
                  // Add listener for the datalist input (needs cleanup like search)
                  const finPatientInput = document.getElementById('financial-patient-input');
                  if(finPatientInput) {
                      const newFinInput = finPatientInput.cloneNode(true);
                      finPatientInput.parentNode.replaceChild(newFinInput, finPatientInput);
                      newFinInput.addEventListener('input', handlePatientInput);
                  }

             } else if (viewName === 'configuracoes') {
                 const adminView = mainContentContainer.querySelector('#admin-view');
                 const nonAdminView = mainContentContainer.querySelector('#non-admin-view');
                 if (currentUserRole === 'admin') {
                     if(nonAdminView) nonAdminView.classList.add('hidden'); // Keep hidden/show logic for admin view itself
                     if(adminView) adminView.classList.remove('hidden');
                     // Fetch data needed for this view (listeners might already be active from initial load)
                     fetchDataPromises.push(fetchAndRenderClinicData()); // Re-render clinic data display
                     if(clinicUsers.length > 0) renderMembersList(clinicUsers); else fetchDataPromises.push(fetchAndRenderMembers()); // Render if available, else fetch
                     if(clinicRooms.length > 0) renderRoomsList(clinicRooms); else fetchDataPromises.push(fetchAndRenderRooms()); // Render if available, else fetch


                     // Setup form listeners
                     const createUserForm = mainContentContainer.querySelector('#create-user-form');
                     if(createUserForm) {
                         const newForm = createUserForm.cloneNode(true);
                         createUserForm.parentNode.replaceChild(newForm, createUserForm);
                         newForm.addEventListener('submit', handleCreateUser);
                     }
                      const savePrefsBtn = document.getElementById('save-preferences-btn');
                      if(savePrefsBtn) {
                           // Use cloneNode/replaceChild to reset listeners on preference save button too
                          const newBtn = savePrefsBtn.cloneNode(true);
                          savePrefsBtn.parentNode.replaceChild(newBtn, savePrefsBtn);
                          newBtn.addEventListener('click', handleSavePreferences);
                      }
                 } else {
                      if(adminView) adminView.classList.add('hidden');
                     if(nonAdminView) nonAdminView.classList.remove('hidden');
                 }
             }
              // Ensure patient input listener is attached if appointment modal might open from this view
              const appPatientInput = document.getElementById('appointment-patient-input');
              if(appPatientInput) {
                   const newAppInput = appPatientInput.cloneNode(true);
                   appPatientInput.parentNode.replaceChild(newAppInput, appPatientInput);
                   newAppInput.addEventListener('input', handlePatientInput);
              }

              // Hide loading overlay once all initial data for the view seems loaded
             Promise.allSettled(fetchDataPromises).then((results) => {
                 console.log(`Initial data fetch/render for ${viewName} settled.`);
                 hideLoading();
             }).catch(err => {
                 console.error(`Error during initial data fetch/render for ${viewName}:`, err);
                 hideLoading(); // Still hide loading on error
             });
        }
        
        // Added wrapper for renderMembersList for consistency with settings view logic
        function renderMembersList(users) {
            const currentMembersListDiv = document.getElementById('members-list');
             if (!currentMembersListDiv) return;

             currentMembersListDiv.innerHTML = '<div class="space-y-2"></div>'; // Wrapper
             const list = currentMembersListDiv.querySelector('.space-y-2');
             if (users.length === 0) {
                 list.innerHTML = '<p class="text-gray-500">Nenhum membro encontrado.</p>';
             } else {
                 users.sort((a,b) => a.email.localeCompare(b.email)).forEach(member => { // Sort by email
                     const memberId = member.id;
                     const isCurrentUser = memberId === currentUserId;

                     const memberDiv = document.createElement('div');
                     memberDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                     memberDiv.innerHTML = `
                         <div>
                             <p class="font-semibold">${member.email} ${isCurrentUser ? '(Você)' : ''}</p>
                             <p class="text-sm text-gray-600 capitalize">${member.role}</p>
                         </div>
                         <div class="flex gap-2">
                            ${!isCurrentUser ? `
                            <button data-id="${memberId}" data-email="${member.email}" data-role="${member.role}" class="change-role-btn text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Alterar Função</button>
                            <button data-id="${memberId}" data-email="${member.email}" class="remove-member-btn text-sm bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Remover</button>
                            ` : ''}
                         </div>
                     `;
                     list.appendChild(memberDiv);
                 });
             }
        }


        async function handleSavePreferences() {
                const newDefaultView = document.getElementById('default-agenda-view').value;
                const newDefaultServiceType = document.getElementById('default-service-type').value; // Get new preference
                const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
                try {
                    showLoading();
                    await updateDoc(clinicDocRef, {
                        'preferences.defaultAgendaView': newDefaultView,
                        'preferences.defaultServiceType': newDefaultServiceType // Save new preference
                    });
                    clinicPreferences.defaultAgendaView = newDefaultView;
                    clinicPreferences.defaultServiceType = newDefaultServiceType; // Update global var
                    alert('Preferências salvas!');
                } catch (error) {
                    console.error("Erro ao salvar preferências:", error);
                    alert("Erro ao salvar preferências.");
                } finally {
                     hideLoading();
                }
        }

        // Specific handler for patient list search
        function handlePatientSearch(e) {
             const searchTerm = e.target.value.toLowerCase();
             const filteredPatients = allPatients.filter(p => p.name.toLowerCase().includes(searchTerm));
             renderPatientList(filteredPatients);
        }


        // Shared handler for patient datalist inputs
        function handlePatientInput(e) {
            const inputValue = e.target.value; // Keep original case for display
            const listId = e.target.getAttribute('list'); // Should be 'patient-list'
            const datalistElement = document.getElementById(listId);
            const hiddenIdInput = document.getElementById(e.target.id.replace('-input', '-id')); // Find corresponding hidden input

            if (!hiddenIdInput || !datalistElement) return;

            hiddenIdInput.value = ''; // Clear previous ID
            const options = datalistElement.options;
            for (let i = 0; i < options.length; i++) {
                 // Use exact match for finding the ID
                if (options[i].value === inputValue) { // Compare with original case
                    hiddenIdInput.value = options[i].dataset.id;
                    console.log("Patient ID selected:", hiddenIdInput.value); // Debug log
                    
                    // IF this input is for the appointment modal, trigger address prefill if 'domiciliar' is checked
                     if (e.target.id === 'appointment-patient-input') {
                         const serviceType = document.querySelector('input[name="serviceType"]:checked')?.value;
                         if (serviceType === 'domiciliar') {
                             const patient = allPatients.find(p => p.id === hiddenIdInput.value);
                             // Pre-fill all fields
                             document.getElementById('appointment-cep').value = (patient && patient.cep) ? patient.cep : '';
                             document.getElementById('appointment-street').value = (patient && patient.street) ? patient.street : '';
                             document.getElementById('appointment-number').value = (patient && patient.number) ? patient.number : '';
                             document.getElementById('appointment-neighborhood').value = (patient && patient.neighborhood) ? patient.neighborhood : '';
                             document.getElementById('appointment-city').value = (patient && patient.city) ? patient.city : '';
                             document.getElementById('appointment-state').value = (patient && patient.state) ? patient.state : '';
                         }
                     }
                    break;
                }
            }
             if (!hiddenIdInput.value) {
                  console.log("No exact match found for patient ID yet."); // Debug log
             }
        }

        
        // NOVO: Função de busca de CEP
        async function fetchAddressFromCEP(cep, formPrefix = 'patient') {
            const cepClean = cep.replace(/\D/g, ''); // Remove non-digits
            if (cepClean.length !== 8) {
                console.log("CEP inválido ou incompleto.");
                return; // Not a valid CEP length
            }

            // Find elements dynamically based on prefix
            const streetEl = document.getElementById(`${formPrefix}-street`);
            const neighborhoodEl = document.getElementById(`${formPrefix}-neighborhood`);
            const cityEl = document.getElementById(`${formPrefix}-city`);
            const stateEl = document.getElementById(`${formPrefix}-state`);
            const numberEl = document.getElementById(`${formPrefix}-number`); // For focusing

            if (!streetEl || !neighborhoodEl || !cityEl || !stateEl) {
                console.error("Campos de endereço não encontrados no formulário:", formPrefix);
                return;
            }

            try {
                showLoading(); // Show loading during fetch
                const response = await fetch(`https://viacep.com.br/ws/${cepClean}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado');
                
                const data = await response.json();
                
                if (data.erro) {
                    console.log("CEP não encontrado (ViaCEP).");
                    // Opcional: Limpar campos se CEP não for encontrado?
                    streetEl.value = '';
                    neighborhoodEl.value = '';
                    cityEl.value = '';
                    stateEl.value = '';
                } else {
                    console.log("CEP encontrado:", data);
                    streetEl.value = data.logradouro || '';
                    neighborhoodEl.value = data.bairro || '';
                    cityEl.value = data.localidade || '';
                    stateEl.value = data.uf || '';
                    
                    // Focus 'number' field after success
                    if (numberEl) numberEl.focus();
                }
            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
            } finally {
                hideLoading();
            }
        }


        async function fetchAndRenderDashboardData() {
             if (!currentUserClinicId) return Promise.resolve(); // Return resolved promise if no clinic ID

              // Clean up previous listener
             if (dashboardAppointmentsUnsubscribe) {
                  console.log("Unsubscribing previous dashboard appointments listener.");
                  dashboardAppointmentsUnsubscribe();
                  dashboardAppointmentsUnsubscribe = null;
              }

             // Count patients (using getDocs for one-time fetch is likely sufficient here)
             const patientsCountEl = document.getElementById('active-patients-count');
             if (patientsCountEl) {
                  const patientsCol = collection(db, "clinics", currentUserClinicId, "patients");
                   try {
                        const snapshot = await getDocs(patientsCol); // Using getDocs
                        // Check if element still exists after await
                        const currentPatientsCountEl = document.getElementById('active-patients-count');
                        if(currentPatientsCountEl) {
                            currentPatientsCountEl.textContent = snapshot.size;
                        }
                   } catch (error) {
                        console.error("Error fetching patient count:", error)
                   };
             }

             // Today's appointments
             const todayAppointmentsEl = document.getElementById('today-appointments');
             if (todayAppointmentsEl) {
                 const todayStr = getDateString(new Date()); // Use helper function
                 console.log("Fetching dashboard appointments for date:", todayStr);
                 const appointmentsCol = collection(db, 'clinics', currentUserClinicId, 'appointments');
                 const q = query(appointmentsCol, where('date', '==', todayStr)); // Correct comparison

                 return new Promise((resolve, reject) => { // Return a promise
                     dashboardAppointmentsUnsubscribe = onSnapshot(q, (snapshot) => { // Assign listener to specific variable
                         const currentTodayAppointmentsEl = document.getElementById('today-appointments'); // Re-check element
                         if(!currentTodayAppointmentsEl) {
                              if (dashboardAppointmentsUnsubscribe) { dashboardAppointmentsUnsubscribe(); dashboardAppointmentsUnsubscribe = null; } // Cleanup if element gone
                              resolve(); // Resolve if element is gone
                              return;
                         }
                          console.log(`Dashboard appointments snapshot: ${snapshot.size} docs`);

                         if(snapshot.empty) {
                             currentTodayAppointmentsEl.innerHTML = '<p class="text-gray-500">Nenhum agendamento para hoje.</p>';
                         } else {
                             const appointments = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); // Include ID
                             appointments.sort((a, b) => a.time.localeCompare(b.time));

                             currentTodayAppointmentsEl.innerHTML = appointments.map(app => {
                                 return `<div class="appointment-item p-2 bg-gray-100 rounded-md cursor-pointer" data-appointment-id="${app.id}">
                                     <p class="font-semibold">${app.time} - ${app.patientName}</p>
                                 </div>` // Make dashboard items clickable too
                             }).join('');
                         }
                         resolve(); // Resolve after rendering
                     }, (error) => {
                          console.error("Error fetching today's appointments:", error);
                          const currentTodayAppointmentsEl = document.getElementById('today-appointments');
                          if(currentTodayAppointmentsEl) currentTodayAppointmentsEl.innerHTML = '<p class="text-red-500">Erro ao carregar agendamentos.</p>';
                          reject(error); // Reject on error
                     });
                 });
             } else {
                 return Promise.resolve(); // Resolve immediately if element not found
             }
         }


        function setupAgendaListeners() {
            // Remove potential old listeners before adding new ones - more robust approach
            const prevBtn = document.getElementById('prev-period-btn');
            const nextBtn = document.getElementById('next-period-btn');
            const dailyBtn = document.getElementById('agenda-view-daily');
            const weeklyBtn = document.getElementById('agenda-view-weekly');
            const monthlyBtn = document.getElementById('agenda-view-monthly');
            const searchInput = document.getElementById('search-appointment');

            // Replace elements to ensure old listeners are detached
            if(prevBtn) { const newBtn = prevBtn.cloneNode(true); prevBtn.parentNode.replaceChild(newBtn, prevBtn); newBtn.addEventListener('click', handlePrevPeriod); }
            if(nextBtn) { const newBtn = nextBtn.cloneNode(true); nextBtn.parentNode.replaceChild(newBtn, nextBtn); newBtn.addEventListener('click', handleNextPeriod); }
            if(dailyBtn) { const newBtn = dailyBtn.cloneNode(true); dailyBtn.parentNode.replaceChild(newBtn, dailyBtn); newBtn.addEventListener('click', () => handleViewChange('daily')); }
            if(weeklyBtn) { const newBtn = weeklyBtn.cloneNode(true); weeklyBtn.parentNode.replaceChild(newBtn, weeklyBtn); newBtn.addEventListener('click', () => handleViewChange('weekly')); }
            if(monthlyBtn) { const newBtn = monthlyBtn.cloneNode(true); monthlyBtn.parentNode.replaceChild(newBtn, monthlyBtn); newBtn.addEventListener('click', () => handleViewChange('monthly')); }
            if(searchInput) { const newInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newInput, searchInput); newInput.addEventListener('input', handleSearchInput); }
        }

        // Define handlers outside setup for clarity and potential removal if needed
        function handlePrevPeriod() {
             if (currentAgendaView === 'monthly') currentDate.setMonth(currentDate.getMonth() - 1);
             else if (currentAgendaView === 'weekly') currentDate.setDate(currentDate.getDate() - 7);
             else if (currentAgendaView === 'daily') currentDate.setDate(currentDate.getDate() - 1);
             updateAgenda();
        }
        function handleNextPeriod() {
             if (currentAgendaView === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
             else if (currentAgendaView === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
             else if (currentAgendaView === 'daily') currentDate.setDate(currentDate.getDate() + 1);
             updateAgenda();
        }
        function handleViewChange(view) {
            currentAgendaView = view;
            updateAgenda();
        }
        function handleSearchInput(e) {
             renderAgendaView(currentAppointments, e.target.value);
        }


        async function updateAgenda() { // Make async to await listener setup
             const agendaContentEl = mainContentContainer.querySelector('#agenda-content');
             if (!currentUserClinicId || !agendaContentEl) return Promise.resolve();
             if (appointmentsUnsubscribe) { appointmentsUnsubscribe(); appointmentsUnsubscribe = null; } // Clean previous listener

             ['daily', 'weekly', 'monthly'].forEach(view => {
                 const btn = document.getElementById(`agenda-view-${view}`);
                 if(btn) {
                     btn.classList.remove('bg-blue-500', 'text-white'); // Reset all
                     if(currentAgendaView === view) {
                         btn.classList.add('bg-blue-500', 'text-white'); // Activate current
                     }
                 }
             });

             const periodHeader = document.getElementById('period-header');
             let startDate, endDate;

             if (currentAgendaView === 'monthly') {
                 periodHeader.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} de ${currentDate.getFullYear()}`;
                 startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                 endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
             } else if (currentAgendaView === 'weekly') {
                 const startOfWeek = new Date(currentDate);
                 startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                 const endOfWeek = new Date(startOfWeek);
                 endOfWeek.setDate(startOfWeek.getDate() + 6);
                 periodHeader.textContent = `${startOfWeek.toLocaleDateString('pt-BR')} - ${endOfWeek.toLocaleDateString('pt-BR')}`;
                 startDate = startOfWeek;
                 endDate = endOfWeek;
             } else { // daily
                 periodHeader.textContent = currentDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
                 startDate = currentDate;
                 endDate = currentDate;
             }

             const appointmentsCol = collection(db, 'clinics', currentUserClinicId, 'appointments');
              // Ensure dates are correctly formatted as strings for Firestore query
             const q = query(appointmentsCol, where('date', '>=', getDateString(startDate)), where('date', '<=', getDateString(endDate)));

              agendaContentEl.innerHTML = '<p class="text-center text-gray-500 py-8">Carregando agendamentos...</p>';


             // Return a promise that resolves when the first snapshot is received
             return new Promise((resolve, reject) => {
                 appointmentsUnsubscribe = onSnapshot(q, (snapshot) => {
                      // Ensure view hasn't changed while waiting for data
                      const currentAgendaContentEl = mainContentContainer.querySelector('#agenda-content');
                      if (!currentAgendaContentEl) {
                           if(appointmentsUnsubscribe) { appointmentsUnsubscribe(); appointmentsUnsubscribe = null; } // Clean listener if view changed
                          resolve(); // Resolve if view changed
                          return;
                      }

                     currentAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Store with ID
                      const searchInput = document.getElementById('search-appointment');
                     renderAgendaView(currentAppointments, searchInput ? searchInput.value : ''); // Apply search term on update
                     resolve(); // Resolve after first render
                 }, (error) => {
                     console.error("Erro ao buscar agendamentos:", error);
                      const currentAgendaContentEl = mainContentContainer.querySelector('#agenda-content');
                      if (currentAgendaContentEl) { // Check if element still exists
                          currentAgendaContentEl.innerHTML = '<p class="text-center text-red-500 py-8">Erro ao carregar agendamentos.</p>';
                      }
                      reject(error); // Reject on error
                 });
             });
         }


        function fetchAndRenderAllPayments() {
            if (!currentUserClinicId) return Promise.resolve();
            if (paymentsUnsubscribe) { paymentsUnsubscribe(); paymentsUnsubscribe = null; }

            const paymentsCol = collection(db, 'clinics', currentUserClinicId, 'payments');
            const q = query(paymentsCol, orderBy('date', 'desc'));

            // Return a promise that resolves when the first snapshot is received
             return new Promise((resolve, reject) => {
                 paymentsUnsubscribe = onSnapshot(q, (snapshot) => {
                     const payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      // Only render if the finance view is currently active
                      if(document.getElementById('payments-table-body')) {
                         renderAllPayments(payments);
                      }
                      resolve();
                 }, (error) => {
                     console.error("Erro ao buscar pagamentos:", error);
                     const tableBody = mainContentContainer.querySelector('#payments-table-body');
                     if (tableBody) tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-500">Erro ao carregar lançamentos.</td></tr>`;
                     reject(error);
                 });
             });
        }


        function fetchAndRenderRooms() {
             if (!currentUserClinicId) return Promise.reject("No clinic ID");
             const q = query(collection(db, "clinics", currentUserClinicId, "rooms"));
             console.log("Setting up rooms listener...");

             if (roomsUnsubscribe) { roomsUnsubscribe(); roomsUnsubscribe = null; }
             // Return a promise that resolves when the first snapshot is received
             return new Promise((resolve, reject) => {
                 roomsUnsubscribe = onSnapshot(q, (snapshot) => {
                     console.log(`Rooms snapshot received: ${snapshot.size} docs`);
                     clinicRooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      // Only render if the config view's room list element exists
                     const currentRoomsListDiv = document.getElementById('rooms-list');
                     if(currentRoomsListDiv) renderRoomsList(clinicRooms);
                     resolve();
                 }, (error) => {
                     console.error("Erro ao buscar salas:", error);
                      const currentRoomsListDiv = document.getElementById('rooms-list');
                     if(currentRoomsListDiv) currentRoomsListDiv.innerHTML = '<p class="text-red-500">Erro ao carregar salas.</p>';
                     reject(error);
                 });
             });
         }



        async function openAppointmentDetailModal(appointmentId, defaultDate = null) {
             if (!currentUserClinicId) return;

             showLoading(); // Show loading while fetching/preparing modal

            // Reset form and hide delete button initially
             document.getElementById('appointment-form').reset();
             document.getElementById('appointment-id').value = '';
             document.getElementById('delete-appointment-btn').classList.add('hidden');

             // Ensure related data is available (consider adding loading indicators if needed)
             // It's better to fetch these if they are empty, but for now rely on initial load
             if (allPatients.length === 0) console.warn("Patient data not loaded for modal.");
             if (clinicUsers.length === 0) console.warn("User data not loaded for modal.");
             if (clinicRooms.length === 0) console.warn("Room data not loaded for modal.");

             populatePatientDatalist();

             const professionalSelect = document.getElementById('appointment-professional');
             professionalSelect.innerHTML = clinicUsers.map(u => `<option value="${u.id}">${u.email}</option>`).join('') || '<option disabled selected>Nenhum profissional</option>';

             const roomSelect = document.getElementById('appointment-room');
             roomSelect.innerHTML = clinicRooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('') || '<option disabled selected>Nenhuma sala</option>';


             if (appointmentId) { // Editing existing appointment
                 try {
                    const appointmentDocRef = doc(db, 'clinics', currentUserClinicId, 'appointments', appointmentId);
                    const docSnap = await getDoc(appointmentDocRef);

                    if (docSnap.exists()) {
                        const appData = docSnap.data();

                        document.getElementById('appointment-id').value = appointmentId;
                        document.getElementById('appointment-date').value = appData.date;
                        document.getElementById('appointment-modal-title').textContent = `Editar Agendamento - ${new Date(appData.date + 'T12:00:00').toLocaleDateString('pt-BR')}`;
                        document.getElementById('appointment-patient-input').value = appData.patientName;
                        document.getElementById('appointment-patient-id').value = appData.patientId;

                        // Set selects safely after options are populated
                        if (professionalSelect.querySelector(`option[value="${appData.professionalId}"]`)) {
                            professionalSelect.value = appData.professionalId;
                        } else { console.warn(`Professional ID ${appData.professionalId} not found.`); }

                        if (roomSelect.querySelector(`option[value="${appData.roomId}"]`)) {
                            roomSelect.value = appData.roomId;
                        } else { console.warn(`Room ID ${appData.roomId} not found.`); }
                        
                        // Set service type and fields
                        const serviceType = appData.serviceType || 'local'; // Default to local if not set
                        document.querySelectorAll('input[name="serviceType"]').forEach(radio => {
                             radio.checked = (radio.value === serviceType);
                        });
                        toggleAppointmentFields(serviceType); // Show/hide fields
                        if (serviceType === 'domiciliar') {
                             // NOVO: Preencher campos de endereço detalhados
                             const ad = appData.addressDetails || {};
                             document.getElementById('appointment-cep').value = ad.cep || '';
                             document.getElementById('appointment-street').value = ad.street || (appData.address || ''); // Fallback to old address field
                             document.getElementById('appointment-number').value = ad.number || '';
                             document.getElementById('appointment-neighborhood').value = ad.neighborhood || '';
                             document.getElementById('appointment-city').value = ad.city || '';
                             document.getElementById('appointment-state').value = ad.state || '';
                        }


                        document.getElementById('appointment-time').value = appData.time;
                        document.getElementById('appointment-duration').value = appData.duration;
                        document.getElementById('appointment-notes').value = appData.notes || '';

                        document.getElementById('delete-appointment-btn').classList.remove('hidden'); // Show delete button
                        hideLoading(); // Hide loading only after data is populated
                        openModal(appointmentModal);

                    } else {
                        console.error("Agendamento não encontrado:", appointmentId);
                        alert("Agendamento não encontrado.");
                        hideLoading();
                    }
                 } catch(error) {
                     console.error("Erro ao abrir detalhes do agendamento:", error);
                     alert("Erro ao abrir detalhes do agendamento.");
                     hideLoading();
                 }
             } else { // Creating new appointment
                const dateToSet = defaultDate || getDateString(new Date());
                document.getElementById('appointment-date').value = dateToSet;
                document.getElementById('appointment-modal-title').textContent = `Novo Agendamento - ${new Date(dateToSet + 'T12:00:00').toLocaleDateString('pt-BR')}`;
                
                // Set default service type from preferences
                const defaultServiceType = clinicPreferences.defaultServiceType || 'local';
                 document.querySelectorAll('input[name="serviceType"]').forEach(radio => {
                     radio.checked = (radio.value === defaultServiceType);
                 });
                 toggleAppointmentFields(defaultServiceType); // Show/hide fields based on default
                
                hideLoading(); // Hide loading before opening modal
                openModal(appointmentModal);
             }
        }


        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewName = e.currentTarget.id.replace('nav-', '');
                switchView(viewName);
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                    mobileMenuOverlay.classList.add('hidden');
                }
            });
        });

        // --- AUTH & USER LOGIC ---

        async function handleCreateUser(e) {
            e.preventDefault();
            const feedbackEl = document.getElementById('create-user-feedback');
            feedbackEl.textContent = '';
            feedbackEl.className = 'text-sm mt-4 h-4'; // Reset classes
            const email = document.getElementById('new-user-email').value;
            const role = document.getElementById('new-user-role').value;

            // Generate temp password
            const tempPassword = 'Fisio@' + Math.random().toString(36).substring(2, 8);

            // Use secondary app instance
            const secondaryAppName = 'createUserApp-' + Date.now();
            let secondaryApp;
            let secondaryAuth;
            try {
                 secondaryApp = initializeApp(firebaseConfig, secondaryAppName);
                 secondaryAuth = getAuth(secondaryApp);
                 showLoading();

                // 1. Create user in Auth
                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, tempPassword);
                const user = userCredential.user;

                // 2. Create profile in Firestore
                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    email: user.email,
                    clinicId: currentUserClinicId,
                    role: role,
                    mustChangePassword: true,
                    createdAt: serverTimestamp()
                });

                // 3. Add member to clinic
                const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
                await updateDoc(clinicDocRef, {
                    members: arrayUnion(user.uid),
                    [`roles.${user.uid}`]: role
                });

                feedbackEl.textContent = `Usuário criado! Senha temporária: ${tempPassword}`;
                feedbackEl.classList.add('text-green-600');
                e.target.reset();

            } catch (error) {
                console.error("Erro ao criar usuário:", error);
                 if (error.code === 'auth/email-already-in-use') {
                    feedbackEl.textContent = 'Este e-mail já está em uso.';
                } else {
                    feedbackEl.textContent = 'Erro ao criar usuário.';
                }
                feedbackEl.classList.add('text-red-600');
            } finally {
                 hideLoading();
                // Ensure secondary app resources are cleaned up
                if (secondaryAuth) await signOut(secondaryAuth).catch(e => console.error("Falha ao deslogar app secundário", e));
                if (secondaryApp) await deleteApp(secondaryApp).catch(e => console.error("Falha ao deletar app secundário", e));
            }
        }


        document.getElementById('show-register-btn').addEventListener('click', (e) => { e.preventDefault(); loginContainer.classList.add('hidden'); registerContainer.classList.remove('hidden'); });
        document.getElementById('show-login-btn').addEventListener('click', (e) => { e.preventDefault(); registerContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('login-error').textContent = '';
            showLoading(); // Show loading during login attempt
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
                // onAuthStateChanged will handle hiding loading on success
            }
            catch(error) {
                 document.getElementById('login-error').textContent = 'E-mail ou senha inválidos.';
                 hideLoading(); // Hide loading on error
            }
        });

        document.getElementById('register-form').addEventListener('submit', async(e) => {
            e.preventDefault();
            const errorEl = document.getElementById('register-error');
            errorEl.textContent = '';
            showLoading(); // Show loading during registration

            const accountType = document.querySelector('input[name="accountType"]:checked').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            let clinicData = { accountType, ownerEmail: email };
            let clinicNameForDisplay;

            if (accountType === 'pf') {
                clinicNameForDisplay = document.getElementById('pf-name').value;
                clinicData = {
                    ...clinicData,
                    name: clinicNameForDisplay,
                    birthDate: document.getElementById('pf-birthDate').value,
                    rg: document.getElementById('pf-rg').value,
                    cpf: document.getElementById('pf-cpf').value,
                    crefito: document.getElementById('pf-crefito').value,
                    cep: document.getElementById('pf-cep').value,
                    street: document.getElementById('pf-street').value,
                    number: document.getElementById('pf-number').value,
                    neighborhood: document.getElementById('pf-neighborhood').value,
                    city: document.getElementById('pf-city').value,
                    state: document.getElementById('pf-state').value,
                    phone: document.getElementById('pf-phone').value,
                };
                 clinicData.address = constructPatientAddress(clinicData); // Save combined address
            } else { // pj
                clinicNameForDisplay = document.getElementById('pj-razaoSocial').value;
                clinicData = {
                    ...clinicData,
                    name: clinicNameForDisplay,
                    cnpj: document.getElementById('pj-cnpj').value,
                    crefito: document.getElementById('pj-crefito').value,
                    cep: document.getElementById('pj-cep').value,
                    street: document.getElementById('pj-street').value,
                    number: document.getElementById('pj-number').value,
                    neighborhood: document.getElementById('pj-neighborhood').value,
                    city: document.getElementById('pj-city').value,
                    state: document.getElementById('pj-state').value,
                    phone: document.getElementById('pj-phone').value,
                    responsavelNome: document.getElementById('pj-responsavel').value,
                    responsavelCpf: document.getElementById('pj-responsavel-cpf').value,
                    responsavelCrefito: document.getElementById('pj-responsavel-crefito').value,
                };
                clinicData.address = constructPatientAddress(clinicData); // Save combined address
            }

            if (!clinicNameForDisplay) {
                errorEl.textContent = 'O nome (PF) ou Razão Social (PJ) é obrigatório.';
                 hideLoading();
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                clinicData = {
                    ...clinicData,
                    ownerId: user.uid,
                    members: [user.uid],
                    roles: { [user.uid]: 'admin' },
                    status: 'active',
                    createdAt: serverTimestamp()
                };

                const clinicDocRef = await addDoc(collection(db, 'clinics'), clinicData);

                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    email: user.email,
                    clinicId: clinicDocRef.id,
                    role: 'admin',
                    name: accountType === 'pf' ? clinicData.name : clinicData.responsavelNome, // Salva o nome no perfil
                    createdAt: serverTimestamp()
                });
                // Automatic login after successful registration handled by onAuthStateChanged
            } catch (error) {
                console.error("Erro no cadastro:", error);
                if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = 'Este e-mail já está em uso. Tente outro.';
                } else if (error.code === 'auth/weak-password'){
                     errorEl.textContent = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                } else {
                    errorEl.textContent = 'Erro ao criar conta. Tente novamente.';
                }
                 hideLoading(); // Hide loading on error
            }
             // No need to hide loading on success here, onAuthStateChanged will handle it.
        });


        document.getElementById('logout-btn').addEventListener('click', () => {
             showLoading(); // Show loading briefly during logout
             signOut(auth).catch(error => {
                 console.error("Logout error:", error);
                 hideLoading(); // Hide loading even if logout fails
             });
        });

        onAuthStateChanged(auth, async (user) => {
             console.log("Auth state changed. User:", user ? user.uid : 'null');
            if (user) {
                 // Don't show loading here immediately, wait for profile check
                currentUserId = user.uid;
                const loadUserProfileAndDashboard = async (retriesLeft = 5) => { // Reduced retries
                    console.log(`Loading profile, retries left: ${retriesLeft}`);
                    const userDocRef = doc(db, 'users', user.uid);
                    try {
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists() && userDocSnap.data().clinicId) {
                            const userData = userDocSnap.data();
                             console.log("User data found:", userData);

                            // CHECK CLINIC STATUS
                            const clinicDocRef = doc(db, 'clinics', userData.clinicId);
                            const clinicDocSnap = await getDoc(clinicDocRef);

                            if (!clinicDocSnap.exists()) {
                                console.error("Clinic document not found!");
                                document.getElementById('login-error').textContent = 'Erro: Clínica não encontrada.';
                                await signOut(auth); // Sign out if clinic doesn't exist
                                hideLoading(); // Ensure loading is hidden
                                return;
                            }

                            const clinicData = clinicDocSnap.data();
                            console.log("Clinic data found:", clinicData);

                            if (clinicData.status === 'inactive') {
                                document.getElementById('login-error').textContent = 'Sua clínica está inativa. Contate o suporte.';
                                await signOut(auth); // Sign out if inactive
                                hideLoading(); // Ensure loading is hidden
                                return;
                            }

                            clinicPreferences = clinicData.preferences || { defaultAgendaView: 'monthly', defaultServiceType: 'local' }; // Load preferences here

                            // CHECK FOR TEMP PASSWORD
                            if (userData.mustChangePassword) {
                                authView.classList.add('hidden');
                                dashboardView.classList.add('hidden');
                                hideLoading(); // Hide loading before showing password modal
                                openModal(forcePasswordChangeModal);
                                return;
                            }

                            currentUserClinicId = userData.clinicId;
                            currentUserRole = userData.role;

                            document.getElementById('user-email').textContent = user.email;
                            document.getElementById('clinic-name-sidebar').textContent = clinicData.name;

                            // Fetch initial data needed across views AFTER setting clinicId
                            // Use Promise.allSettled to wait for all critical initial fetches
                            console.log("Fetching initial data (members, rooms, patients)...");
                            showLoading(); // Show loading *before* fetching bulk data
                            await Promise.allSettled([
                                 fetchAndRenderMembers(), // Returns promise now
                                 fetchAndRenderRooms(),   // Returns promise now
                                 fetchAndRenderPatients() // Returns promise now
                             ]);
                            console.log("Initial data fetches settled.");
                            initialDataLoaded = true; // Mark initial data as loaded


                            authView.classList.add('hidden');
                            dashboardView.classList.remove('hidden');
                             // Switch view *after* essential data is fetched
                            switchView('inicio'); // Will hide loading inside switchView now

                        } else {
                            if (retriesLeft > 0) {
                                console.log(`User profile not found or incomplete, retrying in 1s... (${retriesLeft} attempts left)`);
                                setTimeout(() => loadUserProfileAndDashboard(retriesLeft - 1), 1000);
                            } else {
                                console.error("User profile not found after multiple attempts. Logging out.");
                                document.getElementById('login-error').textContent = 'Erro ao carregar perfil. Verifique se o cadastro foi concluído ou contate o suporte.';
                                await signOut(auth);
                                hideLoading(); // Ensure loading is hidden
                            }
                        }
                    } catch (error) {
                         console.error("Error fetching user/clinic data:", error);
                          document.getElementById('login-error').textContent = 'Erro ao carregar dados. Tente novamente.';
                          await signOut(auth);
                          hideLoading(); // Ensure loading is hidden
                    }
                };

                loadUserProfileAndDashboard();

            } else {
                 // Clean up global state and listeners on logout
                 console.log("User logged out or not authenticated.");
                 hideLoading(); // Ensure loading is hidden on logout
                currentUserClinicId = null;
                currentUserRole = null;
                currentUserId = null;
                selectedPatientId = null;
                allPatients = [];
                clinicUsers = [];
                clinicRooms = [];
                currentAppointments = [];
                initialDataLoaded = false; // Reset flag
                if (patientsUnsubscribe) { console.log("Cleaning up patients listener"); patientsUnsubscribe(); patientsUnsubscribe = null; }
                if (assessmentsUnsubscribe) { console.log("Cleaning up assessments listener"); assessmentsUnsubscribe(); assessmentsUnsubscribe = null; }
                if (appointmentsUnsubscribe) { console.log("Cleaning up appointments listener"); appointmentsUnsubscribe(); appointmentsUnsubscribe = null; }
                if (paymentsUnsubscribe) { console.log("Cleaning up payments listener"); paymentsUnsubscribe(); paymentsUnsubscribe = null; }
                if (membersUnsubscribe) { console.log("Cleaning up members listener"); membersUnsubscribe(); membersUnsubscribe = null; }
                if (roomsUnsubscribe) { console.log("Cleaning up rooms listener"); roomsUnsubscribe(); roomsUnsubscribe = null; }
                if (dashboardAppointmentsUnsubscribe) { console.log("Cleaning up dashboard appointments listener"); dashboardAppointmentsUnsubscribe(); dashboardAppointmentsUnsubscribe = null; }


                dashboardView.classList.add('hidden');
                authView.classList.remove('hidden');
                loginContainer.classList.remove('hidden'); // Ensure login is visible
                registerContainer.classList.add('hidden');
                
                // --- FIX: Preserve the error message if it was set by a failed token login ---
                const loginError = document.getElementById('login-error');
                if (loginError && !loginError.textContent) { // Check if loginError exists and textContent is empty
                    loginError.textContent = ''; // Clear only if no error was set
                }
                // --- END FIX ---
            }
        });

        // --- MODAL & TAB CONTROLS ---
        document.getElementById('cancel-patient-modal').addEventListener('click', () => closeModal(patientModal));
        patientModal.addEventListener('click', (e) => { if (e.target === patientModal) closeModal(patientModal); });
        document.getElementById('cancel-assessment-modal').addEventListener('click', () => closeModal(assessmentModal));
        assessmentModal.addEventListener('click', (e) => { if (e.target === assessmentModal) closeModal(assessmentModal); });

        document.getElementById('close-assessment-detail-modal').addEventListener('click', () => closeModal(assessmentDetailModal));
        document.getElementById('close-assessment-detail-modal-btn').addEventListener('click', () => closeModal(assessmentDetailModal));
        assessmentDetailModal.addEventListener('click', (e) => { if (e.target === assessmentDetailModal) closeModal(assessmentDetailModal); });

        document.getElementById('cancel-appointment-modal').addEventListener('click', () => closeModal(appointmentModal));
        appointmentModal.addEventListener('click', (e) => { if (e.target === appointmentModal) closeModal(appointmentModal); });

        document.getElementById('cancel-financial-modal').addEventListener('click', () => closeModal(financialRecordModal));
        financialRecordModal.addEventListener('click', (e) => { if (e.target === financialRecordModal) closeModal(financialRecordModal); });

        document.getElementById('cancel-change-role-modal').addEventListener('click', () => closeModal(changeRoleModal));
        changeRoleModal.addEventListener('click', (e) => { if (e.target === changeRoleModal) closeModal(changeRoleModal); });

        document.getElementById('cancel-clinic-edit-modal').addEventListener('click', () => closeModal(clinicEditModal));
        clinicEditModal.addEventListener('click', (e) => { if (e.target === clinicEditModal) closeModal(clinicEditModal); });

        document.getElementById('cancel-room-modal').addEventListener('click', () => closeModal(roomModal));
        roomModal.addEventListener('click', (e) => { if (e.target === roomModal) closeModal(roomModal); });

        document.getElementById('force-password-change-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('force-password-change-error');
            errorEl.textContent = '';
            showLoading();

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            const user = auth.currentUser;

            if (newPassword !== confirmNewPassword) {
                errorEl.textContent = 'As novas senhas não coincidem.';
                 hideLoading();
                return;
            }
            if (newPassword.length < 8 || !/\d/.test(newPassword)) {
                errorEl.textContent = 'A senha deve ter no mínimo 8 caracteres e um número.';
                 hideLoading();
                return;
            }

            if (user && user.email) {
                try {
                    const credential = EmailAuthProvider.credential(user.email, currentPassword);
                    await reauthenticateWithCredential(user, credential);
                    await updatePassword(user, newPassword);

                    const userDocRef = doc(db, 'users', user.uid);
                    await updateDoc(userDocRef, { mustChangePassword: false });

                    closeModal(forcePasswordChangeModal);
                    // Reload page to trigger onAuthStateChanged with updated profile
                    location.reload();

                } catch (error) {
                    console.error("Erro ao alterar senha:", error);
                    if (error.code === 'auth/wrong-password') {
                        errorEl.textContent = 'A senha temporária está incorreta.';
                    } else {
                        errorEl.textContent = 'Ocorreu um erro. Tente novamente.';
                    }
                     hideLoading();
                }
            } else {
                 hideLoading(); // Should not happen if modal is shown
            }
        });

        // Tab switching for Assessment Modals (Ensure elements exist)
        assessmentModal?.querySelector('.flex-wrap')?.addEventListener('click', (e) => {
            if(e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                assessmentModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                assessmentModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                assessmentModal.querySelector(`#${tabId}`)?.classList.remove('hidden'); // Add safety check
            }
        });

        assessmentDetailModal?.querySelector('.flex-wrap')?.addEventListener('click', (e) => {
            if(e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                assessmentDetailModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                assessmentDetailModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                assessmentDetailModal.querySelector(`#${tabId}`)?.classList.remove('hidden'); // Add safety check
            }
        });

        // Conditional fields in Assessment Modal (Ensure elements exist before adding listeners)
        // Add event listeners only when the modal is actually opened, or use event delegation
        // Example using delegation (add this inside the global click listener or a setup function for the modal):
        document.body.addEventListener('change', (e) => { // Use change event for select
            if (e.target.closest('#assessment-modal')) {
                if(e.target.id === 'dor-eva') {
                    document.getElementById('dor-local-container')?.classList.toggle('hidden', e.target.value == 0);
                }
                if(e.target.id === 'edema') {
                    document.getElementById('edema-local-container')?.classList.toggle('hidden', e.target.value === 'Não');
                }
            }
            
            // NOVO: Listener para os radio buttons do tipo de atendimento
            if (e.target.matches('input[name="serviceType"]')) {
                toggleAppointmentFields(e.target.value);
            }
        });

        // Mobile Menu
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            mobileMenuOverlay.classList.remove('hidden');
        });
        mobileMenuOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            mobileMenuOverlay.classList.add('hidden');
        });

        // Toggle PF/PJ form in registration
        document.querySelectorAll('input[name="accountType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isPf = e.target.value === 'pf';
                document.getElementById('pf-fields').classList.toggle('hidden', !isPf);
                document.getElementById('pj-fields').classList.toggle('hidden', isPf);
            });
        });

         // Initial Auth Check (using token or falling back)
         (async () => {
             try {
                showLoading(); // Show loading initially
                console.log("Checking initial auth state...");
                // Check if the token is available in the environment
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        console.log("Attempting sign in with custom token...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                         console.log("Sign in with custom token successful.");
                         // Let onAuthStateChanged handle the rest, including hiding loading
                    } catch (tokenError) {
                        console.error("Custom token sign-in error:", tokenError);
                        // If token fails, just log it. Don't sign in anonymously.
                        // Let onAuthStateChanged detect no user and show login screen.
                        
                        // FIX: Ensure login-error element exists before setting textContent
                        const loginErrorEl = document.getElementById('login-error');
                        if (loginErrorEl) {
                             loginErrorEl.textContent = 'Falha na autenticação automática. Faça login manually.';
                        }
                        // END FIX
                        
                        hideLoading(); // Hide loading as auth failed, let onAuthStateChanged show login
                    }
                } else {
                    console.log("No custom token found.");
                    // If no token, do nothing, let onAuthStateChanged handle the unauthenticated state (show login)
                    hideLoading(); // Hide loading if no token to try
                }
                // onAuthStateChanged will be triggered regardless and handle UI updates
            } catch (error) { // Catch any unexpected errors during the process
                console.error("Initial sign-in process error (unexpected):", error);
                 // FIX: Ensure login-error element exists before setting textContent
                const loginErrorEl = document.getElementById('login-error');
                if (loginErrorEl) {
                    loginErrorEl.textContent = 'Erro inesperado na autenticação inicial.';
                }
                // END FIX
                hideLoading(); // Hide loading on error
            }
         })();


    </script>
</body>
</html>
