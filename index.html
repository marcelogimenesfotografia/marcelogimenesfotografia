<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioGestão - Gerenciador de Pacientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); z-index: 50; }
        .sub-modal { z-index: 51; } /* Z-index para modais sobre modais */
        /* Z-index elevado para modais de alerta/confirmação */
        #js-message-modal, #confirm-modal, #recurrence-options-modal { z-index: 60; }

        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; color: #D1D5DB; }
        .sidebar-link:hover { background-color: #374151; }
        .sidebar-link.active { background-color: #4B5563; color: #FFFFFF; font-weight: 600; }
        .sidebar-link svg { margin-right: 0.75rem; width: 1.25rem; height: 1.25rem; }
        .tab-button { transition: background-color 0.2s, color 0.2s; }
        .tab-button.active { background-color: #3B82F6; color: white; }
        .tab-button:not(.active) { background-color: #E5E7EB; color: #4B5563; }
        .tab-content { border-top: 1px solid #D1D5DB; }
        .detail-label { font-weight: 600; color: #4B5563; }
        .detail-value { min-height: 1.5rem; }
        .calendar-day { min-height: 120px; }
        .appointment-badge, .appointment-item {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        input::-webkit-calendar-picker-indicator {
            display: none !important;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
             position: fixed;
             inset: 0;
             background-color: rgba(255, 255, 255, 0.7);
             display: flex;
             align-items: center;
             justify-content: center;
             z-index: 9999;
         }
         .page-content {
            display: none;
         }
         .page-content.active {
            display: block;
         }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
     <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loader"></div>
    </div>


    <div id="app">
        <!-- ÁREA DE AUTENTICAÇÃO -->
        <div id="auth-view" class="h-screen flex items-center justify-center p-4">
            <!-- TELA DE LOGIN -->
            <div id="login-container" class="max-w-md w-full mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-blue-600">FisioGestão</h1>
                        <p class="text-gray-500">Acesse sua conta para continuar.</p>
                    </div>
                    <form id="login-form">
                        <div class="space-y-4">
                            <input id="login-email" type="email" placeholder="Seu e-mail" value="ellengimenes@gmail.com" class="w-full p-3 border rounded-lg" required>
                            <input id="login-password" type="password" placeholder="Sua senha" value="100200" class="w-full p-3 border rounded-lg" required>
                        </div>
                        <p id="login-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 mt-6">
                            Entrar
                        </button>
                    </form>
                    
                    <div class="mt-4 text-center">
                         <p class="text-gray-400 text-sm">ou</p>
                        <button id="google-sign-in-btn" class="w-full mt-2 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow transition duration-300">
                             <svg class="w-5 h-5 mr-2" viewBox="0 0 533.5 544.3" xmlns="http://www.w3.org/2000/svg"><path d="M533.5 272.2C533.5 253 531.5 234.7 528.2 217.4H272.2V323.2H418.5C413.9 349.5 399.7 372.1 380 388.9L380 389.2 468 458.1 468.9 458.9C523.5 407.5 533.5 340.9 533.5 272.2" fill="#4285f4"/><path d="M272.2 544.3C347.1 544.3 410.7 519.8 458.9 480.1L380 389.2C358.3 403.4 330.1 412.3 299.7 412.3C223.6 412.3 158.4 362 135.5 289.4L133 289.7L42.2 359.8L41 360.8C89.5 456 173.2 544.3 272.2 544.3" fill="#34a853"/><path d="M135.5 289.4C130.6 275.7 127.8 261 127.8 245.9C127.8 230.8 130.6 216.1 135.5 202.4L135.2 201.7L44.4 131.6L42 130.6C12.5 189.3 0 216.6 0 245.9C0 275.2 12.5 302.5 42 360.8L135.5 289.4" fill="#fbbc05"/><path d="M272.2 116.5C316.5 116.5 348.6 135.4 367.6 153.8L430.7 90.7C386.6 48.7 334.3 24.3 272.2 24.3C173.2 24.3 89.5 112.7 41 208.9L135.5 289.4C158.4 216.8 223.6 166.5 299.7 166.5C327.9 166.5 352.3 174.5 370.4 187.3L370.8 187.6L418.5 323.2H528.2C531.5 208.5 470.9 94.7 392.3 24.3L272.2 116.5" fill="#ea4335"/></svg>
                            Entrar com Google
                        </button>
                    </div>
                </div>
                <p class="text-center mt-6 text-gray-600">Não tem uma conta? <a href="#" id="show-register-btn" class="font-semibold text-blue-600 hover:underline">Cadastre sua Clínica</a></p>
            </div>

            <!-- TELA DE CADASTRO DE CLÍNICA -->
            <div id="register-container" class="max-w-2xl w-full mx-auto hidden">
                 <div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="text-center mb-6">
                        <h1 class="text-3xl font-bold text-blue-600">Cadastre sua Clínica</h1>
                        <p class="text-gray-500">Crie a conta principal da sua clínica.</p>
                    </div>
                    <form id="register-form">
                        <div class="space-y-4">
                             <div class="flex justify-center gap-6 mb-4">
                                <label class="flex items-center"><input type="radio" name="accountType" value="pf" checked class="mr-2"> Pessoa Física</label>
                                <label class="flex items-center"><input type="radio" name="accountType" value="pj" class="mr-2"> Pessoa Jurídica</label>
                            </div>

                            <!-- Campos Pessoa Física -->
                            <div id="pf-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2"><input id="pf-name" type="text" placeholder="Nome Completo" class="w-full p-2 border rounded-lg" data-mask="name"></div>
                                <div><input id="pf-birthDate" type="text" onfocus="(this.type='date')" onblur="(this.type='text')" placeholder="Data de Nascimento" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pf-rg" type="text" placeholder="RG" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pf-cpf" type="text" placeholder="CPF" class="w-full p-2 border rounded-lg" data-mask="cpf"></div>
                                <div><input id="pf-crefito" type="text" placeholder="CREFITO" class="w-full p-2 border rounded-lg"></div>

                                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                                    <div class="md:col-span-2"><input id="pf-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="pf"></div>
                                    <div class="md:col-span-4"><input id="pf-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-2"><input id="pf-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-4"><input id="pf-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pf-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pf-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                                </div>

                                <div class="md:col-span-2"><input id="pf-phone" type="tel" placeholder="Telefone" class="w-full p-2 border rounded-lg" data-mask="phone"></div>
                            </div>

                             <!-- Campos Pessoa Jurídica -->
                            <div id="pj-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2"><input id="pj-razaoSocial" type="text" placeholder="Razão Social" class="w-full p-2 border rounded-lg"></div>
                                <div><input id="pj-cnpj" type="text" placeholder="CNPJ" class="w-full p-2 border rounded-lg" data-mask="cnpj"></div>
                                <div><input id="pj-crefito" type="text" placeholder="CREFITO da Clínica" class="w-full p-2 border rounded-lg"></div>

                                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                                    <div class="md:col-span-2"><input id="pj-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="pj"></div>
                                    <div class="md:col-span-4"><input id="pj-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-2"><input id="pj-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-4"><input id="pj-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pj-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                                    <div class="md:col-span-3"><input id="pj-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                                </div>

                                <div class="md:col-span-2"><input id="pj-phone" type="tel" placeholder="Telefone Comercial" class="w-full p-2 border rounded-lg" data-mask="phone"></div>
                                <hr class="md:col-span-2 my-2"/>
                                <div class="md:col-span-2"><p class="text-sm font-semibold text-gray-600">Dados do Responsável Técnico</p></div>
                                <div class="md:col-span-2"><input id="pj-responsavel" type="text" placeholder="Nome do Responsável" class="w-full p-2 border rounded-lg" data-mask="name"></div>
                                <div><input id="pj-responsavel-cpf" type="text" placeholder="CPF do Responsável" class="w-full p-2 border rounded-lg" data-mask="cpf"></div>
                                <div><input id="pj-responsavel-crefito" type="text" placeholder="CREFITO do Responsável" class="w-full p-2 border rounded-lg"></div>
                            </div>

                            <hr class="my-2"/>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2"><p class="text-sm font-semibold text-gray-600">Dados de Acesso</p></div>
                                <div class="md:col-span-2"><input id="register-email" type="email" placeholder="Seu e-mail (será o login)" class="w-full p-2 border rounded-lg" required></div>
                                <div class="md:col-span-2"><input id="register-password" type="password" placeholder="Crie uma senha" class="w-full p-2 border rounded-lg" required></div>
                             </div>
                        </div>
                        <p id="register-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 mt-6">
                            Criar Conta e Clínica
                        </button>
                    </form>
                </div>
                <p class="text-center mt-6 text-gray-600">Já tem uma conta? <a href="#" id="show-login-btn" class="font-semibold text-blue-600 hover:underline">Entrar</a></p>
            </div>
        </div>


        <!-- PAINEL PRINCIPAL (DASHBOARD) -->
        <div id="dashboard-view" class="hidden">
            <div class="flex h-screen bg-gray-200">
                <!-- MENU LATERAL -->
                <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800 text-white flex-col transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex">
                    <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-gray-700 px-4 text-center">
                        <span id="clinic-name-sidebar" class="truncate">FisioGestão</span>
                    </div>
                    <nav class="flex-1 p-4 space-y-2">
                         <a href="#" id="nav-inicio" class="sidebar-link active">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
                            Início
                        </a>
                        <a href="#" id="nav-pacientes" class="sidebar-link">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625 .372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 12A3 3 0 1012 6a3 3 0 000 6z" /></svg>
                            Pacientes
                        </a>
                         <a href="#" id="nav-agenda" class="sidebar-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" /></svg>
                            Agenda
                        </a>
                        <a href="#" id="nav-financeiro" class="sidebar-link">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0h1.5m-1.5 0v.75m0 0v.75m0 0h1.5m0 0h.75m0 0v-.75m0 0p-.75m0 0h-.75m2.25-4.5v.75A.75.75 0 0013.5 6h-.75m0 0v-.75A.75.75 0 0013.5 4.5h.75m0 0h1.5m-1.5 0v.75m0 0v.75m0 0h1.5m0 0h.75m0 0v-.75m0 0p-.75m-2.25-4.5v.75a.75.75 0 00.75.75h.75m0 0v-.75a.75.75 0 00-.75-.75h-.75m2.25 4.5v.75a.75.75 0 01-.75.75h-.75m0 0v-.75a.75.75 0 01.75-.75h.75M9 12.75l.75-1.036m0 0l.75-1.036m-1.5 2.072L9 12.75M9 12.75l-.75 1.036m0 0l-.75 1.036m1.5-2.072L9 12.75m-7.5 6.75h.008v.008H1.5v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            Financeiro
                        </a>
                        <a href="#" id="nav-configuracoes" class="sidebar-link">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226.554-.22 1.19-.22 1.744 0 .55.219 1.02.684 1.11 1.226l.044.261a3.75 3.75 0 015.334 2.336l.33.024c.543.04 1.06.318 1.41.744.352.425.504.994.424 1.548l-.043.262a3.75 3.75 0 01-2.336 5.334l-.024.33a1.5 1.5 0 01-.744 1.41c-.352.425-.994.504-1.548.424l-.262-.043a3.75 3.75 0 01-5.334-2.336l-.33-.024a1.5 1.5 0 01-1.41-.744c-.352-.425-.504-.994-.424-1.548l.043-.262a3.75 3.75 0 012.336-5.334l.024-.33a1.5 1.5 0 01.744-1.41zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" /></svg>
                            Configurações
                        </a>
                    </nav>
                    <div class="p-4 border-t border-gray-700">
                        <p class="text-sm text-gray-400">Usuário:</p>
                        <strong id="user-email" class="font-mono text-sm break-words">...</strong>
                        
                        <button id="logout-btn" class="w-full mt-2 text-center text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg">Sair</button>
                    </div>
                </aside>
                <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
                <div class="flex-1 flex flex-col overflow-hidden">
                    <header class="bg-white shadow-md md:hidden">
                        <div class="flex items-center justify-between p-4">
                             <button id="mobile-menu-btn" class="text-gray-500 focus:outline-none">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            </button>
                            <h1 class="text-xl font-bold text-blue-600">FisioGestão</h1>
                            <div class="w-6"></div>
                        </div>
                    </header>
                    <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                        <div id="main-content">

                            <!-- Página Início -->
                            <div id="page-inicio" class="page-content">
                                <div>
                                    <h2 class="text-3xl font-semibold mb-6">Início</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <div class="bg-white p-6 rounded-lg shadow-lg">
                                            <h3 class="font-bold text-lg mb-4">Agendamentos de Hoje</h3>
                                            <div id="today-appointments" class="space-y-3 max-h-60 overflow-y-auto">
                                                <p class="text-gray-500">Nenhum agendamento para hoje.</p>
                                            </div>
                                        </div>
                                        <div class="bg-white p-6 rounded-lg shadow-lg">
                                            <h3 class="font-bold text-lg mb-2">Pacientes Ativos</h3>
                                            <p id="active-patients-count" class="text-5xl font-bold text-blue-600">0</p>
                                        </div>
                                        <div class="bg-white p-6 rounded-lg shadow-lg">
                                            <h3 class="font-bold text-lg mb-4">Acesso Rápido</h3>
                                            <div class="flex flex-col space-y-3">
                                                 <button id="quick-add-patient-btn" class="w-full text-left bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition">
                                                    + Adicionar Paciente
                                                </button>
                                                 <button id="quick-add-appointment-btn" class="w-full text-left bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition">
                                                    + Novo Agendamento
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Página Pacientes -->
                            <div id="page-pacientes" class="page-content">
                                <div id="patient-list-view">
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                        <div>
                                            <h2 class="text-2xl font-semibold">Pacientes</h2>
                                            <p class="text-gray-500">Gerencie seus pacientes cadastrados.</p>
                                        </div>
                                        <div class="flex items-center gap-4 w-full sm:w-auto">
                                            <input type="search" id="search-patient" placeholder="Pesquisar paciente..." class="w-full sm:w-64 p-2 border rounded-lg">
                                            <button id="add-patient-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                                                + Adicionar
                                            </button>
                                        </div>
                                    </div>
                                    <div id="patients-container-wrapper">
                                        <p class="text-center py-16 text-gray-500" id="loading-patients-msg">Carregando dados dos pacientes...</p>
                                        <div id="patients-container" class="hidden bg-white rounded-lg shadow-lg overflow-hidden divide-y divide-gray-200">
                                            <!-- Pacientes renderizados pela JS -->
                                        </div>
                                        <div id="no-patients-message" class="hidden text-center py-12 bg-white rounded-lg shadow"><p class="text-gray-500">Nenhum paciente encontrado.</p></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Página Agenda -->
                            <div id="page-agenda" class="page-content">
                                <div>
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                        <div>
                                            <h2 class="text-2xl font-semibold">Agenda</h2>
                                            <p class="text-gray-500">Visualize e gerencie seus agendamentos.</p>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-2">
                                            <button id="add-appointment-agenda-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                                                + Novo Agendamento
                                            </button>
                                            <input type="search" id="search-appointment" placeholder="Buscar paciente..." class="p-2 border rounded-lg">
                                            <div class="flex items-center bg-gray-200 rounded-lg p-1">
                                                <button id="agenda-view-daily" class="px-3 py-1 text-sm font-semibold rounded-md">Diária</button>
                                                <button id="agenda-view-weekly" class="px-3 py-1 text-sm font-semibold rounded-md">Semanal</button>
                                                <button id="agenda-view-monthly" class="px-3 py-1 text-sm font-semibold rounded-md">Mensal</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center justify-center gap-4 mb-4">
                                        <button id="prev-period-btn" class="p-2 rounded-full bg-white shadow hover:bg-gray-100">&larr;</button>
                                        <h3 id="period-header" class="text-xl font-bold w-auto text-center"></h3>
                                        <button id="next-period-btn" class="p-2 rounded-full bg-white shadow hover:bg-gray-100">&rarr;</button>
                                    </div>

                                    <div id="agenda-content">
                                        <!-- O conteúdo da agenda será inserido aqui -->
                                    </div>
                                </div>
                            </div>

                            <!-- Página Financeiro -->
                            <div id="page-financeiro" class="page-content">
                                 <div>
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                        <div>
                                            <h2 class="text-2xl font-semibold">Financeiro</h2>
                                            <p class="text-gray-500">Gerencie os pagamentos dos pacientes.</p>
                                        </div>
                                         <button id="add-payment-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                                            + Lançar Pagamento
                                        </button>
                                    </div>
                                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm text-left text-gray-500">
                                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                    <tr>
                                                        <th scope="col" class="px-6 py-3">Data</th>
                                                        <th scope="col" class="px-6 py-3">Paciente</th>
                                                        <th scope="col" class="px-6 py-3">Valor</th>
                                                        <th scope="col" class="px-6 py-3">Status</th>
                                                        <th scope="col" class="px-6 py-3">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="payments-table-body">
                                                   <tr><td colspan="5" class="text-center p-8">Carregando lançamentos...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Página Configurações -->
                            <div id="page-configuracoes" class="page-content">
                                <div id="admin-view" class="space-y-8">
                                     <div>
                                        <h2 class="text-3xl font-semibold">Configurações</h2>
                                        <p class="text-gray-500">Gerencie os dados da clínica e sua equipe.</p>
                                    </div>

                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-2">
                                            <h3 class="text-xl font-semibold">Dados da Clínica</h3>
                                            <div class="flex flex-wrap gap-2">
                                                <button id="config-change-password-btn" class="text-sm bg-yellow-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-600">Alterar Minha Senha</button>
                                                <button id="edit-clinic-data-btn" class="text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Editar Dados</button>
                                            </div>
                                        </div>
                                        <div id="clinic-data-display" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                                            <!-- Dados da clínica serão exibidos aqui -->
                                        </div>
                                    </div>

                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <h3 class="text-xl font-semibold mb-4">Preferências</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label for="default-agenda-view" class="block text-sm font-medium text-gray-700">Visualização Padrão da Agenda</label>
                                                <select id="default-agenda-view" class="mt-1 w-full p-2 border rounded-lg">
                                                    <option value="monthly">Mensal</option>
                                                    <option value="weekly">Semanal</option>
                                                    <option value="daily">Diária</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="default-service-type" class="block text-sm font-medium text-gray-700">Tipo de Atendimento Padrão</label>
                                                <select id="default-service-type" class="mt-1 w-full p-2 border rounded-lg">
                                                    <option value="local">Local (na Clínica)</option>
                                                    <option value="domiciliar">Domiciliar</option>
                                                </select>
                                            </div>
                                        </div>
                                         <div class="mt-6 flex justify-end">
                                            <button id="save-preferences-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-blue-700 transition">Salvar Preferências</button>
                                        </div>
                                    </div>

                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-2">
                                            <h3 class="text-xl font-semibold">Membros da Equipe</h3>
                                        </div>
                                        <div id="members-list" class="space-y-4">
                                            <!-- Membros serão listados aqui -->
                                        </div>
                                    </div>

                                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-2">
                                            <h3 class="text-xl font-semibold">Salas de Atendimento</h3>
                                            <button id="add-room-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition">+ Nova Sala</button>
                                        </div>
                                        <div id="rooms-list" class="space-y-4">
                                            <!-- Salas serão listadas aqui -->
                                        </div>
                                    </div>

                                     <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                                        <h3 class="text-xl font-semibold mb-4">Criar Novo Membro</h3>
                                        <form id="create-user-form" class="flex flex-col sm:flex-row items-end gap-4">
                                            <div class="w-full">
                                                <label for="new-user-email" class="block text-sm font-medium text-gray-700">E-mail do Novo Membro</label>
                                                <input type="email" id="new-user-email" class="mt-1 w-full p-2 border rounded-lg" required>
                                            </div>
                                            <div class="w-full sm:w-auto">
                                                 <label for="new-user-role" class="block text-sm font-medium text-gray-700">Função</label>
                                                 <select id="new-user-role" class="mt-1 w-full p-2 border rounded-lg" required>
                                                    <option value="fisioterapeuta">Fisioterapeuta</option>
                                                    <option value="secretaria">Secretária</option>
                                                    <option value="admin">Admin</option>
                                                 </select>
                                            </div>
                                            <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-blue-700 transition">Criar</button>
                                        </form>
                                         <p id="create-user-feedback" class="text-sm mt-4 h-4"></p>
                                    </div>
                                </div>
                                <div id="non-admin-view" class="hidden text-center p-16 bg-white rounded-lg shadow-lg">
                                     <h2 class="text-3xl font-bold text-red-600">Acesso Negado</h2>
                                     <p class="text-gray-500 mt-2">Esta página só pode ser acessada por administradores.</p>
                                </div>
                            </div>

                        </div> <!-- Fim do main-content -->
                    </main>
                </div>
            </div>
        </div>

    <!-- ================================== -->
    <!-- == INÍCIO DOS MODAIS CORRIGIDOS == -->
    <!-- ================================== -->

    <!-- MODAL PARA EXIBIÇÃO DE MENSAGENS -->
    <div id="js-message-modal" class="fixed inset-0 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 sm:m-8 max-w-sm w-full">
            <h3 id="js-message-title" class="text-xl font-bold mb-3 text-blue-600">Mensagem</h3>
            <p id="js-message-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button id="js-message-close" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMAÇÃO -->
    <div id="confirm-modal" class="fixed inset-0 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmar Ação</h3>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">Você tem certeza?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirm-modal-confirm" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE OPÇÕES DE RECORRÊNCIA -->
    <div id="recurrence-options-modal" class="fixed inset-0 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
            <h3 id="recurrence-options-title" class="text-xl font-bold mb-4">Editar evento recorrente</h3>
            <p id="recurrence-options-text" class="text-gray-600 mb-6">Como você gostaria de salvar as alterações?</p>
            <div class="flex flex-col space-y-3">
                <button id="recurrence-option-single" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Somente este evento</button>
                <button id="recurrence-option-future" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Este e os eventos futuros</button>
                <button id="recurrence-option-cancel" class="w-full mt-4 bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- Datalists -->
    <datalist id="patient-list"></datalist>

    <!-- MODAL PARA ALTERAR SENHA -->
    <div id="force-password-change-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-md w-full max-h-[90vh] flex flex-col">
            <form id="force-password-change-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="password-modal-title" class="text-2xl font-bold">Alterar Senha</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <!-- CORPO ROLÁVEL -->
                <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <p id="password-modal-description" class="text-gray-600 text-sm">Por segurança, confirme sua senha atual para definir uma nova.</p>
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-700">Senha Atual</label>
                        <input type="password" id="current-password" class="mt-1 w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                        <input type="password" id="new-password" class="mt-1 w-full p-2 border rounded-lg" required>
                        <p class="text-xs text-gray-500 mt-1">Mínimo 8 caracteres.</p>
                    </div>
                     <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirme a Nova Senha</label>
                        <input type="password" id="confirm-new-password" class="mt-1 w-full p-2 border rounded-lg" required>
                    </div>
                     <p id="force-password-change-error" class="text-red-500 text-sm text-center h-4"></p>
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-end bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition">Salvar Nova Senha</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Salas -->
    <div id="room-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-lg w-full max-h-[90vh] flex flex-col">
            <form id="room-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="room-modal-title" class="text-2xl font-bold">Adicionar Sala</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <!-- CORPO ROLÁVEL -->
                <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <input type="hidden" id="room-id">
                    <div>
                        <label for="room-name" class="block text-sm font-medium text-gray-700">Nome da Sala</label>
                        <input type="text" id="room-name" class="mt-1 w-full p-2 border rounded-lg" required>
                    </div>
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" id="cancel-room-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edição da Clínica -->
    <div id="clinic-edit-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <form id="clinic-edit-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 class="text-2xl font-bold">Editar Dados da Clínica</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <!-- CORPO ROLÁVEL -->
                <div class="p-6 overflow-y-auto flex-1" id="clinic-edit-form-fields">
                    <!-- Campos de edição serão injetados aqui -->
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" id="cancel-clinic-edit-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Prontuário do Paciente -->
    <div id="patient-record-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-5xl w-full max-h-[95vh] flex flex-col">
            <!-- CABEÇALHO FIXO -->
            <div class="p-6 border-b flex justify-between items-start flex-shrink-0">
                <div>
                    <h2 id="record-modal-patient-name" class="text-3xl font-bold">Prontuário do Paciente</h2>
                    <div id="record-modal-patient-info" class="grid grid-cols-1 md:grid-cols-3 gap-x-6 text-sm text-gray-600 mt-2">
                        <!-- Detalhes do paciente serão inseridos aqui -->
                    </div>
                </div>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <!-- ÁREA DE BOTÕES -->
            <div class="p-4 flex flex-wrap gap-2 border-b bg-gray-50 flex-shrink-0">
                <button id="record-modal-add-initial-assessment-btn" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-yellow-600 transition duration-300 whitespace-nowrap text-sm">+ Nova Avaliação Inicial</button>
                <button id="record-modal-add-evolution-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition duration-300 whitespace-nowrap text-sm">+ Nova Evolução</button>
                <button id="record-modal-add-discharge-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition duration-300 whitespace-nowrap text-sm">+ Alta</button>
            </div>
            <!-- CORPO ROLÁVEL -->
            <div class="p-6 overflow-y-auto flex-1">
                <h3 class="text-2xl font-semibold mb-4">Histórico de Evolução</h3>
                <div id="record-modal-assessments-container" class="space-y-4">
                    <!-- Lista de evoluções será renderizada aqui -->
                </div>
                <div id="record-modal-no-assessments-message" class="hidden text-center py-8 text-gray-500"><p>Nenhuma evolução registrada.</p></div>
            </div>
            <!-- RODAPÉ FIXO -->
            <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                <button type="button" id="cancel-patient-record-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Modal de Agendamento -->
    <div id="appointment-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-2xl w-full max-h-[95vh] flex flex-col">
            <form id="appointment-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="appointment-modal-title" class="text-2xl font-bold">Novo Agendamento</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <!-- CORPO ROLÁVEL -->
                <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <input type="hidden" id="appointment-id">
                    <input type="hidden" id="appointment-date">
                    <input type="hidden" id="appointment-recurrence-id">
                    <div>
                        <label for="appointment-patient-input" class="block text-sm font-medium text-gray-700">Paciente</label>
                        <input type="text" id="appointment-patient-input" list="patient-list" class="mt-1 w-full p-2 border rounded-lg" placeholder="Digite para buscar..." required autocomplete="off">
                        <input type="hidden" id="appointment-patient-id">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Atendimento</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center"><input type="radio" name="serviceType" value="local" class="mr-2" checked> Local (Clínica)</label>
                            <label class="flex items-center"><input type="radio" name="serviceType" value="domiciliar" class="mr-2"> Domiciliar</label>
                        </div>
                    </div>
                    <div>
                        <label for="appointment-professional" class="block text-sm font-medium text-gray-700">Profissional</label>
                        <select id="appointment-professional" class="mt-1 w-full p-2 border rounded-lg" required></select>
                    </div>
                    <div id="sala-container">
                        <label for="appointment-room" class="block text-sm font-medium text-gray-700">Sala</label>
                        <select id="appointment-room" class="mt-1 w-full p-2 border rounded-lg" required></select>
                    </div>
                    <div id="domiciliar-container" class="hidden space-y-2 border p-3 rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700">Endereço do Atendimento</label>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div class="md:col-span-2"><input id="appointment-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="appointment"></div>
                            <div class="md:col-span-4"><input id="appointment-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-2"><input id="appointment-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-4"><input id="appointment-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="appointment-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="appointment-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="appointment-time" class="block text-sm font-medium text-gray-700">Horário</label>
                             <input type="time" id="appointment-time" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                         <div>
                             <label for="appointment-duration" class="block text-sm font-medium text-gray-700">Duração (min)</label>
                             <input type="number" id="appointment-duration" value="50" min="1" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                    </div>
                    <div>
                        <label for="appointment-notes" class="block text-sm font-medium text-gray-700">Observações</label>
                        <textarea id="appointment-notes" rows="3" class="mt-1 w-full p-2 border rounded-lg"></textarea>
                    </div>
                    
                    <!-- RECORRÊNCIA (A VISIBILIDADE É CONTROLADA VIA JS) -->
                    <div id="recurrence-section" class="space-y-3 border-t pt-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="recurrence-toggle" class="mr-2 h-4 w-4">
                            Repetir agendamento
                        </label>
                        <div id="recurrence-container" class="hidden space-y-3 p-3 bg-gray-50 rounded-lg">
                            <div>
                                <label for="recurrence-count" class="block text-sm font-medium text-gray-700">Quantidade de sessões</label>
                                <input type="number" id="recurrence-count" value="8" min="1" max="52" class="mt-1 w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Dias da semana</label>
                                <div id="recurrence-days" class="flex flex-wrap gap-x-4 gap-y-2 mt-2 text-sm">
                                    <label class="flex items-center"><input type="checkbox" name="weekday" value="1" class="mr-1">Seg</label>
                                    <label class="flex items-center"><input type="checkbox" name="weekday" value="2" class="mr-1">Ter</label>
                                    <label class="flex items-center"><input type="checkbox" name="weekday" value="3" class="mr-1">Qua</label>
                                    <label class="flex items-center"><input type="checkbox" name="weekday" value="4" class="mr-1">Qui</label>
                                    <label class="flex items-center"><input type="checkbox" name="weekday" value="5" class="mr-1">Sex</label>
                                    <label class="flex items-center"><input type="checkbox" name="weekday" value="6" class="mr-1">Sáb</label>
                                    <label class="flex items-center"><input type="checkbox" name="weekday" value="0" class="mr-1">Dom</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-between space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" id="delete-appointment-btn" class="bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition hidden">Excluir</button>
                    <div class="flex space-x-4">
                        <button type="button" id="cancel-appointment-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Lançamento Financeiro -->
     <div id="financial-record-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-lg w-full max-h-[90vh] flex flex-col">
            <form id="financial-record-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="financial-modal-title" class="text-2xl font-bold">Lançar Pagamento</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <!-- CORPO ROLÁVEL -->
                <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <input type="hidden" id="financial-record-id">
                    <div>
                        <label for="financial-patient-input" class="block text-sm font-medium text-gray-700">Paciente</label>
                        <input type="text" id="financial-patient-input" list="patient-list" class="mt-1 w-full p-2 border rounded-lg" placeholder="Digite para buscar..." required autocomplete="off">
                        <input type="hidden" id="financial-patient-id">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="financial-date" class="block text-sm font-medium text-gray-700">Data</label>
                             <input type="date" id="financial-date" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                         <div>
                            <label for="financial-value" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                            <input type="number" step="0.01" id="financial-value" placeholder="100.00" class="w-full p-2 border rounded-lg" required>
                        </div>
                    </div>
                     <div>
                         <label for="financial-status" class="block text-sm font-medium text-gray-700">Status</label>
                         <select id="financial-status" class="mt-1 w-full p-2 border rounded-lg" required>
                            <option value="pago">Pago</option>
                            <option value="pendente">Pendente</option>
                         </select>
                    </div>
                    <div>
                        <label for="financial-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                        <textarea id="financial-description" rows="3" class="mt-1 w-full p-2 border rounded-lg" placeholder="Ex: Pacote de 10 sessões"></textarea>
                    </div>
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" id="cancel-financial-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalhes Rápidos do Paciente -->
     <div id="patient-quick-view-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-xl w-full max-h-[90vh] flex flex-col">
            <!-- CABEÇALHO FIXO -->
            <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                <h2 id="quick-view-patient-name" class="text-2xl font-bold">Detalhes do Paciente</h2>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <!-- CORPO ROLÁVEL -->
            <div class="p-6 space-y-4 text-gray-700 overflow-y-auto flex-1" id="patient-quick-view-content">
                <p><strong class="font-semibold">Idade:</strong> <span id="quick-view-age"></span></p>
                <p><strong class="font-semibold">Telefone:</strong> <span id="quick-view-phone"></span></p>
                <p><strong class="font-semibold">CPF:</strong> <span id="quick-view-cpf"></span></p>
                <p><strong class="font-semibold">Endereço:</strong> <span id="quick-view-address"></span></p>
                <p><strong class="font-semibold">Responsável:</strong> <span id="quick-view-caregiver"></span></p>
                <p><strong class="font-semibold">Observações:</strong> <span id="quick-view-observations" class="whitespace-pre-wrap"></span></p>
            </div>
            <!-- RODAPÉ FIXO -->
             <div class="p-6 flex justify-end bg-gray-50 rounded-b-lg flex-shrink-0">
                <button type="button" id="cancel-patient-quick-view-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alterar Função -->
    <div id="change-role-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-sm w-full max-h-[90vh] flex flex-col">
            <form id="change-role-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 class="text-2xl font-bold">Alterar Função</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                 <!-- CORPO ROLÁVEL -->
                 <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <input type="hidden" id="change-role-user-id">
                    <p>Alterar função de <strong id="change-role-user-email"></strong> para:</p>
                    <select id="change-role-select" class="w-full p-2 border rounded-lg" required>
                        <option value="fisioterapeuta">Fisioterapeuta</option>
                        <option value="secretaria">Secretária</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" id="cancel-change-role-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Paciente (Adicionar/Editar) -->
    <div id="patient-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-3xl w-full max-h-[95vh] flex flex-col">
             <form id="patient-form" class="flex flex-col flex-1 min-h-0">
                 <!-- CABEÇALHO FIXO -->
                 <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="patient-modal-title" class="text-2xl font-bold">Adicionar Novo Paciente</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                 </div>
                 <!-- CORPO ROLÁVEL -->
                 <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <input type="hidden" id="patient-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><input id="patient-name" type="text" placeholder="Nome Completo" class="w-full p-2 border rounded" required data-mask="name"></div>
                        <div><input id="patient-cpf" type="text" placeholder="CPF" class="w-full p-2 border rounded" data-mask="cpf"></div>
                        <div><input id="patient-birthDate" type="date" placeholder="Data de Nascimento" class="w-full p-2 border rounded" required></div>
                        <div>
                            <select id="patient-gender" class="w-full p-2 border rounded" required>
                                <option value="" disabled selected>Sexo</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div><input id="patient-phone" type="tel" placeholder="Telefone" class="w-full p-2 border rounded" data-mask="phone"></div>
                        <div class="md:col-span-2"><input id="patient-caregiver" type="text" placeholder="Responsável/Cuidador (Opcional)" class="w-full p-2 border rounded" data-mask="name"></div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                            <div class="md:col-span-2"><input id="patient-cep" type="text" placeholder="CEP" class="w-full p-2 border rounded-lg" data-form-prefix="patient"></div>
                            <div class="md:col-span-4"><input id="patient-street" type="text" placeholder="Rua / Endereço" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-2"><input id="patient-number" type="text" placeholder="Número" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-4"><input id="patient-neighborhood" type="text" placeholder="Bairro" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="patient-city" type="text" placeholder="Cidade" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="patient-state" type="text" placeholder="Estado (UF)" class="w-full p-2 border rounded-lg"></div>
                        </div>
                        <div class="md:col-span-2"><textarea id="patient-observations" placeholder="Observações" class="w-full p-2 border rounded" rows="3"></textarea></div>
                    </div>
                </div>
                 <!-- RODAPÉ FIXO -->
                 <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" id="cancel-patient-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Avaliação Inicial -->
    <div id="assessment-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop sub-modal">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-4xl w-full max-h-[95vh] flex flex-col">
            <form id="assessment-form" data-type="initial" class="flex flex-col flex-1 min-h-0">
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="assessment-modal-title" class="text-2xl font-bold">Nova Avaliação Inicial</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                
                <div class="flex-shrink-0">
                    <div class="p-4 border-b">
                        <label for="assessment-professional" class="block text-sm font-medium text-gray-700">Profissional Responsável</label>
                        <select id="assessment-professional" class="mt-1 w-full p-2 border rounded-lg" required></select>
                    </div>
                    <div class="p-4 flex flex-wrap gap-2 border-b">
                        <button type="button" data-tab="tab1" class="tab-button active font-semibold py-2 px-4 rounded-lg text-sm">1. Histórico</button>
                        <button type="button" data-tab="tab2" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">2. Cognitivo</button>
                        <button type="button" data-tab="tab3" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">3. Físico</button>
                        <button type="button" data-tab="tab4" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">4. Funcional</button>
                        <button type="button" data-tab="tab5" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">5. Ambiente</button>
                        <button type="button" data-tab="tab6" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">6. Objetivos</button>
                    </div>
                </div>

                <div class="p-6 overflow-y-auto flex-1">
                    <div id="tab1" class="tab-content space-y-4">
                        <h3 class="font-bold text-lg">Histórico Clínico</h3>
                        <div class="grid grid-cols-1 gap-4">
                             <div><label class="block text-sm font-medium">Diagnóstico Médico Principal</label><input id="diag-medico" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Comorbidades</label><input id="comorbidades" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Medicações em uso</label><input id="medicacoes" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Internações/Cirurgias Prévias</label><input id="cirurgias" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Principais Queixas</label><textarea id="queixas" class="w-full p-2 border rounded" rows="3"></textarea></div>
                            <div>
                                <label class="block text-sm font-medium">Dor (EVA 0-10)</label>
                                <select id="dor-eva" class="w-full p-2 border rounded">
                                    <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                    <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                                </select>
                            </div>
                            <div id="dor-local-container" class="hidden"><label class="block text-sm font-medium">Local da Dor</label><input id="dor-local" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Hábitos (tabagismo, sono, alimentação...)</label><textarea id="habitos" class="w-full p-2 border rounded" rows="3"></textarea></div>
                        </div>
                    </div>
                    <div id="tab2" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Aspectos Cognitivos e Emocionais</h3>
                        <div class="grid grid-cols-1 gap-4">
                             <div><label class="block text-sm font-medium">Estado de Consciência</label><select id="consciencia" class="w-full p-2 border rounded"><option>Alerta</option><option>Confuso</option><option>Sonolento</option></select></div>
                             <div><label class="block text-sm font-medium">Orientação</label><select id="orientacao" class="w-full p-2 border rounded"><option>Tempo</option><option>Espaço</option><option>Pessoa</option></select></div>
                             <div><label class="block text-sm font-medium">Comunicação</label><input id="comunicacao" type="text" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>
                    <div id="tab3" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Avaliação Física</h3>
                        <div class="grid grid-cols-1 gap-4">
                              <div><label class="block text-sm font-medium">Postura</label><input id="postura" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Marcha</label><input id="marcha" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Equilíbrio</label><input id="equilibrio" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">ADM</label><input id="adm" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Força Muscular (0-5)</label><select id="forca" class="w-full p-2 border rounded"><option>0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                              <div><label class="block text-sm font-medium">Tônus</label><input id="tonus" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Coordenação Motora</label><input id="coordenacao" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Sensibilidade</label><input id="sensibilidade" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Edema</label><select id="edema" class="w-full p-2 border rounded"><option>Não</option><option>Sim</option></select></div>
                              <div id="edema-local-container" class="hidden"><label class="block text-sm font-medium">Local/Descrição do Edema</label><input id="edema-local" type="text" class="w-full p-2 border rounded"></div>
                              <div><label class="block text-sm font-medium">Testes Realizados</label><textarea id="testes-realizados" class="w-full p-2 border rounded" rows="3"></textarea></div>
                        </div>
                    </div>
                    <div id="tab4" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Funcionalidade (AVDs)</h3>
                        <div class="grid grid-cols-1 gap-6">
                            <div><label class="block font-medium">Banho</label><div class="flex gap-4 mt-2"><label><input type="radio" name="banho" value="Independente"> Independente</label><label><input type="radio" name="banho" value="Parcial"> Parcial</label><label><input type="radio" name="banho" value="Dependente"> Dependente</label></div></div>
                            <div><label class="block font-medium">Vestir-se</label><div class="flex gap-4 mt-2"><label><input type="radio" name="vestir" value="Independente"> Independente</label><label><input type="radio" name="vestir" value="Parcial"> Parcial</label><label><input type="radio" name="vestir" value="Dependente"> Dependente</label></div></div>
                            <div><label class="block font-medium">Alimentação</label><div class="flex gap-4 mt-2"><label><input type="radio" name="alimentacao" value="Independente"> Independente</label><label><input type="radio" name="alimentacao" value="Parcial"> Parcial</label><label><input type="radio" name="alimentacao" value="Dependente"> Dependente</label></div></div>
                            <div><label class="block font-medium">Continência</label><div class="flex gap-4 mt-2"><label><input type="radio" name="continencia" value="Sim"> Sim</label><label><input type="radio" name="continencia" value="Não"> Não</label></div></div>
                            <div><label class="block font-medium">Uso de Fraldas</label><div class="flex gap-4 mt-2"><label><input type="radio" name="fraldas" value="Sim"> Sim</label><label><input type="radio" name="fraldas" value="Não"> Não</label></div></div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 pt-4">
                             <div><label class="block text-sm font-medium">Transferências</label><input id="transferencias" type="text" class="w-full p-2 border rounded"></div>
                             <div><label class="block text-sm font-medium">Deambulacao</label><input id="deambulacao" type="text" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>
                    <div id="tab5" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Ambiente Domiciliar</h3>
                         <div class="grid grid-cols-1 gap-6">
                            <div><label class="block font-medium">Tipo de Residência</label><div class="flex gap-4 mt-2"><label><input type="radio" name="residencia" value="Casa"> Casa</label><label><input type="radio" name="residencia" value="Apartamento"> Apto</label><label><input type="radio" name="residencia" value="Outros"> Outros</label></div></div>
                            <div><label class="block font-medium">Iluminação</label><div class="flex gap-4 mt-2"><label><input type="radio" name="iluminacao" value="Adequada"> Adequada</label><label><input type="radio" name="iluminacao" value="Inadequada"> Inadequada</label></div></div>
                            <div><label class="block font-medium">Espaço para Exercícios</label><div class="flex gap-4 mt-2"><label><input type="radio" name="espaco" value="Sim"> Sim</label><label><input type="radio" name="espaco" value="Não"> Não</label></div></div>
                            <div><label><input type="checkbox" name="barreiras" value="Escadas"> Escadas</label><label><input type="checkbox" name="barreiras" value="Tapetes"> Tapetes</label><label><input type="checkbox" name="barreiras" value="Falta de barras"> Falta de barras</label></div></div>
                        </div>
                    </div>
                    <div id="tab6" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Objetivos da Fisioterapia</h3>
                        <div class="grid grid-cols-1 gap-6">
                            <label class="block text-sm font-medium">Defina os objetivos de curto, médio e longo prazo.</label><textarea id="objetivos" class="w-full p-2 border rounded" rows="8"></textarea>
                        </div>
                    </div>
                </div>
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition close-modal-btn">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Evolução Simples -->
    <div id="evolution-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop sub-modal">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-2xl w-full max-h-[95vh] flex flex-col">
            <form id="evolution-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="evolution-modal-title" class="text-2xl font-bold">Novo Registro de Evolução</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <!-- ÁREA NÃO-ROLÁVEL (PROFISSIONAL) -->
                <div class="p-4 border-b flex-shrink-0">
                    <label for="evolution-professional" class="block text-sm font-medium text-gray-700">Profissional Responsável</label>
                    <select id="evolution-professional" class="mt-1 w-full p-2 border rounded-lg" required></select>
                </div>
                <!-- CORPO ROLÁVEL -->
                <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="evolution-date" class="block text-sm font-medium text-gray-700">Data do Atendimento</label>
                            <input type="date" id="evolution-date" class="mt-1 w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="evolution-session-number" class="block text-sm font-medium text-gray-700">Nº da Sessão</label>
                            <input type="number" id="evolution-session-number" class="mt-1 w-full p-2 border rounded-lg" required min="1" readonly>
                        </div>
                    </div>
                    <div>
                        <label for="evolution-procedures" class="block text-sm font-medium text-gray-700">Procedimentos Realizados</label>
                        <textarea id="evolution-procedures" rows="5" class="mt-1 w-full p-2 border rounded-lg" placeholder="Ex: Mobilização articular, Cinesioterapia..."></textarea>
                    </div>
                    <div>
                        <label for="evolution-response" class="block text-sm font-medium text-gray-700">Resposta do Paciente</label>
                        <textarea id="evolution-response" rows="5" class="mt-1 w-full p-2 border rounded-lg" placeholder="Ex: Relatou diminuição da dor..."></textarea>
                    </div>
                    <div>
                        <label for="evolution-notes" class="block text-sm font-medium text-gray-700">Observações/Intercorrências</label>
                        <textarea id="evolution-notes" rows="4" class="mt-1 w-full p-2 border rounded-lg" placeholder="Ex: Paciente chegou atrasado..."></textarea>
                    </div>
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-end space-x-4 bg-gray-50 rounded-b-lg flex-shrink-0">
                    <button type="button" id="cancel-evolution-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Salvar Evolução</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Alta (Discharge) -->
    <div id="discharge-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop sub-modal">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-4xl w-full max-h-[95vh] flex flex-col">
            <form id="discharge-form" class="flex flex-col flex-1 min-h-0">
                <!-- CABEÇALHO FIXO -->
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="discharge-modal-title" class="text-2xl font-bold">Alta Fisioterapêutica</h2>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <!-- ÁREA NÃO-ROLÁVEL (PROFISSIONAL E ABAS) -->
                <div class="flex-shrink-0">
                    <div class="p-4 border-b">
                        <label for="discharge-professional" class="block text-sm font-medium text-gray-700">Profissional Responsável pela Alta</label>
                        <select id="discharge-professional" class="mt-1 w-full p-2 border rounded-lg" required></select>
                    </div>
                    <div class="p-4 flex flex-wrap gap-2 border-b">
                        <button type="button" data-tab="discharge-tab1" class="tab-button active font-semibold py-2 px-4 rounded-lg text-sm">1. Queixas Finais</button>
                        <button type="button" data-tab="discharge-tab3" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">2. Avaliação Final</button>
                        <button type="button" data-tab="discharge-tab7" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">3. Desfecho</button>
                    </div>
                </div>
                <!-- CORPO ROLÁVEL (CONTEÚDO DAS ABAS) -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div id="discharge-tab1" class="tab-content space-y-4">
                        <h3 class="font-bold text-lg">Estado Final: Queixas e Dor (EVA)</h3>
                        <div><label class="block text-sm font-medium">Queixas do Paciente no Momento da Alta</label><textarea id="discharge-queixas-finais" class="w-full p-2 border rounded" rows="3"></textarea></div>
                         <div>
                            <label class="block text-sm font-medium">Dor (EVA 0-10)</label>
                            <select id="discharge-dor-eva" class="w-full p-2 border rounded">
                                <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                            </select>
                        </div>
                    </div>
                    <div id="discharge-tab3" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Avaliação Física Final (Resumo)</h3>
                        <div><label class="block text-sm font-medium">Marcha e Equilíbrio</label><input id="discharge-marcha-equilibrio" type="text" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm font-medium">ADM (Amplitude de Movimento) e Força</label><input id="discharge-adm-forca" type="text" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm font-medium">Capacidade Funcional (AVDs)</label><textarea id="discharge-funcionalidade" class="w-full p-2 border rounded" rows="3" placeholder="Ex: Deambulação sem auxílio, Independente para banho e vestir."></textarea></div>
                    </div>
                    <div id="discharge-tab7" class="tab-content hidden space-y-4">
                        <h3 class="font-bold text-lg">Resultados, Motivo e Próximos Passos</h3>
                        <div><label class="block text-sm font-medium">Resultados Obtidos da Fisioterapia</label><textarea id="discharge-resultados" class="w-full p-2 border rounded" rows="5" placeholder="Descreva o que foi alcançado em relação aos objetivos iniciais."></textarea></div>
                        <div><label class="block text-sm font-medium">Motivo da Alta / Próximos Passos</label><textarea id="discharge-motivo" class="w-full p-2 border rounded" rows="3" placeholder="Ex: Objetivos atingidos, Encaminhamento para outro especialista, Desistência."></textarea></div>
                    </div>
                </div>
                <!-- RODAPÉ FIXO -->
                <div class="p-6 flex justify-end space-x-4 border-t flex-shrink-0">
                    <button type="button" id="cancel-discharge-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirmar Alta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalhes da Avaliação/Evolução -->
    <div id="assessment-detail-modal" class="fixed inset-0 items-center justify-center hidden overflow-auto modal-backdrop sub-modal">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-4xl w-full max-h-[95vh] flex flex-col">
            <!-- CABEÇALHO FIXO -->
            <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                <h2 class="text-2xl font-bold">Detalhes do Registro Clínico</h2>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <!-- ÁREA NÃO-ROLÁVEL (ABAS) -->
            <div class="p-4 flex flex-wrap gap-2 border-b flex-shrink-0">
                 <button type="button" data-tab="detail-tab1" class="tab-button active font-semibold py-2 px-4 rounded-lg text-sm">1. Histórico</button>
                 <button type="button" data-tab="detail-tab2" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">2. Cognitivo</button>
                 <button type="button" data-tab="detail-tab3" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">3. Físico</button>
                 <button type="button" data-tab="detail-tab4" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">4. Funcional</button>
                 <button type="button" data-tab="detail-tab5" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">5. Ambiente</button>
                 <button type="button" data-tab="detail-tab6" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">6. Objetivos</button>
                 <button type="button" data-tab="detail-tab-discharge" class="tab-button font-semibold py-2 px-4 rounded-lg text-sm">Alta</button>
            </div>
            <!-- CORPO ROLÁVEL -->
            <div class="p-6 overflow-y-auto flex-1">
                 <div id="detail-tab1" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Diagnóstico Médico Principal</h4><p id="detail-diagMedico" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Comorbidades</h4><p id="detail-comorbidades" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Medicações em uso</h4><p id="detail-medicacoes" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Internações/Cirurgias Prévias</h4><p id="detail-cirurgias" class="detail-value"></p></div>
                    <div class="md:col-span-2"><h4 class="detail-label">Principais Queixas</h4><p id="detail-queixas" class="detail-value whitespace-pre-wrap"></p></div>
                    <div><h4 class="detail-label">Dor (EVA 0-10)</h4><p id="detail-dorEva" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Local da Dor</h4><p id="detail-dorLocal" class="detail-value"></p></div>
                    <div class="md:col-span-2"><h4 class="detail-label">Hábitos</h4><p id="detail-habitos" class="detail-value whitespace-pre-wrap"></p></div>
                </div>
                <div id="detail-tab2" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Estado de Consciência</h4><p id="detail-consciencia" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Orientação</h4><p id="detail-orientacao" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Comunicação</h4><p id="detail-comunicacao" class="detail-value"></p></div>
                </div>
                <div id="detail-tab3" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Postura</h4><p id="detail-postura" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Marcha</h4><p id="detail-marcha" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Equilíbrio</h4><p id="detail-equilibrio" class="detail-value"></p></div>
                    <div><h4 class="detail-label">ADM</h4><p id="detail-adm" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Força Muscular (0-5)</h4><p id="detail-forca" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Tônus</h4><p id="detail-tonus" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Coordenação Motora</h4><p id="detail-coordenacao" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Sensibilidade</h4><p id="detail-sensibilidade" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Edema</h4><p id="detail-edema" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Local/Descrição do Edema</h4><p id="detail-edemaLocal" class="detail-value"></p></div>
                    <div class="md:col-span-2"><h4 class="detail-label">Testes Realizados</h4><p id="detail-testesRealizados" class="detail-value whitespace-pre-wrap"></p></div>
                </div>
                <div id="detail-tab4" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                       <div><h4 class="detail-label">Banho</h4><p id="detail-banho" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Vestir-se</h4><p id="detail-vestir" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Alimentação</h4><p id="detail-alimentacao" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Continência</h4><p id="detail-continencia" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Uso de Fraldas</h4><p id="detail-fraldas" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Transferências</h4><p id="detail-transferencias" class="detail-value"></p></div>
                       <div><h4 class="detail-label">Deambulacao</h4><p id="detail-deambulacao" class="detail-value"></p></div>
                </div>
                <div id="detail-tab5" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Tipo de Residência</h4><p id="detail-residencia" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Iluminação</h4><p id="detail-iluminacao" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Espaço para Exercícios</h4><p id="detail-espaco" class="detail-value"></p></div>
                    <div><h4 class="detail-label">Barreiras Arquitetônicas</h4><p id="detail-barreiras" class="detail-value"></p></div>
                </div>
                <div id="detail-tab6" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><h4 class="detail-label">Objetivos da Fisioterapia</h4><p id="detail-objetivos" class="detail-value whitespace-pre-wrap"></p></div>
                </div>
                 <div id="detail-tab-evolution" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                     <div><h4 class="detail-label">Nº da Sessão</h4><p id="detail-evolution-session-number" class="detail-value"></p></div>
                     <div><h4 class="detail-label">Data da Evolução</h4><p id="detail-evolution-date" class="detail-value"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Procedimentos Realizados</h4><p id="detail-evolution-procedures" class="detail-value whitespace-pre-wrap"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Resposta do Paciente</h4><p id="detail-evolution-response" class="detail-value whitespace-pre-wrap"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Observações/Intercorrências</h4><p id="detail-evolution-notes" class="detail-value whitespace-pre-wrap"></p></div>
                 </div>
                 <div id="detail-tab-discharge" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                     <div><h4 class="detail-label">Data da Alta</h4><p id="detail-discharge-date" class="detail-value"></p></div>
                     <div><h4 class="detail-label">Dor (EVA) na Alta</h4><p id="detail-discharge-dor-eva" class="detail-value"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Queixas Finais</h4><p id="detail-discharge-queixas-finais" class="detail-value whitespace-pre-wrap"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Marcha e Equilíbrio</h4><p id="detail-discharge-marcha-equilibrio" class="detail-value"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">ADM e Força</h4><p id="detail-discharge-adm-forca" class="detail-value"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Capacidade Funcional (AVDs)</h4><p id="detail-discharge-funcionalidade" class="detail-value whitespace-pre-wrap"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Resultados Obtidos</h4><p id="detail-discharge-resultados" class="detail-value whitespace-pre-wrap"></p></div>
                     <div class="md:col-span-2"><h4 class="detail-label">Motivo da Alta / Próximos Passos</h4><p id="detail-discharge-motivo" class="detail-value whitespace-pre-wrap"></p></div>
                 </div>
            </div>
             <!-- RODAPÉ FIXO -->
             <div class="p-6 flex justify-end space-x-4 border-t flex-shrink-0">
                <button type="button" id="cancel-assessment-detail-modal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Fechar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, reauthenticateWithCredential, EmailAuthProvider, updatePassword, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDoc, setDoc, deleteDoc, onSnapshot, query, where, updateDoc, deleteField, orderBy, getDocs, limit, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5DK7R3WGtKIUy_fMt8iNKBtz9wgdBxVs",
            authDomain: "fisioterapia-cee9d.firebaseapp.com",
            projectId: "fisioterapia-cee9d",
            storageBucket: "fisioterapia-cee9d.appspot.com",
            messagingSenderId: "551406348997",
            appId: "1:551406348997:web:7b21e0d90ebf4969955eac",
            measurementId: "G-RDGZ2MKLWK"
        };
        
        let app;
        try {
            app = initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            alert("Erro ao inicializar a conexão com o banco de dados. Tente recarregar a página.");
        }
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL VARIABLES ---
        let currentUserClinicId = null;
        let currentUserRole = null;
        let currentUserId = null;
        let currentUserName = null;
        let selectedPatientId = null;
        let patientsUnsubscribe = null;
        let assessmentsUnsubscribe = null;
        let allPatients = [];
        let clinicUsers = [];
        let clinicRooms = [];
        let clinicPreferences = { defaultAgendaView: 'monthly', defaultServiceType: 'local' };
        let currentAgendaView = 'monthly';
        let currentDate = new Date();
        let currentAppointments = [];
        let appointmentsUnsubscribe = null;
        let paymentsUnsubscribe = null;
        let membersUnsubscribe = null;
        let roomsUnsubscribe = null;
        let dashboardAppointmentsUnsubscribe = null;
        let initialDataLoaded = false;
        let recurrenceAction = {
            type: null, // 'save' or 'delete'
            appointmentData: null,
            originalEventDate: null,
        };

        // --- ELEMENT SELECTORS ---
        const authView = document.getElementById('auth-view');
        const loginContainer = document.getElementById('login-container');
        const registerContainer = document.getElementById('register-container');
        const dashboardView = document.getElementById('dashboard-view');
        const mainContentContainer = document.getElementById('main-content');
        const patientModal = document.getElementById('patient-modal');
        const patientRecordModal = document.getElementById('patient-record-modal');
        const patientQuickViewModal = document.getElementById('patient-quick-view-modal');
        const assessmentModal = document.getElementById('assessment-modal');
        const assessmentDetailModal = document.getElementById('assessment-detail-modal');
        const evolutionModal = document.getElementById('evolution-modal');
        const dischargeModal = document.getElementById('discharge-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const recurrenceOptionsModal = document.getElementById('recurrence-options-modal');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const appointmentModal = document.getElementById('appointment-modal');
        const financialRecordModal = document.getElementById('financial-record-modal');
        const changeRoleModal = document.getElementById('change-role-modal');
        const forcePasswordChangeModal = document.getElementById('force-password-change-modal');
        const clinicEditModal = document.getElementById('clinic-edit-modal');
        const roomModal = document.getElementById('room-modal');
        const patientDatalist = document.getElementById('patient-list');
        const loadingOverlay = document.getElementById('loading-overlay');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const jsMessageModal = document.getElementById('js-message-modal');

        // --- UTILITY FUNCTIONS ---
        function showLoading() { if(loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { if(loadingOverlay) loadingOverlay.classList.add('hidden'); }

        function openModal(modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeModal(modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }

        function showJsMessage(title, text, isError = false) {
             const titleEl = document.getElementById('js-message-title');
             const textEl = document.getElementById('js-message-text');
             titleEl.textContent = title;
             textEl.textContent = text;
             titleEl.classList.toggle('text-red-600', isError);
             titleEl.classList.toggle('text-blue-600', !isError);
             openModal(jsMessageModal);
        }

        document.getElementById('js-message-close').addEventListener('click', () => {
             closeModal(jsMessageModal);
        });

        function showConfirmation(title, text, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            openModal(confirmModal);

            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);


            const confirmHandler = () => { onConfirm(); closeModal(confirmModal); };
            const cancelHandler = () => { closeModal(confirmModal); };

            newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            newCancelBtn.addEventListener('click', cancelHandler, { once: true });
        }


        function getDateString(date) {
            if (!date) return '';
            const d = new Date(date);
            const adjustedDate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
            return adjustedDate.toISOString().split('T')[0];
        }


        // --- RENDER FUNCTIONS ---
        function renderPatientList(patients) {
             const loadingMsg = mainContentContainer.querySelector("#loading-patients-msg");
             const container = mainContentContainer.querySelector('#patients-container');
             const noPatientsMsg = mainContentContainer.querySelector('#no-patients-message');

             if (!container || !noPatientsMsg || !loadingMsg) {
                  return;
             }


            loadingMsg.classList.add('hidden');
            container.innerHTML = '';

            if (patients.length === 0) {
                noPatientsMsg.classList.remove('hidden');
                container.classList.add('hidden');
            } else {
                noPatientsMsg.classList.add('hidden');
                container.classList.remove('hidden');

                patients.sort((a, b) => a.name.localeCompare(b.name));

                patients.forEach(patient => {
                    const age = patient.birthDate ? new Date().getFullYear() - new Date(patient.birthDate).getFullYear() : 'N/A';
                    const card = document.createElement('div');
                    card.className = 'p-4 hover:bg-gray-50 flex flex-col sm:flex-row justify-between sm:items-center';
                    card.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-bold text-blue-700 truncate">${patient.name}</h3>
                            <div class="flex flex-col sm:flex-row sm:gap-4 text-sm text-gray-600">
                                <p>${age} anos</p>
                                <p class="hidden sm:block">|</p>
                                <p>${formatPhone(patient.phone)}</p>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0 flex-shrink-0 flex space-x-2">
                            <button data-id="${patient.id}" class="view-record-btn bg-green-100 text-green-800 font-semibold p-2 rounded-lg hover:bg-green-200 transition" title="Ver Prontuário Completo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-id="${patient.id}" class="edit-patient-btn bg-yellow-100 text-yellow-800 font-semibold p-2 rounded-lg hover:bg-yellow-200 transition" title="Editar Cadastro">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-id="${patient.id}" class="delete-patient-btn bg-red-100 text-red-800 font-semibold p-2 rounded-lg hover:bg-red-200 transition" title="Excluir Paciente">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h--3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>`;
                    container.appendChild(card);
                });
            }
        }

        function constructPatientAddress(patient) {
            if (!patient) return '';
            const addressParts = [
                patient.street || '',
                patient.number ? `nº ${patient.number}` : '',
                patient.neighborhood || '',
                patient.city || '',
                patient.state || ''
            ];
            return addressParts.filter(Boolean).join(', ');
        }
        
        function renderAssessmentsForModal(assessments) {
            const container = document.getElementById('record-modal-assessments-container');
            const noAssessmentsMsg = document.getElementById('record-modal-no-assessments-message');
            if (!container || !noAssessmentsMsg) return;
            container.innerHTML = '';

            const filteredAssessments = assessments.filter(a => a.type !== 'system_init');

            if (filteredAssessments.length === 0) { noAssessmentsMsg.classList.remove('hidden'); return; }
            noAssessmentsMsg.classList.add('hidden');

            filteredAssessments.forEach(assessment => {
                 const assessmentDate = assessment.createdAt && assessment.createdAt.toDate
                    ? assessment.createdAt.toDate().toLocaleString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                    : 'Data pendente...';

                 const professional = clinicUsers.find(u => u.id === assessment.professionalId) || { email: 'Profissional Desconhecido' };
                 const professionalName = assessment.professionalName || professional.email;
                 const registeredBy = assessment.registeredByUserId ? (assessment.registeredByName || clinicUsers.find(u => u.id === assessment.registeredByUserId)?.email || 'Usuário Desconhecido') : 'N/A';

                 let typeLabel = '';
                 let tagClass = 'bg-gray-100 text-gray-800';
                 if (assessment.type === 'initial') { typeLabel = 'Avaliação Inicial'; tagClass = 'bg-yellow-100 text-yellow-800'; }
                 else if (assessment.type === 'evolution') { typeLabel = `Evolução (Sessão ${assessment.sessionNumber || 'N/A'})`; tagClass = 'bg-green-100 text-green-800'; }
                 else if (assessment.type === 'discharge') { typeLabel = 'Alta Fisioterapêutica'; tagClass = 'bg-red-100 text-red-800'; }
                 else { typeLabel = 'Registro Clínico'; }


                 const card = document.createElement('div');
                card.className = `bg-gray-50 p-4 rounded-lg border border-gray-200`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg inline-block px-2 py-1 rounded-md text-sm ${tagClass}">${typeLabel}</p>
                            <p class="text-md font-semibold mt-1">Profissional: ${professionalName}</p>
                            ${assessment.registeredByUserId && assessment.registeredByUserId !== assessment.professionalId ?
                                `<p class="text-sm text-gray-500">Cadastrado por: ${registeredBy}</p>` : ''}
                            <p class="text-sm text-gray-600">${assessmentDate}</p>
                        </div>
                        <button data-id="${assessment.id}" data-type="${assessment.type}" class="view-assessment-btn text-sm text-blue-600 hover:underline">Ver Detalhes</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }


        // --- AGENDA FUNCTIONS ---
        function renderAgendaView(appointments, searchTerm = '') {
            const agendaContentEl = mainContentContainer.querySelector('#agenda-content');
             if (!agendaContentEl) return;

            const filteredAppointments = searchTerm
                ? appointments.filter(app => app.patientName && app.patientName.toLowerCase().includes(searchTerm.toLowerCase()))
                : appointments;

            if (currentAgendaView === 'monthly') {
                renderMonthlyView(currentDate.getFullYear(), currentDate.getMonth(), filteredAppointments);
            } else if (currentAgendaView === 'weekly') {
                renderWeeklyView(currentDate, filteredAppointments);
            } else {
                renderDailyView(currentDate, filteredAppointments);
            }
        }

        function renderMonthlyView(year, month, appointments = []) {
            const agendaContent = mainContentContainer.querySelector('#agenda-content');
            if (!agendaContent) return;

            let contentHTML = `
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div class="grid grid-cols-7 gap-px text-center font-semibold text-sm text-gray-600 mb-2">
                        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px"></div>
                </div>`;
            agendaContent.innerHTML = contentHTML;

            const calendarGrid = agendaContent.querySelector('#calendar-grid');
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
            }

            const today = new Date();
            const todayStr = getDateString(today);

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDayDate = new Date(year, month, day);
                const dateStr = getDateString(currentDayDate);
                const dayAppointments = appointments.filter(a => a.date === dateStr).sort((a,b) => a.time.localeCompare(b.time));

                let appointmentsHTML = dayAppointments.map(app => {
                    const location = app.serviceType === 'domiciliar' ? 'Domiciliar' : (app.roomName || 'N/A');
                    const title = `${app.time} - ${app.patientName}\nProf: ${app.professionalName || 'N/A'}\nLocal: ${location}`;
                    return `<div class="appointment-item appointment-badge text-xs bg-blue-100 text-blue-800 p-1 rounded-md mb-1" data-appointment-id="${app.id}" title="${title}">
                        ${app.time} - ${app.patientName}
                    </div>`
                }).join('');

                const isToday = dateStr === todayStr;
                const dayClass = isToday ? 'bg-blue-100' : 'bg-gray-50 hover:bg-gray-100';

                calendarGrid.insertAdjacentHTML('beforeend', `
                    <div class="calendar-day border p-2 ${dayClass} flex flex-col cursor-pointer" data-date="${dateStr}">
                        <div class="font-bold text-gray-800">${day}</div>
                        <div class="mt-1 flex-1 overflow-y-auto text-left">${appointmentsHTML}</div>
                    </div>
                `);
            }
        }


        function renderWeeklyView(date, appointments = []) {
            const agendaContent = mainContentContainer.querySelector('#agenda-content');
             if (!agendaContent) return;
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            let tableHTML = `
                <div class="bg-white rounded-lg shadow-lg p-4 overflow-x-auto">
                    <div class="grid grid-cols-7 text-center font-semibold text-sm text-gray-600 min-w-[700px]">`;

            const startOfWeek = new Date(date);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                tableHTML += `<div>${weekDays[i]} <span class="font-normal text-gray-500">${day.getDate()}</span></div>`;
            }
            tableHTML += `</div><div class="grid grid-cols-7 border-t border-l mt-2 min-w-[700px]">`;

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateStr = getDateString(day);
                const dayAppointments = appointments.filter(a => a.date === dateStr).sort((a,b) => a.time.localeCompare(b.time));

                let appointmentsHTML = dayAppointments.map(app => {
                    const location = app.serviceType === 'domiciliar' ? 'Domiciliar' : (app.roomName || 'N/A');
                    const title = `${app.time} - ${app.patientName}\nProf: ${app.professionalName || 'N/A'}\nLocal: ${location}`;
                    return `<div class="appointment-item appointment-badge text-xs bg-blue-100 text-blue-800 p-1 rounded-md mb-1" data-appointment-id="${app.id}" title="${title}">
                        ${app.time} - ${app.patientName}
                    </div>`
                }).join('');

                tableHTML += `<div class="border-r border-b p-2 min-h-[200px] cursor-pointer" data-date="${dateStr}">${appointmentsHTML}</div>`;
            }

            tableHTML += `</div></div>`;
            agendaContent.innerHTML = tableHTML;
        }


        function renderDailyView(date, appointments = []) {
             const agendaContent = mainContentContainer.querySelector('#agenda-content');
              if (!agendaContent) return;
             let appointmentsHTML = '<p class="text-gray-500">Nenhum agendamento para este dia.</p>';
             const dateStr = getDateString(date);
             const dayAppointments = appointments.filter(a => a.date === dateStr).sort((a,b) => a.time.localeCompare(b.time));

             if (dayAppointments.length > 0) {
                 appointmentsHTML = dayAppointments.map(app => {
                    const location = app.serviceType === 'domiciliar'
                        ? `Domiciliar (${app.address || 'Endereço não informado'})`
                        : `Sala: ${app.roomName || 'N/A'}`;
                    return `<div class="appointment-item bg-blue-50 p-4 rounded-lg border border-blue-200 cursor-pointer" data-appointment-id="${app.id}">
                        <p class="font-bold">${app.time} - ${app.patientName}</p>
                        <p class="text-sm text-gray-600">Profissional: ${app.professionalName || 'N/A'}</p>
                        <p class="text-sm text-gray-600">${location}</p>
                        ${app.notes ? `<p class="text-sm text-gray-500 mt-2">Obs: ${app.notes}</p>` : ''}
                    </div>`
                 }).join('');
             }
             agendaContent.innerHTML = `<div class="bg-white rounded-lg shadow-lg p-4 space-y-4" data-date="${dateStr}">${appointmentsHTML}</div>`;
        }


        // --- DATA FETCHING FUNCTIONS ---
        function populateAssessmentDetailModal(data) {
            const orDefault = (value) => value || 'Não informado';

            document.getElementById('detail-tab1')?.classList.add('hidden');
            document.getElementById('detail-tab2')?.classList.add('hidden');
            document.getElementById('detail-tab3')?.classList.add('hidden');
            document.getElementById('detail-tab4')?.classList.add('hidden');
            document.getElementById('detail-tab5')?.classList.add('hidden');
            document.getElementById('detail-tab6')?.classList.add('hidden');
            document.getElementById('detail-tab-evolution')?.classList.add('hidden');
            document.getElementById('detail-tab-discharge')?.classList.add('hidden');


            if (data.type === 'evolution') {
                document.getElementById('detail-tab-evolution')?.classList.remove('hidden');
                document.getElementById('detail-evolution-session-number').textContent = orDefault(data.sessionNumber);
                document.getElementById('detail-evolution-date').textContent = data.date ? new Date(data.date + 'T12:00:00').toLocaleDateString('pt-BR') : 'N/A';
                document.getElementById('detail-evolution-procedures').textContent = orDefault(data.procedures);
                document.getElementById('detail-evolution-response').textContent = orDefault(data.response);
                document.getElementById('detail-evolution-notes').textContent = orDefault(data.notes);
                assessmentDetailModal.querySelector('[data-tab="detail-tab-evolution"]')?.classList.add('active');


            } else if (data.type === 'discharge') {
                 document.getElementById('detail-tab-discharge')?.classList.remove('hidden');
                 document.getElementById('detail-discharge-date').textContent = data.date ? new Date(data.date + 'T12:00:00').toLocaleDateString('pt-BR') : 'N/A';
                 document.getElementById('detail-discharge-dor-eva').textContent = orDefault(data.dorEva);
                 document.getElementById('detail-discharge-queixas-finais').textContent = orDefault(data.queixasFinais);
                 document.getElementById('detail-discharge-marcha-equilibrio').textContent = orDefault(data.marchaEquilibrio);
                 document.getElementById('detail-discharge-adm-forca').textContent = orDefault(data.admForca);
                 document.getElementById('detail-discharge-funcionalidade').textContent = orDefault(data.funcionalidadeFinal);
                 document.getElementById('detail-discharge-resultados').textContent = orDefault(data.resultados);
                 document.getElementById('detail-discharge-motivo').textContent = orDefault(data.motivo);
                 assessmentDetailModal.querySelector('[data-tab="detail-tab-discharge"]')?.classList.add('active');


            } else { // 'initial'
                document.getElementById('detail-tab1')?.classList.remove('hidden');
                
                document.getElementById('detail-diagMedico').textContent = orDefault(data.diagMedico);
                document.getElementById('detail-comorbidades').textContent = orDefault(data.comorbidades);
                document.getElementById('detail-medicacoes').textContent = orDefault(data.medicacoes);
                document.getElementById('detail-cirurgias').textContent = orDefault(data.cirurgias);
                document.getElementById('detail-queixas').textContent = orDefault(data.queixas);
                document.getElementById('detail-dorEva').textContent = orDefault(data.dorEva);
                document.getElementById('detail-dorLocal').textContent = orDefault(data.dorLocal);
                document.getElementById('detail-habitos').textContent = orDefault(data.habitos);
                document.getElementById('detail-consciencia').textContent = orDefault(data.consciencia);
                document.getElementById('detail-orientacao').textContent = orDefault(data.orientacao);
                document.getElementById('detail-comunicacao').textContent = orDefault(data.comunicacao);
                document.getElementById('detail-postura').textContent = orDefault(data.postura);
                document.getElementById('detail-marcha').textContent = orDefault(data.marcha);
                document.getElementById('detail-equilibrio').textContent = orDefault(data.equilibrio);
                document.getElementById('detail-adm').textContent = orDefault(data.adm);
                document.getElementById('detail-forca').textContent = orDefault(data.forca);
                document.getElementById('detail-tonus').textContent = orDefault(data.tonus);
                document.getElementById('detail-coordenacao').textContent = orDefault(data.coordenacao);
                document.getElementById('detail-sensibilidade').textContent = orDefault(data.sensibilidade);
                document.getElementById('detail-edema').textContent = orDefault(data.edema);
                document.getElementById('detail-edemaLocal').textContent = orDefault(data.edemaLocal);
                document.getElementById('detail-testesRealizados').textContent = orDefault(data.testesRealizados);
                document.getElementById('detail-banho').textContent = orDefault(data.banho);
                document.getElementById('detail-vestir').textContent = orDefault(data.vestir);
                document.getElementById('detail-alimentacao').textContent = orDefault(data.alimentacao);
                document.getElementById('detail-continencia').textContent = orDefault(data.continencia);
                document.getElementById('detail-fraldas').textContent = orDefault(data.fraldas);
                document.getElementById('detail-transferencias').textContent = orDefault(data.transferencias);
                document.getElementById('detail-deambulacao').textContent = orDefault(data.deambulacao);
                document.getElementById('detail-residencia').textContent = orDefault(data.residencia);
                document.getElementById('detail-iluminacao').textContent = orDefault(data.iluminacao);
                document.getElementById('detail-espaco').textContent = orDefault(data.espaco);
                document.getElementById('detail-barreiras').textContent = data.barreiras && data.barreiras.length > 0 ? data.barreiras.join(', ') : 'Nenhuma';
                document.getElementById('detail-objetivos').textContent = orDefault(data.objetivos);
                assessmentDetailModal.querySelector('[data-tab="detail-tab1"]')?.classList.add('active');
            }
        }

        function fetchAndRenderPatients() {
             if (!currentUserClinicId) return Promise.reject("No clinic ID");
            if (patientsUnsubscribe) patientsUnsubscribe();
            
            const patientsCollection = collection(db, "clinics", currentUserClinicId, "patients");
            const q = query(patientsCollection);

            return new Promise((resolve, reject) => {
                patientsUnsubscribe = onSnapshot(q, (snapshot) => {
                    allPatients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populatePatientDatalist();
                    if(document.getElementById('patient-list-view')) {
                        renderPatientList(allPatients);
                    }
                    resolve();
                }, (error) => {
                    console.error("Erro ao buscar pacientes: ", error);
                    if(document.getElementById('patient-list-view')) {
                        renderPatientList([]);
                    }
                    reject(error);
                });
            });
        }


        function populatePatientDatalist() {
            if (!patientDatalist) return;
            patientDatalist.innerHTML = '';
            allPatients.sort((a, b) => a.name.localeCompare(b.name)).forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.name;
                option.dataset.id = patient.id;
                patientDatalist.appendChild(option);
            });
        }

        function populateProfessionalSelects(users, targetSelectId) {
            const targetSelect = document.getElementById(targetSelectId);

            if (!targetSelect) return;

            const professionalUsers = users.filter(u => u.role === 'fisioterapeuta' || u.role === 'admin');

            let optionsHTML = professionalUsers.map(u =>
                `<option value="${u.id}" data-name="${u.name || u.email}">${u.name || u.email} (${u.role})</option>`
            ).join('');

            optionsHTML = '<option value="" disabled selected>Selecione um Profissional</option>' + optionsHTML;
            targetSelect.innerHTML = optionsHTML;

            const currentUserData = professionalUsers.find(u => u.id === currentUserId);
            if (currentUserData && (currentUserData.role === 'fisioterapeuta' || currentUserData.role === 'admin')) {
                 targetSelect.value = currentUserId;
            } else if (currentUserRole === 'secretaria') {
                targetSelect.value = '';
            }
        }


        function fetchAndRenderMembers() {
            if (!currentUserClinicId) return Promise.reject("No clinic ID");
            const q = query(collection(db, "users"), where("clinicId", "==", currentUserClinicId));
            
            if (membersUnsubscribe) membersUnsubscribe();
            return new Promise((resolve, reject) => {
                membersUnsubscribe = onSnapshot(q, (snapshot) => {
                    clinicUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const currentMembersListDiv = document.getElementById('members-list');
                    if(currentMembersListDiv) renderMembersList(clinicUsers);

                    populateProfessionalSelects(clinicUsers, 'appointment-professional');
                    populateProfessionalSelects(clinicUsers, 'assessment-professional');
                    populateProfessionalSelects(clinicUsers, 'evolution-professional');
                    populateProfessionalSelects(clinicUsers, 'discharge-professional');


                    resolve();
                }, (error) => {
                    console.error("Erro ao buscar membros:", error);
                    const currentMembersListDiv = document.getElementById('members-list');
                    if(currentMembersListDiv) currentMembersListDiv.innerHTML = '<p class="text-red-500">Erro ao carregar membros. Verifique as permissões.</p>';
                    reject(error);
                });
            });
        }


        function fetchAndRenderClinicData() {
             if (!currentUserClinicId) return Promise.reject("No clinic ID");
             const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
             
             return new Promise((resolve, reject) => {
                 const unsubscribe = onSnapshot(clinicDocRef, (docSnap) => {
                     if (docSnap.exists()) {
                         const data = docSnap.data();
                         clinicPreferences = data.preferences || { defaultAgendaView: 'monthly', defaultServiceType: 'local' };
                         currentAgendaView = clinicPreferences.defaultAgendaView;

                         if(document.getElementById('clinic-data-display')) {
                             renderClinicDataForDisplay(data);
                         }
                         const defaultAgendaViewSelect = document.getElementById('default-agenda-view');
                         if(defaultAgendaViewSelect) {
                             defaultAgendaViewSelect.value = clinicPreferences.defaultAgendaView;
                         }
                         const defaultServiceTypeSelect = document.getElementById('default-service-type');
                         if(defaultServiceTypeSelect) {
                             defaultServiceTypeSelect.value = clinicPreferences.defaultServiceType || 'local';
                         }
                         resolve();
                     } else {
                         console.error("Documento da clínica não encontrado!");
                         reject("Clinic document not found");
                     }
                 }, (error) => {
                      console.error("Erro ao buscar dados da clínica:", error);
                      reject(error);
                 });
             });
         }
        function renderClinicDataForDisplay(data) {
            const container = document.getElementById('clinic-data-display');
            if (!container) return;

            const orDefault = (value) => value || 'Não informado';
            const fullAddress = constructPatientAddress(data);
            let html;

            if (data.accountType === 'pf') {
                html = `
                    <p><strong class="detail-label">Nome:</strong> <span class="detail-value">${orDefault(data.name)}</span></p>
                    <p><strong class="detail-label">E-mail:</strong> <span class="detail-value">${orDefault(data.ownerEmail)}</span></p>
                    <p><strong class="detail-label">CPF:</strong> <span class="detail-value">${formatCPF(data.cpf)}</span></p>
                    <p><strong class="detail-label">RG:</strong> <span class="detail-value">${orDefault(data.rg)}</span></p>
                    <p><strong class="detail-label">Data de Nascimento:</strong> <span class="detail-value">${orDefault(data.birthDate)}</span></p>
                    <p><strong class="detail-label">CREFITO:</strong> <span class="detail-value">${orDefault(data.crefito)}</span></p>
                    <p><strong class="detail-label">Telefone:</strong> <span class="detail-value">${formatPhone(data.phone)}</span></p>
                    <p class="md:col-span-2"><strong class="detail-label">Endereço:</strong> <span class="detail-value">${orDefault(fullAddress)}</span></p>
                `;
            } else { // pj
                html = `
                    <p><strong class="detail-label">Razão Social:</strong> <span class="detail-value">${orDefault(data.name)}</span></p>
                    <p><strong class="detail-label">E-mail de Contato:</strong> <span class="detail-value">${orDefault(data.ownerEmail)}</span></p>
                    <p><strong class="detail-label">CNPJ:</strong> <span class="detail-value">${formatCNPJ(data.cnpj)}</span></p>
                    <p><strong class="detail-label">CREFITO da Clínica:</strong> <span class="detail-value">${orDefault(data.crefito)}</span></p>
                    <p><strong class="detail-label">Telefone:</strong> <span class="detail-value">${formatPhone(data.phone)}</span></p>
                    <p class="md:col-span-2"><strong class="detail-label">Endereço:</strong> <span class="detail-value">${orDefault(fullAddress)}</span></p>
                    <hr class="md:col-span-2 my-2"/>
                    <div class="md:col-span-2"><p class="font-semibold text-gray-600">Responsável Técnico</p></div>
                    <p><strong class="detail-label">Nome:</strong> <span class="detail-value">${orDefault(data.responsavelNome)}</span></p>
                    <p><strong class="detail-label">CPF:</strong> <span class="detail-value">${formatCPF(data.responsavelCpf)}</span></p>
                    <p><strong class="detail-label">CREFITO:</strong> <span class="detail-value">${orDefault(data.responsavelCrefito)}</span></p>
                `;
            }
            container.innerHTML = html;
        }

        function populateClinicEditModal(data) {
            const container = document.getElementById('clinic-edit-form-fields');
            if (!container) return;
            let html = '';
            const val = (field) => field || '';

            if (data.accountType === 'pf') {
                html = `
                    <input type="hidden" id="edit-accountType" value="pf">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium">Nome Completo</label>
                            <input id="edit-pf-name" type="text" value="${val(data.name)}" class="w-full p-2 border rounded-lg" data-mask="name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Data de Nascimento</label>
                            <input id="edit-pf-birthDate" type="date" value="${val(data.birthDate)}" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">RG</label>
                            <input id="edit-pf-rg" type="text" value="${val(data.rg)}" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">CPF</label>
                            <input id="edit-pf-cpf" type="text" value="${formatCPF(val(data.cpf))}" class="w-full p-2 border rounded-lg" data-mask="cpf">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">CREFITO</label>
                            <input id="edit-pf-crefito" type="text" value="${val(data.crefito)}" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                            <div class="md:col-span-2"><input id="edit-pf-cep" type="text" placeholder="CEP" value="${val(data.cep)}" class="w-full p-2 border rounded-lg" data-form-prefix="edit-pf"></div>
                            <div class="md:col-span-4"><input id="edit-pf-street" type="text" placeholder="Rua / Endereço" value="${val(data.street)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-2"><input id="edit-pf-number" type="text" placeholder="Número" value="${val(data.number)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-4"><input id="edit-pf-neighborhood" type="text" placeholder="Bairro" value="${val(data.neighborhood)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="edit-pf-city" type="text" placeholder="Cidade" value="${val(data.city)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="edit-pf-state" type="text" placeholder="Estado (UF)" value="${val(data.state)}" class="w-full p-2 border rounded-lg"></div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium">Telefone</label>
                            <input id="edit-pf-phone" type="tel" value="${formatPhone(val(data.phone))}" class="w-full p-2 border rounded-lg" data-mask="phone">
                        </div>
                    </div>
                `;
            } else { // pj
                html = `
                    <input type="hidden" id="edit-accountType" value="pj">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium">Razão Social</label>
                            <input id="edit-pj-razaoSocial" type="text" value="${val(data.name)}" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">CNPJ</label>
                            <input id="edit-pj-cnpj" type="text" value="${formatCNPJ(val(data.cnpj))}" class="w-full p-2 border rounded-lg" data-mask="cnpj">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">CREFITO da Clínica</label>
                            <input id="edit-pj-crefito" type="text" value="${val(data.crefito)}" class="w-full p-2 border rounded-lg">
                        </div>
                         <div class="md:col-span-2">
                             <label class="block text-sm font-medium">Telefone Comercial</label>
                            <input id="edit-pj-phone" type="tel" value="${formatPhone(val(data.phone))}" class="w-full p-2 border rounded-lg" data-mask="phone">
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-6 gap-4 border p-3 rounded-lg bg-gray-50">
                            <div class="md:col-span-2"><input id="edit-pj-cep" type="text" placeholder="CEP" value="${val(data.cep)}" class="w-full p-2 border rounded-lg" data-form-prefix="edit-pj"></div>
                            <div class="md:col-span-4"><input id="edit-pj-street" type="text" placeholder="Rua / Endereço" value="${val(data.street)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-2"><input id="edit-pj-number" type="text" placeholder="Número" value="${val(data.number)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-4"><input id="edit-pj-neighborhood" type="text" placeholder="Bairro" value="${val(data.neighborhood)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="edit-pj-city" type="text" placeholder="Cidade" value="${val(data.city)}" class="w-full p-2 border rounded-lg"></div>
                            <div class="md:col-span-3"><input id="edit-pj-state" type="text" placeholder="Estado (UF)" value="${val(data.state)}" class="w-full p-2 border rounded-lg"></div>
                        </div>
                        <hr class="md:col-span-2 my-2"/>
                        <div class="md:col-span-2"><p class="text-sm font-semibold text-gray-600">Dados do Responsável Técnico</p></div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium">Nome do Responsável</label>
                            <input id="edit-pj-responsavel" type="text" value="${val(data.responsavelNome)}" class="w-full p-2 border rounded-lg" data-mask="name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">CPF do Responsável</label>
                            <input id="edit-pj-responsavel-cpf" type="text" value="${formatCPF(val(data.responsavelCpf))}" class="w-full p-2 border rounded-lg" data-mask="cpf">
                        </div>
                        <div>
                             <label class="block text-sm font-medium">CREFITO do Responsável</label>
                            <input id="edit-pj-responsavel-crefito" type="text" value="${val(data.responsavelCrefito)}" class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderAllPayments(payments) {
            const tableBody = mainContentContainer.querySelector('#payments-table-body');
            if (!tableBody) return;
            if (payments.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Nenhum lançamento financeiro encontrado.</td></tr>`;
                 return;
            }

            tableBody.innerHTML = '';
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';

                const statusClass = payment.status === 'pago' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';

                row.innerHTML = `
                    <td class="px-6 py-4">${new Date(payment.date + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${payment.patientName}</td>
                    <td class="px-6 py-4">R$ ${Number(payment.value).toFixed(2).replace('.',',')}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${payment.status}</span>
                    </td>
                    <td class="px-6 py-4">
                         <button data-id="${payment.id}" class="edit-payment-btn text-blue-600 hover:underline">Editar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderRoomsList(rooms) {
            const roomsListDiv = document.getElementById('rooms-list');
            if (!roomsListDiv) return;
            if (rooms.length === 0) {
                roomsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma sala de atendimento cadastrada.</p>';
                return;
            }

            rooms.sort((a, b) => a.name.localeCompare(b.name));

            roomsListDiv.innerHTML = '';
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                roomDiv.innerHTML = `
                    <div>
                        <p class="font-semibold">${room.name}</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${room.id}" data-name="${room.name}" class="edit-room-btn text-sm bg-yellow-100 text-yellow-700 font-semibold py-1 px-3 rounded-lg hover:bg-yellow-200">Editar</button>
                        <button data-id="${room.id}" data-name="${room.name}" class="delete-room-btn text-sm bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Excluir</button>
                    </div>
                `;
                roomsListDiv.appendChild(roomDiv);
            });
        }

        function toggleAppointmentFields(type) {
            const salaContainer = document.getElementById('sala-container');
            const domiciliarContainer = document.getElementById('domiciliar-container');
            const salaSelect = document.getElementById('appointment-room');

            const cepInput = document.getElementById('appointment-cep');
            const streetInput = document.getElementById('appointment-street');
            const numberInput = document.getElementById('appointment-number');
            const neighborhoodInput = document.getElementById('appointment-neighborhood');
            const cityInput = document.getElementById('appointment-city');
            const stateInput = document.getElementById('appointment-state');

            if (!salaContainer || !domiciliarContainer || !salaSelect || !cepInput || !streetInput || !numberInput || !neighborhoodInput || !cityInput || !stateInput) {
                console.error("Campos do modal de agendamento não encontrados!");
                return;
            }

            const fields = [cepInput, streetInput, numberInput, neighborhoodInput, cityInput, stateInput];

            if (type === 'local') {
                salaContainer.classList.remove('hidden');
                domiciliarContainer.classList.add('hidden');
                salaSelect.required = true;
                fields.forEach(field => field.required = false);
            } else { // 'domiciliar'
                salaContainer.classList.add('hidden');
                domiciliarContainer.classList.remove('hidden');
                salaSelect.required = false;
                streetInput.required = true;
                numberInput.required = true;
                cityInput.required = true;
                cepInput.required = false;
                neighborhoodInput.required = false;
                stateInput.required = false;


                const patientId = document.getElementById('appointment-patient-id').value;
                if (patientId) {
                    const patient = allPatients.find(p => p.id === patientId);
                    if (patient) {
                        cepInput.value = patient.cep || '';
                        streetInput.value = patient.street || '';
                        numberInput.value = patient.number || '';
                        neighborhoodInput.value = patient.neighborhood || '';
                        cityInput.value = patient.city || '';
                        stateInput.value = patient.state || '';
                    } else {
                        fields.forEach(field => field.value = '');
                    }
                } else {
                     fields.forEach(field => field.value = '');
                }
            }
        }


        // --- GLOBAL EVENT LISTENER ---
        document.body.addEventListener('click', async (e) => {
            if (!currentUserClinicId && !e.target.closest('#force-password-change-form')) return;

            const target = e.target;

            if (target.closest('.appointment-item[data-appointment-id]')) {
                e.stopPropagation();
                const appointmentId = target.closest('.appointment-item').dataset.appointmentId;
                openAppointmentDetailModal(appointmentId);
            } else if (target.closest('.calendar-day[data-date]') || target.closest('[data-date]:not(.appointment-item)')) {
                const dateElement = target.closest('[data-date]');
                if (dateElement && dateElement.dataset.date) {
                   const date = dateElement.dataset.date;
                   openAppointmentDetailModal(null, date);
                }
            } else if (target.closest('#quick-add-appointment-btn')) {
                 openAppointmentDetailModal(null, getDateString(new Date()));
            } else if (target.closest('#add-appointment-agenda-btn')) {
               const defaultDate = (currentAgendaView === 'daily') ? getDateString(currentDate) : getDateString(new Date());
               openAppointmentDetailModal(null, defaultDate);
            } else if (target.closest('#delete-appointment-btn')) {
                const appointmentId = document.getElementById('appointment-id').value;
                const recurrenceId = document.getElementById('appointment-recurrence-id').value;
                
                if (recurrenceId) {
                    recurrenceAction.type = 'delete';
                    recurrenceAction.originalEventDate = document.getElementById('appointment-date').value;
                    recurrenceAction.appointmentData = { id: appointmentId, recurrenceId };
                    openModal(recurrenceOptionsModal);
                    document.getElementById('recurrence-options-title').textContent = 'Excluir evento recorrente';
                    document.getElementById('recurrence-options-text').textContent = 'Como você gostaria de excluir?';
                } else if (appointmentId) {
                   showConfirmation('Excluir Agendamento', 'Tem certeza que deseja excluir este agendamento?', () => handleAppointmentDeletion(appointmentId));
                }
            }
             else if (target.closest('.view-record-btn')) {
                 const patientId = target.closest('.view-record-btn').dataset.id;
                 openPatientRecordModal(patientId);
            } else if (target.closest('.edit-patient-btn')) {
                const patientId = target.closest('.edit-patient-btn').dataset.id;
                const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                 try {
                    const docSnap = await getDoc(patientDocRef);
                    if (docSnap.exists()) {
                        const patient = docSnap.data();
                        document.getElementById('patient-modal-title').innerText = 'Editar Paciente';
                        document.getElementById('patient-id').value = patientId;
                        document.getElementById('patient-name').value = formatName(patient.name || '');
                        document.getElementById('patient-cpf').value = formatCPF(patient.cpf || '');
                        document.getElementById('patient-birthDate').value = patient.birthDate || '';
                        document.getElementById('patient-gender').value = patient.gender || '';
                        document.getElementById('patient-phone').value = formatPhone(patient.phone || '');
                        document.getElementById('patient-caregiver').value = formatName(patient.caregiver || '');
                        document.getElementById('patient-cep').value = patient.cep || '';
                        document.getElementById('patient-street').value = patient.street || '';
                        document.getElementById('patient-number').value = patient.number || '';
                        document.getElementById('patient-neighborhood').value = patient.neighborhood || '';
                        document.getElementById('patient-city').value = patient.city || '';
                        document.getElementById('patient-state').value = patient.state || '';
                        document.getElementById('patient-observations').value = patient.observations || '';
                        openModal(patientModal);
                    }
                 } catch (error) {
                      console.error("Erro ao buscar paciente para edição:", error);
                      showJsMessage('Erro', 'Erro ao carregar dados do paciente.', true);
                 }
            } else if (target.closest('.delete-patient-btn')) {
                const patientId = target.closest('.delete-patient-btn').dataset.id;
                showConfirmation('Excluir Paciente', 'Isso excluirá o paciente e todas as suas evoluções. Continuar?', () => {
                    const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                    deleteDoc(patientDocRef).catch(error => showJsMessage('Erro', 'Erro ao excluir paciente.', true));
                });
            } else if (target.closest('#add-patient-btn') || target.closest('#quick-add-patient-btn')) {
                document.getElementById('patient-form').reset();
                document.getElementById('patient-id').value = '';
                document.getElementById('patient-modal-title').innerText = 'Adicionar Novo Paciente';
                openModal(patientModal);
            }
            else if (target.closest('#record-modal-add-initial-assessment-btn')) {
                 if(!selectedPatientId) return showJsMessage('Erro', 'Nenhum paciente selecionado.', true);
                 openAssessmentModal('initial');
            } else if (target.closest('#record-modal-add-evolution-btn')) {
                 if(!selectedPatientId) return showJsMessage('Erro', 'Nenhum paciente selecionado.', true);
                 openEvolutionModal();
            } else if (target.closest('#record-modal-add-discharge-btn')) {
                 if(!selectedPatientId) return showJsMessage('Erro', 'Nenhum paciente selecionado.', true);
                 openDischargeModal();
            } else if (target.closest('.view-assessment-btn')) {
                if(!selectedPatientId) return showJsMessage('Erro', 'Nenhum paciente selecionado.', true);
                const assessmentId = target.closest('.view-assessment-btn').dataset.id;
                const assessmentDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId, 'assessments', assessmentId);
                 try {
                    const docSnap = await getDoc(assessmentDocRef);
                    if (docSnap.exists()) {
                        populateAssessmentDetailModal(docSnap.data());
                        assessmentDetailModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        assessmentDetailModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                        const type = docSnap.data().type;
                        if (type === 'evolution') {
                            assessmentDetailModal.querySelector('#detail-tab-evolution')?.classList.remove('hidden');
                            assessmentDetailModal.querySelector('[data-tab="detail-tab-evolution"]')?.classList.add('active');
                        } else if (type === 'discharge') {
                             assessmentDetailModal.querySelector('#detail-tab-discharge')?.classList.remove('hidden');
                             assessmentDetailModal.querySelector('[data-tab="detail-tab-discharge"]')?.classList.add('active');
                        } else { // initial
                            assessmentDetailModal.querySelector('#detail-tab1')?.classList.remove('hidden');
                            assessmentDetailModal.querySelector('[data-tab="detail-tab1"]')?.classList.add('active');
                        }

                        openModal(assessmentDetailModal);
                    } else {
                         console.error("Avaliação não encontrada:", assessmentId);
                         showJsMessage('Erro', 'Avaliação não encontrada.', true);
                    }
                } catch(error) {
                     console.error("Erro ao buscar detalhes da avaliação:", error);
                     showJsMessage('Erro', 'Erro ao buscar detalhes da avaliação.', true);
                }
            }
            else if (target.closest('.change-role-btn')) {
                document.getElementById('change-role-user-id').value = target.closest('.change-role-btn').dataset.id;
                document.getElementById('change-role-user-email').textContent = target.closest('.change-role-btn').dataset.email;
                document.getElementById('change-role-select').value = target.closest('.change-role-btn').dataset.role;
                openModal(changeRoleModal);
            } else if (target.closest('.remove-member-btn')) {
                const userIdToRemove = target.closest('.remove-member-btn').dataset.id;
                const userEmail = target.closest('.remove-member-btn').dataset.email;
                showConfirmation('Remover Membro', `Tem certeza que deseja remover ${userEmail} da clínica?`, async () => {
                     showLoading();
                    try {
                        const userDocRef = doc(db, 'users', userIdToRemove);
                        await updateDoc(userDocRef, {
                            clinicId: deleteField(),
                            role: deleteField()
                        });
                        showJsMessage('Sucesso', 'Membro removido com sucesso!');
                    } catch (error) {
                        console.error("Erro ao remover membro:", error);
                        showJsMessage('Erro', 'Erro ao remover membro.', true);
                    } finally {
                         hideLoading();
                    }
                });
            } else if (target.closest('#edit-clinic-data-btn')) {
                if (!currentUserClinicId) {
                    showJsMessage('Erro', 'ID da clínica não encontrado. Tente recarregar a página.', true);
                    return;
                }
                const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
                 try {
                     showLoading();
                    const clinicDocSnap = await getDoc(clinicDocRef);
                    if (clinicDocSnap.exists()) {
                        populateClinicEditModal(clinicDocSnap.data());
                        openModal(clinicEditModal);
                    } else {
                        throw new Error("Documento da clínica não encontrado no Firestore.");
                    }
                 } catch (error) {
                     console.error("Erro ao buscar dados da clínica para edição:", error);
                     showJsMessage('Erro', 'Erro ao buscar dados da clínica.', true);
                 } finally {
                      hideLoading();
                 }
            } else if (target.closest('#add-payment-btn')) {
                 document.getElementById('financial-record-form').reset();
                 document.getElementById('financial-record-id').value = '';
                 document.getElementById('financial-modal-title').innerText = 'Lançar Pagamento';
                 populatePatientDatalist();
                 document.getElementById('financial-date').valueAsDate = new Date();
                 openModal(financialRecordModal);
            } else if (target.closest('#add-room-btn')) {
                document.getElementById('room-form').reset();
                document.getElementById('room-id').value = '';
                document.getElementById('room-modal-title').textContent = 'Adicionar Nova Sala';
                openModal(roomModal);
            } else if (target.closest('.edit-room-btn')) {
                const roomId = target.closest('.edit-room-btn').dataset.id;
                const roomName = target.closest('.edit-room-btn').dataset.name;
                document.getElementById('room-form').reset();
                document.getElementById('room-id').value = roomId;
                document.getElementById('room-name').value = roomName;
                document.getElementById('room-modal-title').textContent = 'Editar Sala';
                openModal(roomModal);
            } else if (target.closest('.delete-room-btn')) {
                const roomId = target.closest('.delete-room-btn').dataset.id;
                const roomName = target.closest('.delete-room-btn').dataset.name;
                showConfirmation('Excluir Sala', `Tem certeza que deseja excluir a sala "${roomName}"?`, async () => {
                     showLoading();
                    try {
                        await deleteDoc(doc(db, 'clinics', currentUserClinicId, 'rooms', roomId));
                        showJsMessage('Sucesso', 'Sala excluída com sucesso!');
                    } catch (error) {
                        console.error("Erro ao excluir sala:", error);
                        showJsMessage('Erro', 'Erro ao excluir sala.', true);
                    } finally {
                         hideLoading();
                    }
                });
            } else if (target.closest('#save-preferences-btn')) {
                handleSavePreferences();
            } else if (target.closest('#change-password-btn') || target.closest('#config-change-password-btn')) {
                 document.getElementById('force-password-change-form').reset();
                 document.getElementById('password-modal-title').textContent = 'Alterar Senha';
                 document.getElementById('password-modal-description').textContent = 'Por segurança, confirme sua senha atual para definir uma nova.';
                 document.getElementById('force-password-change-error').textContent = '';
                 openModal(forcePasswordChangeModal);
            }
        });

        async function openPatientQuickViewModal(patientId) {
             if (!currentUserClinicId || !patientId) return;
             showLoading();
             try {
                 const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                 const docSnap = await getDoc(patientDocRef);

                 if (docSnap.exists()) {
                     const patient = docSnap.data();
                     const orDefault = (value) => value || 'Não informado';
                     const age = patient.birthDate ? new Date().getFullYear() - new Date(patient.birthDate).getFullYear() : 'N/A';
                     const fullAddress = constructPatientAddress(patient);

                     document.getElementById('quick-view-patient-name').textContent = patient.name;
                     document.getElementById('quick-view-age').textContent = orDefault(age + ' anos');
                     document.getElementById('quick-view-phone').textContent = orDefault(patient.phone);
                     document.getElementById('quick-view-cpf').textContent = orDefault(patient.cpf);
                     document.getElementById('quick-view-address').textContent = orDefault(fullAddress);
                     document.getElementById('quick-view-caregiver').textContent = orDefault(patient.caregiver);
                     document.getElementById('quick-view-observations').textContent = orDefault(patient.observations);

                     openModal(patientQuickViewModal);
                 } else {
                     showJsMessage('Erro', 'Detalhes do paciente não encontrados.', true);
                 }
             } catch(error) {
                  console.error("Erro ao abrir detalhes rápidos:", error);
                  showJsMessage('Erro', 'Erro ao carregar detalhes do paciente.', true);
             } finally {
                 hideLoading();
             }
         }

        async function openPatientRecordModal(patientId) {
            if (!currentUserClinicId || !patientId) return;

            showLoading();
            selectedPatientId = patientId;

            try {
                const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                const patientDocSnap = await getDoc(patientDocRef);

                if (!patientDocSnap.exists()) {
                    throw new Error("Paciente não encontrado");
                }
                const patient = patientDocSnap.data();

                // Populate patient info
                document.getElementById('record-modal-patient-name').textContent = patient.name;
                const infoContainer = document.getElementById('record-modal-patient-info');
                const age = patient.birthDate ? `${new Date().getFullYear() - new Date(patient.birthDate).getFullYear()} anos` : 'N/A';
                infoContainer.innerHTML = `
                    <p><strong>Idade:</strong> ${age}</p>
                    <p><strong>Telefone:</strong> ${formatPhone(patient.phone)}</p>
                    <p><strong>CPF:</strong> ${formatCPF(patient.cpf)}</p>
                `;

                // Set up listener for assessments
                if (assessmentsUnsubscribe) assessmentsUnsubscribe();
                const assessmentsCol = collection(db, 'clinics', currentUserClinicId, 'patients', patientId, 'assessments');
                const q = query(assessmentsCol, orderBy("createdAt", "desc"));
                assessmentsUnsubscribe = onSnapshot(q, (snapshot) => {
                    const assessments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAssessmentsForModal(assessments);
                }, (error) => {
                    console.error("Erro ao buscar evoluções no modal:", error);
                    document.getElementById('record-modal-assessments-container').innerHTML = '<p class="text-red-500">Erro ao carregar histórico.</p>';
                });

                openModal(patientRecordModal);

            } catch (error) {
                console.error("Erro ao abrir prontuário do paciente:", error);
                showJsMessage('Erro', 'Não foi possível carregar o prontuário do paciente.', true);
                selectedPatientId = null;
            } finally {
                hideLoading();
            }
        }


        async function openAssessmentModal(type, assessmentData = null) {
            if (!selectedPatientId || !currentUserClinicId) return;

            document.getElementById('assessment-form').reset();
            document.getElementById('assessment-form').dataset.type = type;
            document.getElementById('assessment-form').dataset.assessmentId = '';

            const title = 'Nova Avaliação Inicial';
            document.getElementById('assessment-modal-title').textContent = title;

            populateProfessionalSelects(clinicUsers, 'assessment-professional');

            document.querySelector('#dor-local-container')?.classList.add('hidden');
            document.querySelector('#edema-local-container')?.classList.add('hidden');

            assessmentModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            assessmentModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            assessmentModal.querySelector('[data-tab="tab1"]')?.classList.add('active');
            assessmentModal.querySelector('#tab1')?.classList.remove('hidden');

            openModal(assessmentModal);
        }

        async function openEvolutionModal() {
            if (!selectedPatientId || !currentUserClinicId) return;

            showLoading();

            document.getElementById('evolution-form').reset();
            document.getElementById('evolution-date').valueAsDate = new Date();

            let nextSessionNumber = 1;
            try {
                const assessmentsCol = collection(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId, 'assessments');
                const q = query(assessmentsCol, orderBy("createdAt", "desc"), limit(1));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const lastAssessment = snapshot.docs[0].data();
                    const lastSessionNumber = lastAssessment.sessionNumber || 0;
                    nextSessionNumber = lastSessionNumber + 1;
                }
            } catch (error) {
                console.error("Erro ao buscar último Nº da Sessão:", error);
                showJsMessage(
                    'Ação Necessária no Firebase', 
                    'A busca pelo número da sessão falhou. Isso geralmente significa que um índice precisa ser criado no seu banco de dados. Por favor, verifique o console do navegador (F12) para o link de criação do índice.',
                    true
                );
            }

            document.getElementById('evolution-session-number').value = nextSessionNumber;
            populateProfessionalSelects(clinicUsers, 'evolution-professional');
            hideLoading();
            openModal(evolutionModal);
        }

        async function openDischargeModal() {
            if (!selectedPatientId || !currentUserClinicId) return;

            document.getElementById('discharge-form').reset();

            populateProfessionalSelects(clinicUsers, 'discharge-professional');

            dischargeModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            dischargeModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            dischargeModal.querySelector('[data-tab="discharge-tab1"]')?.classList.add('active');
            dischargeModal.querySelector('#discharge-tab1')?.classList.remove('hidden');

            openModal(dischargeModal);
        }

        // --- FORM SUBMISSIONS ---
        document.getElementById('patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const patientId = document.getElementById('patient-id').value;
            const patientData = {
                name: document.getElementById('patient-name').value,
                cpf: document.getElementById('patient-cpf').value.replace(/\D/g,''),
                birthDate: document.getElementById('patient-birthDate').value,
                gender: document.getElementById('patient-gender').value,
                phone: document.getElementById('patient-phone').value.replace(/\D/g,''),
                caregiver: document.getElementById('patient-caregiver').value,
                observations: document.getElementById('patient-observations').value,
                cep: document.getElementById('patient-cep').value,
                street: document.getElementById('patient-street').value,
                number: document.getElementById('patient-number').value,
                neighborhood: document.getElementById('patient-neighborhood').value,
                city: document.getElementById('patient-city').value,
                state: document.getElementById('patient-state').value,
                address: constructPatientAddress({
                    street: document.getElementById('patient-street').value,
                    number: document.getElementById('patient-number').value,
                    neighborhood: document.getElementById('patient-neighborhood').value,
                    city: document.getElementById('patient-city').value,
                    state: document.getElementById('patient-state').value
                })
            };
            try {
                showLoading();
                if (patientId) {
                    const patientDocRef = doc(db, 'clinics', currentUserClinicId, 'patients', patientId);
                    await setDoc(patientDocRef, patientData, { merge: true });
                    showJsMessage('Sucesso', 'Paciente editado com sucesso!');
                } else {
                    patientData.createdAt = serverTimestamp();
                    const patientsCollection = collection(db, 'clinics', currentUserClinicId, 'patients');
                    const newPatientDocRef = await addDoc(patientsCollection, patientData);

                    // Adicionado: Cria registro de sessão zero para o novo paciente
                    const assessmentsCol = collection(db, 'clinics', currentUserClinicId, 'patients', newPatientDocRef.id, 'assessments');
                    const sessionZeroData = {
                        type: 'system_init',
                        sessionNumber: 0,
                        createdAt: serverTimestamp(),
                        professionalId: currentUserId,
                        professionalName: currentUserName
                    };
                    await addDoc(assessmentsCol, sessionZeroData);
                    
                    showJsMessage('Sucesso', 'Paciente adicionado com sucesso!');
                }
                closeModal(patientModal);
            } catch (error) {
                 console.error("Erro ao salvar paciente:", error);
                 showJsMessage('Erro', 'Erro ao salvar paciente.', true);
            } finally {
                 hideLoading();
            }
        });

        document.getElementById('assessment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedPatientId) {
                showJsMessage('Erro', 'Nenhum paciente selecionado para adicionar evolução.', true);
                return;
            }
            showLoading();

            const formEl = document.getElementById('assessment-form');
            const type = formEl.dataset.type || 'initial';
            const professionalSelect = document.getElementById('assessment-professional');
            const professionalId = professionalSelect.value;
            const selectedOption = professionalSelect.options[professionalSelect.selectedIndex];
            
            if (!professionalId) {
                showJsMessage('Erro', 'Por favor, selecione o profissional responsável pelo registro.', true);
                hideLoading();
                return;
            }
            const professionalName = selectedOption.dataset.name || selectedOption.textContent.replace(/\s\(.*\)/, '');


            const barreiras = Array.from(document.querySelectorAll('input[name="barreiras"]:checked')).map(el => el.value);
            const assessmentData = {
                diagMedico: document.getElementById('diag-medico').value, comorbidades: document.getElementById('comorbidades').value, medicacoes: document.getElementById('medicacoes').value,
                cirurgias: document.getElementById('cirurgias').value, queixas: document.getElementById('queixas').value, dorEva: document.getElementById('dor-eva').value,
                dorLocal: document.getElementById('dor-local').value, habitos: document.getElementById('habitos').value,
                consciencia: document.getElementById('consciencia').value, orientacao: document.getElementById('orientacao').value, comunicacao: document.getElementById('comunicacao').value,
                postura: document.getElementById('postura').value, marcha: document.getElementById('marcha').value, equilibrio: document.getElementById('equilibrio').value, adm: document.getElementById('adm').value,
                forca: document.getElementById('forca').value, tonus: document.getElementById('tonus').value, coordenacao: document.getElementById('coordenacao').value, sensibilidade: document.getElementById('sensibilidade').value,
                edema: document.getElementById('edema').value, edemaLocal: document.getElementById('edema-local').value, testesRealizados: document.getElementById('testes-realizados').value,
                banho: document.querySelector('input[name="banho"]:checked')?.value || '', vestir: document.querySelector('input[name="vestir"]:checked')?.value || '',
                alimentacao: document.querySelector('input[name="alimentacao"]:checked')?.value || '', continencia: document.querySelector('input[name="continencia"]:checked')?.value || '',
                fraldas: document.querySelector('input[name="fraldas"]:checked')?.value || '', transferencias: document.getElementById('transferencias').value, deambulacao: document.getElementById('deambulacao').value,
                residencia: document.querySelector('input[name="residencia"]:checked')?.value || '', iluminacao: document.querySelector('input[name="iluminacao"]:checked')?.value || '',
                espaco: document.querySelector('input[name="espaco"]:checked')?.value || '', barreiras,
                objetivos: document.getElementById('objetivos').value,
                type: type,
                professionalId: professionalId,
                professionalName: professionalName,
                registeredByUserId: currentUserId,
                registeredByName: currentUserName,
                createdAt: serverTimestamp(),
            };

             try {
                const assessmentsCol = collection(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId, 'assessments');
                await addDoc(assessmentsCol, assessmentData);
                closeModal(assessmentModal);
                showJsMessage('Sucesso', 'Avaliação inicial registrada com sucesso!');
             } catch (error) {
                  console.error("Erro ao salvar avaliação inicial:", error);
                 showJsMessage('Erro', 'Erro ao salvar avaliação inicial.', true);
             } finally {
                  hideLoading();
             }
        });

        document.getElementById('evolution-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedPatientId) {
                showJsMessage('Erro', 'Nenhum paciente selecionado para adicionar evolução.', true);
                return;
            }
            showLoading();

            const professionalSelect = document.getElementById('evolution-professional');
            const professionalId = professionalSelect.value;
            const selectedOption = professionalSelect.options[professionalSelect.selectedIndex];
            const professionalName = selectedOption.dataset.name || selectedOption.textContent.replace(/\s\(.*\)/, '');

            if (!professionalId) {
                showJsMessage('Erro', 'Por favor, selecione o profissional responsável pelo registro.', true);
                hideLoading();
                return;
            }

            const evolutionData = {
                type: 'evolution',
                sessionNumber: parseInt(document.getElementById('evolution-session-number').value),
                date: document.getElementById('evolution-date').value,
                procedures: document.getElementById('evolution-procedures').value,
                response: document.getElementById('evolution-response').value,
                notes: document.getElementById('evolution-notes').value,
                professionalId: professionalId,
                professionalName: professionalName,
                registeredByUserId: currentUserId,
                registeredByName: currentUserName,
                createdAt: serverTimestamp(),
            };

            try {
                const assessmentsCol = collection(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId, 'assessments');
                await addDoc(assessmentsCol, evolutionData);
                closeModal(evolutionModal);
                showJsMessage('Sucesso', 'Evolução registrada com sucesso!');
            } catch (error) {
                console.error("Erro ao salvar evolução:", error);
                showJsMessage('Erro', 'Erro ao salvar evolução.', true);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('discharge-form').addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!selectedPatientId) {
                showJsMessage('Erro', 'Nenhum paciente selecionado para dar alta.', true);
                return;
            }
            showLoading();

            const professionalSelect = document.getElementById('discharge-professional');
            const professionalId = professionalSelect.value;
            const selectedOption = professionalSelect.options[professionalSelect.selectedIndex];
            const professionalName = selectedOption.dataset.name || selectedOption.textContent.replace(/\s\(.*\)/, '');

            if (!professionalId) {
                showJsMessage('Erro', 'Por favor, selecione o profissional responsável pela alta.', true);
                hideLoading();
                return;
            }

            const dischargeData = {
                type: 'discharge',
                date: getDateString(new Date()),
                queixasFinais: document.getElementById('discharge-queixas-finais').value,
                dorEva: document.getElementById('discharge-dor-eva').value,
                marchaEquilibrio: document.getElementById('discharge-marcha-equilibrio').value,
                admForca: document.getElementById('discharge-adm-forca').value,
                funcionalidadeFinal: document.getElementById('discharge-funcionalidade').value,
                resultados: document.getElementById('discharge-resultados').value,
                motivo: document.getElementById('discharge-motivo').value,
                professionalId: professionalId,
                professionalName: professionalName,
                registeredByUserId: currentUserId,
                registeredByName: currentUserName,
                createdAt: serverTimestamp(),
            };

            try {
                const assessmentsCol = collection(db, 'clinics', currentUserClinicId, 'patients', selectedPatientId, 'assessments');
                await addDoc(assessmentsCol, dischargeData);
                closeModal(dischargeModal);
                showJsMessage('Sucesso', 'Alta registrada com sucesso!');
            } catch (error) {
                console.error("Erro ao registrar alta:", error);
                showJsMessage('Erro', 'Erro ao registrar alta.', true);
            } finally {
                hideLoading();
            }
        });

        // --- APPOINTMENT & RECURRENCE LOGIC ---

        function getAppointmentDataFromForm() {
            const form = document.getElementById('appointment-form');
            if (!form) return null;
        
            const patientInput = document.getElementById('appointment-patient-input');
            let patientId = document.getElementById('appointment-patient-id').value;
            const patientName = patientInput.value;
        
            if (!patientId || !allPatients.some(p => p.id === patientId && p.name === patientName)) {
                const foundPatient = allPatients.find(p => p.name.toLowerCase() === patientName.toLowerCase());
                if (!foundPatient) {
                    showJsMessage('Erro de Validação', 'Paciente inválido ou não encontrado. Por favor, selecione um paciente da lista.', true);
                    return null;
                }
                 patientId = foundPatient.id;
                 document.getElementById('appointment-patient-id').value = patientId;
            }
        
            const professionalSelect = document.getElementById('appointment-professional');
            const professionalId = professionalSelect.value;
            const professionalName = professionalSelect.options[professionalSelect.selectedIndex].dataset.name;
        
            const roomSelect = document.getElementById('appointment-room');
            const roomId = roomSelect.value;
            const roomName = roomSelect.options[roomSelect.selectedIndex]?.text || '';
        
            const serviceType = form.querySelector('input[name="serviceType"]:checked').value;
        
            let addressDetails = {};
            let fullAddress = '';
            if (serviceType === 'domiciliar') {
                addressDetails = {
                    cep: document.getElementById('appointment-cep').value,
                    street: document.getElementById('appointment-street').value,
                    number: document.getElementById('appointment-number').value,
                    neighborhood: document.getElementById('appointment-neighborhood').value,
                    city: document.getElementById('appointment-city').value,
                    state: document.getElementById('appointment-state').value,
                };
                fullAddress = constructPatientAddress(addressDetails);
            }
        
            return {
                patientId: patientId,
                patientName: patientName,
                professionalId,
                professionalName,
                roomId,
                roomName,
                serviceType,
                addressDetails,
                address: fullAddress,
                date: document.getElementById('appointment-date').value,
                time: document.getElementById('appointment-time').value,
                duration: document.getElementById('appointment-duration').value,
                notes: document.getElementById('appointment-notes').value
            };
        }
        
        async function handleAppointmentSaving(appointmentData) {
            if (!appointmentData) return;
        
            showLoading();
            const appointmentId = document.getElementById('appointment-id').value;
            const isRecurrence = document.getElementById('recurrence-toggle').checked;
        
            try {
                const appointmentsCol = collection(db, 'clinics', currentUserClinicId, 'appointments');
        
                if (isRecurrence && !appointmentId) {
                    // --- Criar nova recorrência ---
                    const recurrenceId = doc(collection(db, 'dummy')).id; // Gera um ID único
                    const count = parseInt(document.getElementById('recurrence-count').value) || 1;
                    const days = Array.from(document.querySelectorAll('#recurrence-days input:checked')).map(el => parseInt(el.value));
        
                    if (days.length === 0) {
                        throw new Error("Selecione ao menos um dia da semana para a recorrência.");
                    }
        
                    const batch = writeBatch(db);
                    let currentDate = new Date(appointmentData.date + 'T12:00:00');
                    let sessionsCreated = 0;
        
                    while (sessionsCreated < count) {
                        if (days.includes(currentDate.getDay())) {
                            const newAppointmentData = {
                                ...appointmentData,
                                date: getDateString(currentDate),
                                recurrenceId: recurrenceId,
                                createdAt: serverTimestamp(),
                            };
                            batch.set(doc(appointmentsCol), newAppointmentData);
                            sessionsCreated++;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    await batch.commit();
                    showJsMessage('Sucesso', 'Agendamentos recorrentes criados com sucesso!');
        
                } else if (appointmentId) {
                    // --- Editar agendamento único ---
                    const appointmentDocRef = doc(appointmentsCol, appointmentId);
                    await updateDoc(appointmentDocRef, appointmentData);
                    showJsMessage('Sucesso', 'Agendamento atualizado com sucesso!');
                } else {
                    // --- Criar agendamento único ---
                    const newAppointmentData = { ...appointmentData, createdAt: serverTimestamp() };
                    await addDoc(appointmentsCol, newAppointmentData);
                    showJsMessage('Sucesso', 'Agendamento criado com sucesso!');
                }
        
                closeModal(appointmentModal);
        
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                showJsMessage('Erro', error.message || 'Ocorreu um erro ao salvar o agendamento.', true);
            } finally {
                hideLoading();
            }
        }
        
        async function handleAppointmentDeletion(appointmentId) {
            if (!appointmentId) return;
            showLoading();
            try {
                const appointmentDocRef = doc(db, 'clinics', currentUserClinicId, 'appointments', appointmentId);
                await deleteDoc(appointmentDocRef);
                showJsMessage('Sucesso', 'Agendamento excluído com sucesso!');
            } catch(error) {
                console.error("Erro ao excluir agendamento:", error);
                showJsMessage('Erro', 'Erro ao excluir agendamento.', true);
            } finally {
                closeModal(appointmentModal);
                hideLoading();
            }
        }

        async function handleRecurrenceAction(scope) {
            const { type, appointmentData, originalEventDate } = recurrenceAction;
            
            if (!appointmentData || !appointmentData.recurrenceId) {
                showJsMessage('Erro', 'Dados de recorrência inválidos.', true);
                return;
            }

            showLoading();
            const appointmentsCol = collection(db, 'clinics', currentUserClinicId, 'appointments');

            try {
                if (type === 'save') {
                    if (scope === 'single') {
                        const { id, ...dataToUpdate } = appointmentData;
                        await updateDoc(doc(appointmentsCol, id), dataToUpdate);
                        showJsMessage('Sucesso', 'Agendamento atualizado com sucesso.');
                    } else if (scope === 'future') {
                        const q = query(appointmentsCol, where("recurrenceId", "==", appointmentData.recurrenceId), where("date", ">=", originalEventDate));
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        const { id, recurrenceId, date, ...dataToUpdate } = appointmentData;
                        snapshot.forEach(doc => {
                            batch.update(doc.ref, dataToUpdate);
                        });
                        await batch.commit();
                        showJsMessage('Sucesso', 'Este e os futuros agendamentos foram atualizados.');
                    }
                } else if (type === 'delete') {
                    if (scope === 'single') {
                        await deleteDoc(doc(appointmentsCol, appointmentData.id));
                        showJsMessage('Sucesso', 'Agendamento excluído com sucesso.');
                    } else if (scope === 'future') {
                        const q = query(appointmentsCol, where("recurrenceId", "==", appointmentData.recurrenceId), where("date", ">=", originalEventDate));
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        showJsMessage('Sucesso', 'Este e os futuros agendamentos foram excluídos.');
                    }
                }

                closeModal(recurrenceOptionsModal);
                closeModal(appointmentModal);
            } catch (error) {
                console.error(`Erro ao ${type} recorrência (${scope}):`, error);
                showJsMessage('Erro', `Falha ao processar a operação nos agendamentos recorrentes.`, true);
            } finally {
                hideLoading();
            }
        }

        document.getElementById('recurrence-option-single').addEventListener('click', () => handleRecurrenceAction('single'));
        document.getElementById('recurrence-option-future').addEventListener('click', () => handleRecurrenceAction('future'));
        document.getElementById('recurrence-option-cancel').addEventListener('click', () => closeModal(recurrenceOptionsModal));


        document.getElementById('appointment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const appointmentId = document.getElementById('appointment-id').value;
            const recurrenceId = document.getElementById('appointment-recurrence-id').value;

            const appointmentData = getAppointmentDataFromForm();
            if (!appointmentData) return;

            if (appointmentId && recurrenceId) {
                recurrenceAction = {
                    type: 'save',
                    appointmentData: { id: appointmentId, ...appointmentData },
                    originalEventDate: document.getElementById('appointment-date').value,
                };
                openModal(recurrenceOptionsModal);
                document.getElementById('recurrence-options-title').textContent = 'Salvar evento recorrente';
                document.getElementById('recurrence-options-text').textContent = 'Como você gostaria de salvar as alterações?';
                return;
            }

            handleAppointmentSaving(appointmentData);
        });

        document.getElementById('financial-record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const patientInput = document.getElementById('financial-patient-input');
            let patientId = document.getElementById('financial-patient-id').value;
            const patientName = patientInput.value;
            const recordId = document.getElementById('financial-record-id').value;

             if (!patientId || !allPatients.some(p => p.id === patientId && p.name === patientName)) {
                 const foundPatient = allPatients.find(p => p.name.toLowerCase() === patientName.toLowerCase());
                 if (!foundPatient) {
                     showJsMessage('Erro', 'Paciente inválido ou não encontrado na lista. Por favor, selecione um paciente válido.', true);
                     return;
                 }
                 patientId = foundPatient.id;
             }

             const paymentData = {
                 patientId, patientName,
                 date: document.getElementById('financial-date').value,
                 value: document.getElementById('financial-value').value,
                 status: document.getElementById('financial-status').value,
                 description: document.getElementById('financial-description').value,
             };

             const paymentsCol = collection(db, 'clinics', currentUserClinicId, 'payments');

             try {
                 showLoading();
                 if (recordId) {
                    // await updateDoc(doc(paymentsCol, recordId), paymentData);
                 } else {
                    paymentData.createdAt = serverTimestamp();
                    await addDoc(paymentsCol, paymentData);
                 }
                 closeModal(financialRecordModal);
                 showJsMessage('Sucesso', 'Lançamento financeiro salvo com sucesso!');
             } catch (error) {
                  console.error("Erro ao salvar lançamento financeiro:", error);
                  showJsMessage('Erro', 'Erro ao salvar lançamento. Tente novamente.', true);
             } finally {
                 hideLoading();
             }
        });


        document.getElementById('room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomId = document.getElementById('room-id').value;
            const roomName = document.getElementById('room-name').value;

            if (!roomName) return;

            const roomData = { name: roomName };
            const roomsCol = collection(db, 'clinics', currentUserClinicId, 'rooms');

            try {
                showLoading();
                if (roomId) {
                    const roomDocRef = doc(roomsCol, roomId);
                    await updateDoc(roomDocRef, roomData);
                    showJsMessage('Sucesso', 'Sala atualizada com sucesso!');
                } else {
                    roomData.createdAt = serverTimestamp();
                    await addDoc(roomsCol, roomData);
                    showJsMessage('Sucesso', 'Nova sala adicionada com sucesso!');
                }
                closeModal(roomModal);
            } catch (error) {
                console.error("Erro ao salvar sala:", error);
                showJsMessage('Erro', 'Erro ao salvar sala. Tente novamente.', true);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('change-role-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userIdToChange = document.getElementById('change-role-user-id').value;
            const newRole = document.getElementById('change-role-select').value;

            const userDocRef = doc(db, 'users', userIdToChange);
            
            try {
                showLoading();
                await updateDoc(userDocRef, { role: newRole });
                closeModal(changeRoleModal);
                showJsMessage('Sucesso', 'Função alterada com sucesso!');
            } catch(error) {
                 console.error("Erro ao alterar função:", error);
                 showJsMessage('Erro', 'Erro ao alterar função. Tente novamente.', true);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('clinic-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            let updatedData = {};
            const accountType = document.getElementById('edit-accountType').value;

            const unmask = (value, type) => {
                if (!value) return '';
                if (type === 'cpf' || type === 'cnpj' || type === 'phone') {
                    return value.replace(/\D/g, '');
                }
                return value;
            }

            if (accountType === 'pf') {
                updatedData = {
                    name: document.getElementById('edit-pf-name').value,
                    birthDate: document.getElementById('edit-pf-birthDate').value,
                    rg: document.getElementById('edit-pf-rg').value,
                    cpf: unmask(document.getElementById('edit-pf-cpf').value, 'cpf'),
                    crefito: document.getElementById('edit-pf-crefito').value,
                    phone: unmask(document.getElementById('edit-pf-phone').value, 'phone'),
                    cep: document.getElementById('edit-pf-cep').value,
                    street: document.getElementById('edit-pf-street').value,
                    number: document.getElementById('edit-pf-number').value,
                    neighborhood: document.getElementById('edit-pf-neighborhood').value,
                    city: document.getElementById('edit-pf-city').value,
                    state: document.getElementById('edit-pf-state').value,
                };
            } else { // pj
                updatedData = {
                    name: document.getElementById('edit-pj-razaoSocial').value,
                    cnpj: unmask(document.getElementById('edit-pj-cnpj').value, 'cnpj'),
                    crefito: document.getElementById('edit-pj-crefito').value,
                    phone: unmask(document.getElementById('edit-pj-phone').value, 'phone'),
                    responsavelNome: document.getElementById('edit-pj-responsavel').value,
                    responsavelCpf: unmask(document.getElementById('edit-pj-responsavel-cpf').value, 'cpf'),
                    responsavelCrefito: document.getElementById('edit-pj-responsavel-crefito').value,
                    cep: document.getElementById('edit-pj-cep').value,
                    street: document.getElementById('edit-pj-street').value,
                    number: document.getElementById('edit-pj-number').value,
                    neighborhood: document.getElementById('edit-pj-neighborhood').value,
                    city: document.getElementById('edit-pj-city').value,
                    state: document.getElementById('edit-pj-state').value,
                };
            }
            updatedData.address = constructPatientAddress(updatedData);

            try {
                showLoading();
                const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
                await updateDoc(clinicDocRef, updatedData);
                closeModal(clinicEditModal);
                showJsMessage('Sucesso', 'Dados da clínica atualizados com sucesso!');
            } catch (error) {
                console.error("Erro ao atualizar dados da clínica:", error);
                showJsMessage('Erro', 'Erro ao atualizar dados da clínica. Tente novamente.', true);
            } finally {
                hideLoading();
            }
        });

        // --- NAVIGATION & VIEW CONTROL ---
        function switchView(viewName) {
            showLoading();

            if (patientsUnsubscribe) { patientsUnsubscribe(); patientsUnsubscribe = null; }
            if (appointmentsUnsubscribe) { appointmentsUnsubscribe(); appointmentsUnsubscribe = null; }
            if (paymentsUnsubscribe) { paymentsUnsubscribe(); paymentsUnsubscribe = null; }
            if (membersUnsubscribe) { membersUnsubscribe(); membersUnsubscribe = null; }
            if (roomsUnsubscribe) { roomsUnsubscribe(); roomsUnsubscribe = null; }
             if (dashboardAppointmentsUnsubscribe) { dashboardAppointmentsUnsubscribe(); dashboardAppointmentsUnsubscribe = null; }
             if (assessmentsUnsubscribe) { assessmentsUnsubscribe(); assessmentsUnsubscribe = null;}


            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(`nav-${viewName}`);
            if (activeLink) activeLink.classList.add('active');

            mainContentContainer.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });

            const targetPage = document.getElementById(`page-${viewName}`);
            if(targetPage) {
                targetPage.classList.add('active');
            } else {
                 console.error(`Page #page-${viewName} not found!`);
                 hideLoading();
                 return;
            }

             const fetchDataPromises = [];

             if (viewName === 'inicio') {
                 fetchDataPromises.push(fetchAndRenderDashboardData());
             } else if (viewName === 'pacientes') {
                 if(allPatients.length > 0) renderPatientList(allPatients);
                 else fetchDataPromises.push(fetchAndRenderPatients());
                 const searchInput = mainContentContainer.querySelector('#search-patient');
                 if (searchInput) {
                     const newSearchInput = searchInput.cloneNode(true);
                     searchInput.parentNode.replaceChild(newSearchInput, searchInput);
                     newSearchInput.addEventListener('input', handlePatientSearch);
                 }
                 selectedPatientId = null;

             } else if (viewName === 'agenda') {
                 currentAgendaView = clinicPreferences.defaultAgendaView;
                 setupAgendaListeners();
                 fetchDataPromises.push(updateAgenda());
             } else if(viewName === 'financeiro') {
                 populatePatientDatalist();
                 fetchDataPromises.push(fetchAndRenderAllPayments());
                  const finPatientInput = document.getElementById('financial-patient-input');
                  if(finPatientInput) {
                      const newFinInput = finPatientInput.cloneNode(true);
                      finPatientInput.parentNode.replaceChild(newFinInput, finPatientInput);
                      newFinInput.addEventListener('input', handlePatientInput);
                  }

            } else if (viewName === 'configuracoes') {
                const adminView = document.getElementById('admin-view');
                const nonAdminView = document.getElementById('non-admin-view');

                if (currentUserRole === 'admin') {
                    if(nonAdminView) nonAdminView.classList.add('hidden');
                    if(adminView) adminView.classList.remove('hidden');

                    fetchDataPromises.push(
                        fetchAndRenderClinicData(),
                        fetchAndRenderMembers(),
                        fetchAndRenderRooms()
                    );

                    const createUserForm = mainContentContainer.querySelector('#create-user-form');
                    if(createUserForm) {
                        const newForm = createUserForm.cloneNode(true);
                        createUserForm.parentNode.replaceChild(newForm, createUserForm);
                        newForm.addEventListener('submit', handleCreateUser);
                    }
                    const savePrefsBtn = document.getElementById('save-preferences-btn');
                    if(savePrefsBtn) {
                        const newBtn = savePrefsBtn.cloneNode(true);
                        savePrefsBtn.parentNode.replaceChild(newBtn, savePrefsBtn);
                        newBtn.addEventListener('click', handleSavePreferences);
                    }
                } else {
                    if(adminView) adminView.classList.add('hidden');
                    if(nonAdminView) nonAdminView.classList.remove('hidden');
                }
             }
              const appPatientInput = document.getElementById('appointment-patient-input');
              if(appPatientInput) {
                   const newAppInput = appPatientInput.cloneNode(true);
                   appPatientInput.parentNode.replaceChild(newAppInput, appPatientInput);
                   newAppInput.addEventListener('input', handlePatientInput);
              }

             Promise.allSettled(fetchDataPromises).then(() => {
                 hideLoading();
             }).catch(err => {
                 console.error(`Error during initial data fetch/render for ${viewName}:`, err);
                 hideLoading();
             });
        }

        function renderMembersList(users) {
            const currentMembersListDiv = document.getElementById('members-list');
             if (!currentMembersListDiv) return;

             currentMembersListDiv.innerHTML = '<div class="space-y-2"></div>';
             const list = currentMembersListDiv.querySelector('.space-y-2');
             if (users.length === 0) {
                 list.innerHTML = '<p class="text-gray-500">Nenhum membro encontrado.</p>';
             } else {
                 users.sort((a,b) => a.email.localeCompare(b.email)).forEach(member => {
                     const memberId = member.id;
                     const isCurrentUser = memberId === currentUserId;

                     const memberDiv = document.createElement('div');
                     memberDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                     memberDiv.innerHTML = `
                         <div>
                             <p class="font-semibold">${member.email} ${isCurrentUser ? '(Você)' : ''}</p>
                             <p class="text-sm text-gray-600 capitalize">${member.role}</p>
                         </div>
                         <div class="flex gap-2">
                            ${!isCurrentUser ? `
                            <button data-id="${memberId}" data-email="${member.email}" data-role="${member.role}" class="change-role-btn text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Alterar Função</button>
                            <button data-id="${memberId}" data-email="${member.email}" class="remove-member-btn text-sm bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Remover</button>
                            ` : ''}
                         </div>
                     `;
                     list.appendChild(memberDiv);
                 });
             }
        }


        async function handleSavePreferences() {
                const newDefaultView = document.getElementById('default-agenda-view').value;
                const newDefaultServiceType = document.getElementById('default-service-type').value;
                const clinicDocRef = doc(db, 'clinics', currentUserClinicId);
                try {
                    showLoading();
                    await updateDoc(clinicDocRef, {
                        'preferences.defaultAgendaView': newDefaultView,
                        'preferences.defaultServiceType': newDefaultServiceType
                    });
                    clinicPreferences.defaultAgendaView = newDefaultView;
                    clinicPreferences.defaultServiceType = newDefaultServiceType;
                    showJsMessage('Sucesso', 'Preferências salvas!');
                } catch (error) {
                    console.error("Erro ao salvar preferências:", error);
                    showJsMessage('Erro', 'Erro ao salvar preferências.', true);
                } finally {
                     hideLoading();
                }
        }

        function handlePatientSearch(e) {
             const searchTerm = e.target.value.toLowerCase();
             const filteredPatients = allPatients.filter(p => p.name.toLowerCase().includes(searchTerm));
             renderPatientList(filteredPatients);
        }


        function handlePatientInput(e) {
            const inputValue = e.target.value;
            const listId = e.target.getAttribute('list');
            const datalistElement = document.getElementById(listId);
            const hiddenIdInput = document.getElementById(e.target.id.replace('-input', '-id'));

            if (!hiddenIdInput || !datalistElement) return;

            hiddenIdInput.value = '';
            const options = datalistElement.options;
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === inputValue) {
                    hiddenIdInput.value = options[i].dataset.id;
                    
                     if (e.target.id === 'appointment-patient-input') {
                         const serviceType = document.querySelector('input[name="serviceType"]:checked')?.value;
                         if (serviceType === 'domiciliar') {
                             const patient = allPatients.find(p => p.id === hiddenIdInput.value);
                             if (patient) {
                                document.getElementById('appointment-cep').value = patient.cep || '';
                                document.getElementById('appointment-street').value = patient.street || '';
                                document.getElementById('appointment-number').value = patient.number || '';
                                document.getElementById('appointment-neighborhood').value = patient.neighborhood || '';
                                document.getElementById('appointment-city').value = patient.city || '';
                                document.getElementById('appointment-state').value = patient.state || '';
                             }
                         }
                     }
                    break;
                }
            }
        }


        async function fetchAddressFromCEP(cep, formPrefix = 'patient') {
            const cepClean = cep.replace(/\D/g, '');
            if (cepClean.length !== 8) return;

            const streetEl = document.getElementById(`${formPrefix}-street`);
            const neighborhoodEl = document.getElementById(`${formPrefix}-neighborhood`);
            const cityEl = document.getElementById(`${formPrefix}-city`);
            const stateEl = document.getElementById(`${formPrefix}-state`);
            const numberEl = document.getElementById(`${formPrefix}-number`);

            if (!streetEl || !neighborhoodEl || !cityEl || !stateEl) {
                console.error("Campos de endereço não encontrados no formulário:", formPrefix);
                return;
            }

            try {
                showLoading();
                const response = await fetch(`https://viacep.com.br/ws/${cepClean}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado');

                const data = await response.json();

                if (data.erro) {
                    streetEl.value = '';
                    neighborhoodEl.value = '';
                    cityEl.value = '';
                    stateEl.value = '';
                } else {
                    streetEl.value = data.logradouro || '';
                    neighborhoodEl.value = data.bairro || '';
                    cityEl.value = data.localidade || '';
                    stateEl.value = data.uf || '';
                    if (numberEl) numberEl.focus();
                }
            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
            } finally {
                hideLoading();
            }
        }


        async function fetchAndRenderDashboardData() {
             if (!currentUserClinicId) return Promise.resolve();

             if (dashboardAppointmentsUnsubscribe) {
                  dashboardAppointmentsUnsubscribe();
                  dashboardAppointmentsUnsubscribe = null;
              }

             const patientsCountEl = document.getElementById('active-patients-count');
             if (patientsCountEl) {
                  const patientsCol = collection(db, "clinics", currentUserClinicId, "patients");
                   try {
                        const snapshot = await getDocs(patientsCol);
                        const currentPatientsCountEl = document.getElementById('active-patients-count');
                        if(currentPatientsCountEl) {
                            currentPatientsCountEl.textContent = snapshot.size;
                        }
                   } catch (error) {
                        console.error("Error fetching patient count:", error)
                   };
             }

             const todayAppointmentsEl = document.getElementById('today-appointments');
             if (todayAppointmentsEl) {
                 const todayStr = getDateString(new Date());
                 const appointmentsCol = collection(db, 'clinics', currentUserClinicId, 'appointments');
                 const q = query(appointmentsCol, where('date', '==', todayStr));

                 return new Promise((resolve, reject) => {
                     dashboardAppointmentsUnsubscribe = onSnapshot(q, (snapshot) => {
                         const currentTodayAppointmentsEl = document.getElementById('today-appointments');
                         if(!currentTodayAppointmentsEl) {
                              if (dashboardAppointmentsUnsubscribe) { dashboardAppointmentsUnsubscribe(); dashboardAppointmentsUnsubscribe = null; }
                              resolve();
                              return;
                         }
                         
                         if(snapshot.empty) {
                             currentTodayAppointmentsEl.innerHTML = '<p class="text-gray-500">Nenhum agendamento para hoje.</p>';
                         } else {
                             const appointments = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                             appointments.sort((a, b) => a.time.localeCompare(b.time));

                             currentTodayAppointmentsEl.innerHTML = appointments.map(app => {
                                 return `<div class="appointment-item p-2 bg-gray-100 rounded-md cursor-pointer" data-appointment-id="${app.id}">
                                     <p class="font-semibold">${app.time} - ${app.patientName}</p>
                                 </div>`
                             }).join('');
                         }
                         resolve();
                     }, (error) => {
                          console.error("Error fetching today's appointments:", error);
                          const currentTodayAppointmentsEl = document.getElementById('today-appointments');
                          if(currentTodayAppointmentsEl) currentTodayAppointmentsEl.innerHTML = '<p class="text-red-500">Erro ao carregar agendamentos.</p>';
                          reject(error);
                     });
                 });
             } else {
                 return Promise.resolve();
             }
         }


        function setupAgendaListeners() {
            const prevBtn = document.getElementById('prev-period-btn');
            const nextBtn = document.getElementById('next-period-btn');
            const dailyBtn = document.getElementById('agenda-view-daily');
            const weeklyBtn = document.getElementById('agenda-view-weekly');
            const monthlyBtn = document.getElementById('agenda-view-monthly');
            const searchInput = document.getElementById('search-appointment');

            if(prevBtn) { const newBtn = prevBtn.cloneNode(true); prevBtn.parentNode.replaceChild(newBtn, prevBtn); newBtn.addEventListener('click', handlePrevPeriod); }
            if(nextBtn) { const newBtn = nextBtn.cloneNode(true); nextBtn.parentNode.replaceChild(newBtn, nextBtn); newBtn.addEventListener('click', handleNextPeriod); }
            if(dailyBtn) { const newBtn = dailyBtn.cloneNode(true); dailyBtn.parentNode.replaceChild(newBtn, dailyBtn); newBtn.addEventListener('click', () => handleViewChange('daily')); }
            if(weeklyBtn) { const newBtn = weeklyBtn.cloneNode(true); weeklyBtn.parentNode.replaceChild(newBtn, weeklyBtn); newBtn.addEventListener('click', () => handleViewChange('weekly')); }
            if(monthlyBtn) { const newBtn = monthlyBtn.cloneNode(true); monthlyBtn.parentNode.replaceChild(newBtn, monthlyBtn); newBtn.addEventListener('click', () => handleViewChange('monthly')); }
            if(searchInput) { const newInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newInput, searchInput); newInput.addEventListener('input', handleSearchInput); }
        }

        function handlePrevPeriod() {
             if (currentAgendaView === 'monthly') currentDate.setMonth(currentDate.getMonth() - 1);
             else if (currentAgendaView === 'weekly') currentDate.setDate(currentDate.getDate() - 7);
             else if (currentAgendaView === 'daily') currentDate.setDate(currentDate.getDate() - 1);
             updateAgenda();
        }
        function handleNextPeriod() {
             if (currentAgendaView === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
             else if (currentAgendaView === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
             else if (currentAgendaView === 'daily') currentDate.setDate(currentDate.getDate() + 1);
             updateAgenda();
        }
        function handleViewChange(view) {
            currentAgendaView = view;
            updateAgenda();
        }
        function handleSearchInput(e) {
             renderAgendaView(currentAppointments, e.target.value);
        }


        async function updateAgenda() {
             const agendaContentEl = mainContentContainer.querySelector('#agenda-content');
             if (!currentUserClinicId || !agendaContentEl) return Promise.resolve();
             if (appointmentsUnsubscribe) { appointmentsUnsubscribe(); appointmentsUnsubscribe = null; }

             ['daily', 'weekly', 'monthly'].forEach(view => {
                 const btn = document.getElementById(`agenda-view-${view}`);
                 if(btn) {
                     btn.classList.remove('bg-blue-500', 'text-white');
                     if(currentAgendaView === view) {
                         btn.classList.add('bg-blue-500', 'text-white');
                     }
                 }
             });

             const periodHeader = document.getElementById('period-header');
             let startDate, endDate;

             if (currentAgendaView === 'monthly') {
                 periodHeader.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} de ${currentDate.getFullYear()}`;
                 startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                 endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
             } else if (currentAgendaView === 'weekly') {
                 const startOfWeek = new Date(currentDate);
                 startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                 const endOfWeek = new Date(startOfWeek);
                 endOfWeek.setDate(startOfWeek.getDate() + 6);
                 periodHeader.textContent = `${startOfWeek.toLocaleDateString('pt-BR')} - ${endOfWeek.toLocaleDateString('pt-BR')}`;
                 startDate = startOfWeek;
                 endDate = endOfWeek;
             } else { // daily
                 periodHeader.textContent = currentDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
                 startDate = currentDate;
                 endDate = currentDate;
             }

             const appointmentsCol = collection(db, 'clinics', currentUserClinicId, 'appointments');
             const q = query(appointmentsCol, where('date', '>=', getDateString(startDate)), where('date', '<=', getDateString(endDate)));

              agendaContentEl.innerHTML = '<p class="text-center text-gray-500 py-8">Carregando agendamentos...</p>';


             return new Promise((resolve, reject) => {
                 appointmentsUnsubscribe = onSnapshot(q, (snapshot) => {
                      const currentAgendaContentEl = mainContentContainer.querySelector('#agenda-content');
                      if (!currentAgendaContentEl) {
                           if(appointmentsUnsubscribe) { appointmentsUnsubscribe(); appointmentsUnsubscribe = null; }
                          resolve();
                          return;
                      }

                     currentAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      const searchInput = document.getElementById('search-appointment');
                     renderAgendaView(currentAppointments, searchInput ? searchInput.value : '');
                     resolve();
                 }, (error) => {
                     console.error("Erro ao buscar agendamentos:", error);
                      const currentAgendaContentEl = mainContentContainer.querySelector('#agenda-content');
                      if (currentAgendaContentEl) {
                          currentAgendaContentEl.innerHTML = '<p class="text-center text-red-500 py-8">Erro ao carregar agendamentos.</p>';
                      }
                      reject(error);
                 });
             });
         }


        function fetchAndRenderAllPayments() {
             if (!currentUserClinicId) return Promise.resolve();
            if (paymentsUnsubscribe) { paymentsUnsubscribe(); paymentsUnsubscribe = null; }

            const paymentsCol = collection(db, 'clinics', currentUserClinicId, 'payments');
            const q = query(paymentsCol, orderBy('date', 'desc'));

             return new Promise((resolve, reject) => {
                 paymentsUnsubscribe = onSnapshot(q, (snapshot) => {
                     const payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      if(document.getElementById('payments-table-body')) {
                         renderAllPayments(payments);
                      }
                      resolve();
                 }, (error) => {
                     console.error("Erro ao buscar pagamentos:", error);
                     const tableBody = mainContentContainer.querySelector('#payments-table-body');
                     if (tableBody) tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-500">Erro ao carregar lançamentos.</td></tr>`;
                     reject(error);
                 });
             });
        }


        function fetchAndRenderRooms() {
             if (!currentUserClinicId) return Promise.reject("No clinic ID");
             const q = query(collection(db, "clinics", currentUserClinicId, "rooms"));
             
             if (roomsUnsubscribe) { roomsUnsubscribe(); roomsUnsubscribe = null; }
             return new Promise((resolve, reject) => {
                 roomsUnsubscribe = onSnapshot(q, (snapshot) => {
                     clinicRooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     const currentRoomsListDiv = document.getElementById('rooms-list');
                     if(currentRoomsListDiv) renderRoomsList(clinicRooms);
                     resolve();
                 }, (error) => {
                     console.error("Erro ao buscar salas:", error);
                      const currentRoomsListDiv = document.getElementById('rooms-list');
                     if(currentRoomsListDiv) currentRoomsListDiv.innerHTML = '<p class="text-red-500">Erro ao carregar salas.</p>';
                     reject(error);
                 });
             });
         }



        async function openAppointmentDetailModal(appointmentId, defaultDate = null) {
             if (!currentUserClinicId) return;

             showLoading();

             document.getElementById('appointment-form').reset();
             document.getElementById('appointment-id').value = '';
             document.getElementById('appointment-recurrence-id').value = '';
             document.getElementById('delete-appointment-btn').classList.add('hidden');
             
             const recurrenceSection = document.getElementById('recurrence-section');

             if (allPatients.length === 0) console.warn("Patient data not loaded for modal.");
             if (clinicUsers.length === 0) console.warn("User data not loaded for modal.");
             if (clinicRooms.length === 0) console.warn("Room data not loaded for modal.");

             populatePatientDatalist();

             const professionalSelect = document.getElementById('appointment-professional');
             populateProfessionalSelects(clinicUsers, 'appointment-professional');

             const roomSelect = document.getElementById('appointment-room');
             roomSelect.innerHTML = clinicRooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('') || '<option disabled selected>Nenhuma sala</option>';


             if (appointmentId) {
                recurrenceSection.style.display = 'none';
                 try {
                    const appointmentDocRef = doc(db, 'clinics', currentUserClinicId, 'appointments', appointmentId);
                    const docSnap = await getDoc(appointmentDocRef);

                    if (docSnap.exists()) {
                        const appData = docSnap.data();

                        document.getElementById('appointment-id').value = appointmentId;
                        document.getElementById('appointment-date').value = appData.date;
                        document.getElementById('appointment-recurrence-id').value = appData.recurrenceId || '';
                        document.getElementById('appointment-modal-title').textContent = `Editar Agendamento - ${new Date(appData.date + 'T12:00:00').toLocaleDateString('pt-BR')}`;
                        document.getElementById('appointment-patient-input').value = appData.patientName;
                        document.getElementById('appointment-patient-id').value = appData.patientId;

                        if (professionalSelect.querySelector(`option[value="${appData.professionalId}"]`)) {
                            professionalSelect.value = appData.professionalId;
                        } else { console.warn(`Professional ID ${appData.professionalId} not found.`); }

                        if (roomSelect.querySelector(`option[value="${appData.roomId}"]`)) {
                            roomSelect.value = appData.roomId;
                        } else { console.warn(`Room ID ${appData.roomId} not found.`); }

                        const serviceType = appData.serviceType || 'local';
                        document.querySelectorAll('input[name="serviceType"]').forEach(radio => {
                             radio.checked = (radio.value === serviceType);
                        });
                        toggleAppointmentFields(serviceType);
                        if (serviceType === 'domiciliar') {
                             const ad = appData.addressDetails || {};
                             document.getElementById('appointment-cep').value = ad.cep || '';
                             document.getElementById('appointment-street').value = ad.street || (appData.address || '');
                             document.getElementById('appointment-number').value = ad.number || '';
                             document.getElementById('appointment-neighborhood').value = ad.neighborhood || '';
                             document.getElementById('appointment-city').value = ad.city || '';
                             document.getElementById('appointment-state').value = ad.state || '';
                        }


                        document.getElementById('appointment-time').value = appData.time;
                        document.getElementById('appointment-duration').value = appData.duration;
                        document.getElementById('appointment-notes').value = appData.notes || '';

                        document.getElementById('delete-appointment-btn').classList.remove('hidden');
                        hideLoading();
                        openModal(appointmentModal);

                    } else {
                        console.error("Agendamento não encontrado:", appointmentId);
                        showJsMessage('Erro', 'Agendamento não encontrado.', true);
                        hideLoading();
                    }
                 } catch(error) {
                     console.error("Erro ao abrir detalhes do agendamento:", error);
                     showJsMessage('Erro', 'Erro ao abrir detalhes do agendamento.', true);
                     hideLoading();
                 }
             } else {
                recurrenceSection.style.display = 'block';
                document.getElementById('recurrence-toggle').checked = false;
                document.getElementById('recurrence-container').classList.add('hidden');

                const dateToSet = defaultDate || getDateString(new Date());
                document.getElementById('appointment-date').value = dateToSet;
                document.getElementById('appointment-modal-title').textContent = `Novo Agendamento - ${new Date(dateToSet + 'T12:00:00').toLocaleDateString('pt-BR')}`;

                const defaultServiceType = clinicPreferences.defaultServiceType || 'local';
                 document.querySelectorAll('input[name="serviceType"]').forEach(radio => {
                     radio.checked = (radio.value === defaultServiceType);
                 });
                 toggleAppointmentFields(defaultServiceType);

                hideLoading();
                openModal(appointmentModal);
             }
        }


        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewName = e.currentTarget.id.replace('nav-', '');
                switchView(viewName);
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                    mobileMenuOverlay.classList.add('hidden');
                }
            });
        });

        // --- AUTH & USER LOGIC ---

        async function handleGoogleSignIn() {
             showLoading();
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().clinicId) {
                    // Usuário existente e associado, onAuthStateChanged cuidará do resto.
                    return;
                } else {
                    showJsMessage('Conta Não Associada', 'Sua conta Google foi autenticada, mas não está associada a nenhuma clínica. Peça ao administrador da sua clínica para te convidar.', true);
                    await signOut(auth);
                }
            } catch (error) {
                console.error("Erro no login com Google:", error);
                 const errorEl = document.getElementById('login-error');
                 if (error.code === 'auth/popup-closed-by-user') {
                     errorEl.textContent = 'Pop-up de login fechado.';
                 } else {
                      errorEl.textContent = 'Erro ao fazer login com Google.';
                 }
            } finally {
                 hideLoading();
            }
        }
        
        async function handlePasswordChange(e) {
            e.preventDefault();
            const errorEl = document.getElementById('force-password-change-error');
            errorEl.textContent = '';
            showLoading();

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            
            if (newPassword.length < 8) {
                errorEl.textContent = 'A nova senha deve ter no mínimo 8 caracteres.';
                hideLoading();
                return;
            }
            if (newPassword !== confirmNewPassword) {
                 errorEl.textContent = 'As novas senhas não coincidem.';
                 hideLoading();
                 return;
            }

            const user = auth.currentUser;
            if (!user || !user.email) {
                 showJsMessage('Erro de Autenticação', 'Nenhum usuário logado. Faça login novamente.', true);
                 await signOut(auth);
                 hideLoading();
                 return;
            }

            const credential = EmailAuthProvider.credential(user.email, currentPassword);

            try {
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);

                const userDocRef = doc(db, 'users', user.uid);
                await updateDoc(userDocRef, { mustChangePassword: deleteField() });
                
                closeModal(forcePasswordChangeModal);
                showJsMessage("Sucesso", "Senha alterada com sucesso!");

            } catch (error) {
                console.error("Erro ao alterar senha:", error);
                 if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                     errorEl.textContent = 'Senha atual incorreta.';
                 } else if (error.code === 'auth/weak-password') {
                     errorEl.textContent = 'Senha muito fraca.';
                 } else {
                     errorEl.textContent = 'Erro ao alterar senha. Tente novamente.';
                 }
            } finally {
                hideLoading();
            }
        }
        
        async function handleCreateUser(e) {
            e.preventDefault();
            const feedbackEl = document.getElementById('create-user-feedback');
            feedbackEl.textContent = '';
            feedbackEl.classList.remove('text-red-500', 'text-green-500');

            const email = document.getElementById('new-user-email').value;
            const role = document.getElementById('new-user-role').value;

            showLoading();
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    feedbackEl.textContent = 'Este e-mail já está cadastrado no sistema.';
                    feedbackEl.classList.add('text-red-500');
                    hideLoading();
                    return;
                }
                
                showJsMessage("Convite Simulado", `Para convidar ${email}, peça para ele se registrar com este e-mail. O sistema irá associá-lo à sua clínica. (Em uma versão futura, um e-mail de convite será enviado).`);

                e.target.reset();

            } catch(error) {
                console.error("Erro ao tentar criar usuário:", error);
                feedbackEl.textContent = 'Erro ao criar usuário.';
                feedbackEl.classList.add('text-red-500');
            } finally {
                hideLoading();
            }
        }

        document.getElementById('force-password-change-form').addEventListener('submit', handlePasswordChange);
        googleSignInBtn?.addEventListener('click', handleGoogleSignIn);
        
        document.getElementById('show-register-btn').addEventListener('click', (e) => { e.preventDefault(); loginContainer.classList.add('hidden'); registerContainer.classList.remove('hidden'); });
        document.getElementById('show-login-btn').addEventListener('click', (e) => { e.preventDefault(); registerContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('login-error').textContent = '';
            showLoading();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
            }
            catch(error) {
                 document.getElementById('login-error').textContent = 'E-mail ou senha inválidos.';
                 hideLoading();
            }
        });

        document.getElementById('register-form').addEventListener('submit', async(e) => {
            e.preventDefault();
            const errorEl = document.getElementById('register-error');
            errorEl.textContent = '';
            showLoading();

            const accountType = document.querySelector('input[name="accountType"]:checked').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            let clinicData = { accountType, ownerEmail: email };
            let clinicNameForDisplay;

            if (accountType === 'pf') {
                clinicNameForDisplay = document.getElementById('pf-name').value;
                clinicData = {
                    ...clinicData,
                    name: clinicNameForDisplay,
                    birthDate: document.getElementById('pf-birthDate').value,
                    rg: document.getElementById('pf-rg').value,
                    cpf: document.getElementById('pf-cpf').value.replace(/\D/g,''),
                    crefito: document.getElementById('pf-crefito').value,
                    cep: document.getElementById('pf-cep').value,
                    street: document.getElementById('pf-street').value,
                    number: document.getElementById('pf-number').value,
                    neighborhood: document.getElementById('pf-neighborhood').value,
                    city: document.getElementById('pf-city').value,
                    state: document.getElementById('pf-state').value,
                    phone: document.getElementById('pf-phone').value.replace(/\D/g,''),
                };
                 clinicData.address = constructPatientAddress(clinicData);
            } else { // pj
                clinicNameForDisplay = document.getElementById('pj-razaoSocial').value;
                clinicData = {
                    ...clinicData,
                    name: clinicNameForDisplay,
                    cnpj: document.getElementById('pj-cnpj').value.replace(/\D/g,''),
                    crefito: document.getElementById('pj-crefito').value,
                    cep: document.getElementById('pj-cep').value,
                    street: document.getElementById('pj-street').value,
                    number: document.getElementById('pj-number').value,
                    neighborhood: document.getElementById('pj-neighborhood').value,
                    city: document.getElementById('pj-city').value,
                    state: document.getElementById('pj-state').value,
                    phone: document.getElementById('pj-phone').value.replace(/\D/g,''),
                    responsavelNome: document.getElementById('pj-responsavel').value,
                    responsavelCpf: document.getElementById('pj-responsavel-cpf').value.replace(/\D/g,''),
                    responsavelCrefito: document.getElementById('pj-responsavel-crefito').value,
                };
                clinicData.address = constructPatientAddress(clinicData);
            }

            if (!clinicNameForDisplay) {
                errorEl.textContent = 'O nome (PF) ou Razão Social (PJ) é obrigatório.';
                 hideLoading();
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                clinicData = {
                    ...clinicData,
                    ownerId: user.uid,
                    status: 'active',
                    createdAt: serverTimestamp()
                };

                const clinicDocRef = await addDoc(collection(db, 'clinics'), clinicData);

                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    email: user.email,
                    clinicId: clinicDocRef.id,
                    role: 'admin',
                    name: accountType === 'pf' ? clinicData.name : clinicData.responsavelNome,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Erro no cadastro:", error);
                if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = 'Este e-mail já está em uso. Tente outro.';
                } else if (error.code === 'auth/weak-password'){
                     errorEl.textContent = 'Senha muito fraca. Use pelo menos 8 caracteres.';
                } else {
                    errorEl.textContent = 'Erro ao criar conta. Tente novamente.';
                }
                 hideLoading();
            }
        });


        document.getElementById('logout-btn').addEventListener('click', () => {
             showLoading();
             signOut(auth).catch(error => {
                 console.error("Logout error:", error);
                 hideLoading();
             });
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;

                const loadUserProfileAndDashboard = async (retriesLeft = 20) => {
                    try {
                        const userDocRef = doc(db, 'users', user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists() && userDocSnap.data()?.clinicId) {
                            const userData = userDocSnap.data();
                            const clinicDocRef = doc(db, 'clinics', userData.clinicId);
                            const clinicDocSnap = await getDoc(clinicDocRef);

                            if (!clinicDocSnap.exists()) {
                                console.error("ERRO CRÍTICO: O clinicId do usuário aponta para uma clínica que não existe.");
                                hideLoading();
                                showJsMessage('Erro de Configuração', `Sua conta está associada a uma clínica (ID: ${userData.clinicId}) que não foi encontrada. Por favor, contate o suporte.`, true);
                                return;
                            }

                            const clinicData = clinicDocSnap.data();

                            if (clinicData.status === 'inactive') {
                                console.error("Acesso bloqueado: Clínica inativa.");
                                hideLoading();
                                showJsMessage('Acesso Bloqueado', 'A sua clínica está atualmente inativa. Por favor, contate o administrador.', true);
                                return;
                            }
                            
                            if (userData.mustChangePassword) {
                                authView.classList.add('hidden');
                                dashboardView.classList.add('hidden');
                                hideLoading();
                                document.getElementById('force-password-change-form').reset();
                                document.getElementById('password-modal-title').textContent = 'Alterar Senha Temporária';
                                document.getElementById('password-modal-description').textContent = 'Sua senha temporária expirou. Defina uma nova senha.';
                                openModal(forcePasswordChangeModal);
                                return;
                            }

                            currentUserClinicId = userData.clinicId;
                            currentUserRole = userData.role;
                            currentUserName = userData.name || user.email;
                            clinicPreferences = clinicData.preferences || { defaultAgendaView: 'monthly', defaultServiceType: 'local' };

                            document.getElementById('user-email').textContent = user.email;
                            document.getElementById('clinic-name-sidebar').textContent = clinicData.name;

                            await Promise.allSettled([
                                 fetchAndRenderMembers(),
                                 fetchAndRenderRooms(),
                                 fetchAndRenderPatients()
                             ]);
                            
                            authView.classList.add('hidden');
                            dashboardView.classList.remove('hidden');
                            switchView('inicio');
                            
                        } else {
                            if (retriesLeft > 0) {
                                await new Promise(resolve => setTimeout(resolve, 500));
                                loadUserProfileAndDashboard(retriesLeft - 1);
                            } else {
                                console.error("ERRO CRÍTICO: Perfil não encontrado após todas as tentativas.");
                                hideLoading();
                                showJsMessage('Falha ao Carregar', 'Seu usuário está autenticado, mas não foi possível carregar os dados do seu perfil. Se você acabou de se cadastrar, aguarde e recarregue. Se o erro persistir, contate o suporte.', true);
                            }
                        }
                    } catch (error) {
                        console.error("ERRO FATAL ao carregar perfil (Rede ou Permissões):", error);
                        hideLoading();
                        showJsMessage('Erro de Conexão', 'Ocorreu um erro ao buscar seus dados. Verifique sua conexão e tente novamente.', true);
                    }
                };

                loadUserProfileAndDashboard();

            } else {
                hideLoading();
                currentUserClinicId = null;
                currentUserRole = null;
                currentUserId = null;
                if (patientsUnsubscribe) { patientsUnsubscribe(); patientsUnsubscribe = null; }
                if (assessmentsUnsubscribe) { assessmentsUnsubscribe(); assessmentsUnsubscribe = null; }
                
                dashboardView.classList.add('hidden');
                authView.classList.remove('hidden');
                loginContainer.classList.remove('hidden');
                registerContainer.classList.add('hidden');
                document.getElementById('login-error').textContent = '';
            }
        });


        // --- MODAL & TAB CONTROLS ---

        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const modalBackdrop = target.closest('.modal-backdrop');

            if (modalBackdrop) {
                let shouldClose = false;
                const closeButton = target.closest('.close-modal-btn');
                const cancelButton = target.closest('[id^="cancel-"][id$="-modal"]');
                
                if(target.id === 'recurrence-option-cancel') {
                    closeModal(recurrenceOptionsModal);
                    return;
                }

                if (closeButton || cancelButton || target === modalBackdrop) {
                    // Impede o fechamento de modais de alerta ao clicar no fundo
                    if(target === modalBackdrop && (modalBackdrop.id === 'recurrence-options-modal' || modalBackdrop.id === 'js-message-modal' || modalBackdrop.id === 'confirm-modal')) return;
                    shouldClose = true;
                }
                
                if (shouldClose) {
                    if (modalBackdrop.id === 'patient-record-modal' && assessmentsUnsubscribe) {
                        assessmentsUnsubscribe();
                        assessmentsUnsubscribe = null;
                        selectedPatientId = null; 
                    }
                    closeModal(modalBackdrop);
                }
            }
        });


        assessmentModal?.querySelector('.flex-wrap')?.addEventListener('click', (e) => {
            if(e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                assessmentModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                assessmentModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                assessmentModal.querySelector(`#${tabId}`)?.classList.remove('hidden');
            }
        });

        assessmentDetailModal?.querySelector('.flex-wrap')?.addEventListener('click', (e) => {
            if(e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                assessmentDetailModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                assessmentDetailModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                assessmentDetailModal.querySelector(`#${tabId}`)?.classList.remove('hidden');
            }
        });

        dischargeModal?.querySelector('.flex-wrap')?.addEventListener('click', (e) => {
            if(e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                dischargeModal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                dischargeModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                dischargeModal.querySelector(`#${tabId}`)?.classList.remove('hidden');
            }
        });

        document.body.addEventListener('change', (e) => {
            if (e.target.closest('#assessment-modal')) {
                if(e.target.id === 'dor-eva') {
                    document.getElementById('dor-local-container')?.classList.toggle('hidden', e.target.value == 0);
                }
                if(e.target.id === 'edema') {
                    document.getElementById('edema-local-container')?.classList.toggle('hidden', e.target.value === 'Não');
                }
            }
             if (e.target.id === 'recurrence-toggle') {
                document.getElementById('recurrence-container').classList.toggle('hidden', !e.target.checked);
            }

            if (e.target.matches('input[name="serviceType"]')) {
                toggleAppointmentFields(e.target.value);
            }
        });

        // Mobile Menu
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            mobileMenuOverlay.classList.remove('hidden');
        });
        mobileMenuOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            mobileMenuOverlay.classList.add('hidden');
        });

        // Toggle PF/PJ form in registration
        document.querySelectorAll('input[name="accountType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isPf = e.target.value === 'pf';
                document.getElementById('pf-fields').classList.toggle('hidden', !isPf);
                document.getElementById('pj-fields').classList.toggle('hidden', isPf);
            });
        });

        // --- CEP Address Autofill Listener ---
        document.body.addEventListener('blur', (e) => {
            const target = e.target;
            if (target.tagName === 'INPUT' && target.dataset.formPrefix && target.id.endsWith('-cep')) {
                fetchAddressFromCEP(target.value, target.dataset.formPrefix);
            }
        }, true);

        // --- INPUT MASKING ---
        function formatPhone(value) {
            if (!value) return "";
            value = value.replace(/\D/g,"");
            value = value.replace(/^(\d{2})(\d)/g,"($1) $2");
            value = value.replace(/(\d)(\d{4})$/,"$1-$2");
            return value;
        }

        function formatCPF(value) {
            if (!value) return "";
            value = value.replace(/\D/g,"");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            return value;
        }

        function formatCNPJ(value) {
            if (!value) return "";
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
            return value;
        }

        function formatName(value) {
            if (!value) return "";
            return value.toLowerCase().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
        }


        document.body.addEventListener('input', (e) => {
            const mask = e.target.dataset.mask;
            if (!mask) return;

            switch(mask) {
                case 'phone':
                    e.target.value = formatPhone(e.target.value);
                    break;
                case 'cpf':
                    e.target.value = formatCPF(e.target.value);
                    break;
                case 'cnpj':
                    e.target.value = formatCNPJ(e.target.value);
                    break;
                case 'name':
                    // Name formatting is now applied on blur to avoid interrupting typing
                    break;
            }
        });
        document.body.addEventListener('blur', (e) => {
            if (e.target.dataset.mask === 'name') {
                e.target.value = formatName(e.target.value);
            }
        }, true);

    </script>
</body>
</html>
